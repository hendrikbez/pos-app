<!DOCTYPE html>
<html lang="en-ZA">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sales & POS System</title>
     <!-- PWA Meta Tags -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2a7b9b">

<!-- iOS support -->
<link rel="apple-touch-icon" href="sale_192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
 <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: linear-gradient(
    90deg,
    rgba(42, 123, 155, 1) 0%,
    rgba(87, 199, 133, 1) 50%,
    rgba(237, 221, 83, 1) 100%
  );
  min-height: 100vh;
  padding: 8px;
  -webkit-tap-highlight-color: transparent;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding-bottom: 100px;
}
.header-bar {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 16px;
  gap: 10px;
  flex-wrap: wrap;
}
.app-logo {
  height: 48px;
  max-width: 160px;
  object-fit: contain;
}
.language-selector {
  display: flex;
  gap: 8px;
  align-items: center;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 8px 12px;
  border: 2px solid rgba(255, 255, 255, 0.3);
}
.lang-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
}
.lang-btn.active {
  background: #3b82f6;
  color: white;
}
.lang-btn.inactive {
  background: rgba(59, 130, 246, 0.1);
  color: #3b82f6;
  border: 1px solid rgba(59, 130, 246, 0.2);
}
.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  position: sticky;
  top: 8px;
  z-index: 100;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 4px;
  border: 2px solid rgba(255, 255, 255, 0.3);
}
.tab-btn {
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  font-size: 15px;
  transition: all 0.3s ease;
}
.tab-btn.active {
  background: #3b82f6;
  color: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
.tab-btn.inactive {
  background: rgba(59, 130, 246, 0.1);
  color: #3b82f6;
  border: 1px solid rgba(59, 130, 246, 0.2);
}
.tab-content {
  display: none;
  background: white;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  padding: 20px;
  margin-top: 8px;
}
.tab-content.active {
  display: block;
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.form-group {
  margin-bottom: 16px;
}
.form-row {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}
.form-row .form-group {
  flex: 1;
  margin-bottom: 0;
}
label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 8px;
  color: #374151;
}
input,
select {
  width: 100%;
  padding: 14px;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  font-size: 16px;
  transition: border-color 0.3s ease;
}
input:focus,
select:focus {
  outline: none;
  border-color: #3b82f6;
}
.button {
  padding: 16px;
  border: none;
  border-radius: 10px;
  font-weight: bold;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s ease;
}
.button.full-width {
  width: 100%;
}
.button:active {
  transform: scale(0.98);
}
.btn-green {
  background: #22c55e;
  color: white;
}
.btn-red {
  background: #ef4444;
  color: white;
  padding: 10px 14px;
  font-size: 13px;
}
.btn-blue {
  background: #3b82f6;
  color: white;
}
.btn-orange {
  background: #f59e0b;
  color: white;
}
.btn-purple {
  background: #8b5cf6;
  color: white;
}
.section-title {
  font-size: 18px;
  font-weight: bold;
  color: #3b82f6;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid #bfdbfe;
}
.section {
  background: #f0f9ff;
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 16px;
}
.items-list {
  max-height: 300px;
  overflow-y: auto;
  margin-bottom: 16px;
}
.editable-item {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 12px;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  margin-bottom: 10px;
}
.editable-row {
  display: flex;
  gap: 8px;
  align-items: center;
}
.editable-row input {
  padding: 8px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
}
.editable-row .item-total {
  flex: 1;
  text-align: right;
  font-weight: bold;
  color: #16a34a;
}
.card {
  background: white;
  border: 2px solid #bfdbfe;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
}
.card.yellow {
  border-color: #fcd34d;
  background: #fffbeb;
}
.card.purple {
  border-color: #d8b4fe;
  background: #f3e8ff;
}
.card.green {
  border-color: #4ade80;
  background: #f0fdf4;
}
.card-title {
  font-weight: bold;
  font-size: 16px;
  margin-bottom: 16px;
}
.card.yellow .card-title {
  color: #b45d04;
}
.card.purple .card-title {
  color: #6b21a8;
}
.card.green .card-title {
  color: #16a34a;
}
.amounts-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
  font-size: 14px;
}
.amount-box {
  background: white;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
}
.amount-label {
  color: #6b7280;
  font-size: 12px;
  margin-bottom: 6px;
}
.amount-value {
  font-weight: bold;
  font-size: 16px;
}
.amount-value.green {
  color: #16a34a;
}
.amount-value.blue {
  color: #2563eb;
}
.total-display {
  font-size: 20px;
  font-weight: bold;
  text-align: center;
  padding: 14px;
  background: white;
  border-radius: 8px;
  margin-top: 16px;
}
.card.yellow .total-display {
  color: #b45d04;
}
.card.purple .total-display {
  color: #6b21a8;
}
.card.green .total-display {
  color: #16a34a;
}
.trans-list {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px;
  background: #f9fafb;
}
.trans-item {
  font-size: 12px;
  background: white;
  padding: 12px;
  margin-bottom: 8px;
  border-radius: 6px;
  border-left: 2px solid #d1d5db;
}
.trans-time {
  font-weight: bold;
  margin-bottom: 4px;
}
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal.active {
  display: flex;
}
.modal-content {
  background: white;
  border-radius: 16px;
  padding: 20px;
  width: 100%;
  max-width: 400px;
  box-shadow: 0 20px 25px rgba(0, 0, 0, 0.3);
  max-height: 90vh;
  overflow-y: auto;
}
.modal-title {
  font-size: 18px;
  font-weight: bold;
  color: #3b82f6;
  margin-bottom: 20px;
}
.modal-buttons {
  display: flex;
  gap: 12px;
  margin-top: 20px;
}
.modal-buttons button {
  flex: 1;
  padding: 14px;
}
.quick-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 16px;
}
.quick-btn {
  padding: 12px;
  border: none;
  border-radius: 8px;
  background: #3b82f6;
  color: white;
  font-weight: bold;
  cursor: pointer;
}
.product-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}
.product-card {
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
}
.product-card.selected {
  border-color: #3b82f6;
  background: #f0f9ff;
  transform: scale(0.98);
}
.product-card:active {
  transform: scale(0.95);
  border-color: #3b82f6;
}
.product-name {
  font-weight: bold;
  margin-bottom: 8px;
  font-size: 14px;
}
.product-price {
  color: #16a34a;
  font-weight: bold;
  font-size: 16px;
}
.product-person {
  font-size: 12px;
  color: #6b7280;
  margin-top: 4px;
}
.product-code {
  font-size: 10px;
  color: #9ca3af;
  margin-top: 2px;
}
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
}
.stat-card {
  background: white;
  border-radius: 12px;
  padding: 16px;
  text-align: center;
}
.stat-value {
  font-size: 24px;
  font-weight: bold;
  color: #3b82f6;
  margin-bottom: 4px;
}
.stat-label {
  font-size: 12px;
  color: #6b7280;
}
.code-input-section {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
}
.code-input-row {
  display: flex;
  gap: 10px;
  align-items: center;
}
.code-input {
  flex: 1;
  font-size: 18px;
  padding: 16px;
  height: 60px;
}
.small-btn {
  padding: 12px 16px;
  height: 60px;
  font-size: 14px;
  white-space: nowrap;
}
.product-info-display {
  background: #dcfce7;
  border: 2px solid #22c55e;
  border-radius: 10px;
  padding: 12px;
  margin-top: 12px;
  display: none;
}
.product-info-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 14px;
}
.product-info-label {
  font-weight: bold;
  color: #374151;
}
.product-info-value {
  color: #16a34a;
  font-weight: bold;
}
.quantity-controls {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}
.quantity-btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  background: #3b82f6;
  color: white;
  font-weight: bold;
  cursor: pointer;
}
.quantity-display {
  flex: 1;
  text-align: center;
  padding: 10px;
  background: #f3f4f6;
  border-radius: 8px;
  font-weight: bold;
}
.transaction-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid #e5e7eb;
}
.transaction-name {
  font-size: 1.4rem;
  font-weight: 700;
  color: #2c3e50;
}
.transaction-number {
  font-weight: 700;
  color: #e74c3c;
  background: #f9ebea;
  padding: 5px 10px;
  border-radius: 5px;
}
.import-export-section {
  background: #f0f9ff;
  border: 2px dashed #3b82f6;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  text-align: center;
}
.file-input {
  display: none;
}
.file-label {
  display: inline-block;
  padding: 12px 24px;
  background: #3b82f6;
  color: white;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  margin: 10px 0;
}
.import-export-buttons {
  display: flex;
  gap: 12px;
  margin-top: 16px;
}
.import-export-buttons button {
  flex: 1;
}
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #6b7280;
}
.empty-state h3 {
  margin-bottom: 10px;
  color: #374151;
}
.share-section {
  margin-top: 20px;
  padding: 15px;
  background: #f0fdf4;
  border: 2px solid #22c55e;
  border-radius: 10px;
  text-align: center;
}
.share-buttons {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}
.share-buttons button {
  flex: 1;
}
.products-management {
  margin-top: 20px;
}
.search-box {
  margin-bottom: 16px;
}
.search-box input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 16px;
}
.products-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 16px;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}
.products-table th {
  background: #3b82f6;
  color: white;
  padding: 12px;
  text-align: left;
  font-size: 14px;
}
.products-table td {
  padding: 12px;
  border-bottom: 1px solid #e5e7eb;
  font-size: 14px;
}
.products-table tr:last-child td {
  border-bottom: none;
}
.products-table tr:hover {
  background: #f3f4f6;
}
.action-buttons {
  display: flex;
  gap: 8px;
}
.action-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  font-weight: bold;
}
.edit-btn {
  background: #f59e0b;
  color: white;
}
.delete-btn {
  background: #ef4444;
  color: white;
}
.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  margin-top: 16px;
}
.page-btn {
  padding: 8px 16px;
  border: 1px solid #3b82f6;
  background: white;
  color: #3b82f6;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}
.page-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.page-info {
  font-size: 14px;
  color: #6b7280;
}
.download-section {
  background: #f0fdf4;
  border: 2px solid #22c55e;
  border-radius: 10px;
  padding: 16px;
  margin-top: 20px;
  text-align: center;
}
.download-buttons {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}
.download-buttons button {
  flex: 1;
}
.categories-section {
  background: #f0f9ff;
  border: 2px solid #3b82f6;
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 20px;
}
.categories-grid {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 10px;
  margin-bottom: 12px;
}
.filter-controls {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.filter-select {
  flex: 1;
  min-width: 150px;
}
.category-badge {
  background: #e5e7eb;
  color: #374151;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: bold;
}
.autocomplete {
  position: relative;
  display: inline-block;
  width: 100%;
}
.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-bottom: none;
  border-top: none;
  z-index: 99;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
  background: white;
  border-radius: 0 0 10px 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}
.autocomplete-items div {
  padding: 12px;
  cursor: pointer;
  background-color: white;
  border-bottom: 1px solid #d4d4d4;
}
.autocomplete-items div:hover {
  background-color: #e9e9e9;
}
.owner-selection-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.owner-selection-modal.active {
  display: flex;
}
.owner-selection-content {
  background: white;
  border-radius: 16px;
  padding: 20px;
  width: 100%;
  max-width: 300px;
  box-shadow: 0 20px 25px rgba(0, 0, 0, 0.3);
  text-align: center;
}
.owner-buttons {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin: 20px 0;
}
.owner-btn {
  padding: 16px;
  border: none;
  border-radius: 10px;
  font-weight: bold;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s ease;
}
.owner-btn:active {
  transform: scale(0.98);
}
.owner-btn.Kotie {
  background: #3b82f6;
  color: white;
}
.owner-btn.francois {
  background: #8b5cf6;
  color: white;
}
.cash-amount-section {
  margin-bottom: 16px;
}
.cash-amount-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 8px;
  color: #374151;
}
.cash-amount-row {
  display: flex;
  gap: 8px;
}
.cash-amount-select {
  flex: 1;
}
.cash-amount-input {
  flex: 2;
}
.quantity-toggle-section {
  background: #f0f9ff;
  border: 2px solid #3b82f6;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
}
.toggle-switch {
  display: flex;
  gap: 10px;
  margin-bottom: 12px;
}
.toggle-btn {
  flex: 1;
  padding: 12px;
  border: 2px solid #3b82f6;
  background: white;
  color: #3b82f6;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}
.toggle-btn.active {
  background: #3b82f6;
  color: white;
}
.stock-display {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  border-radius: 8px;
  padding: 12px;
  margin-top: 10px;
  display: none;
}
.stock-warning {
  color: #dc2626;
  font-weight: bold;
  background: #fee2e2;
  padding: 8px 12px;
  border-radius: 6px;
  margin-top: 8px;
  display: none;
}
.quantity-field {
  display: none;
}
.sales-search-section {
  margin-bottom: 16px;
}
.sales-search-box {
  position: relative;
}
.sales-search-box input {
  width: 100%;
  padding: 12px 40px 12px 12px;
}
.sales-search-icon {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #6b7280;
}
.sales-pagination {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 16px;
}
.sales-page-info {
  font-size: 14px;
  color: #6b7280;
}
.manual-input-section {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid #e5e7eb;
}
.danger-zone {
    border: 2px solid #ef4444;
    background: #fef2f2;
    padding: 15px;
    border-radius: 10px;
    margin-top: 30px;
}
.danger-title {
    color: #b91c1c;
    font-weight: bold;
    margin-bottom: 10px;
    text-transform: uppercase;
    font-size: 12px;
}
.history-section {
    background: #e0f2fe;
    border: 2px solid #3b82f6;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}

/* Float Management Styles */
.float-management-section {
    background: #fff7ed;
    border: 2px solid #f97316;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}
.float-summary {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid #e5e7eb;
}
.float-amount {
    font-size: 24px;
    font-weight: bold;
    color: #ea580c;
    text-align: center;
    margin: 10px 0;
}
.float-breakdown {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 15px;
}
.float-denomination {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 10px;
    text-align: center;
}
.denom-value {
    font-weight: bold;
    color: #374151;
}
.denom-count {
    font-size: 18px;
    font-weight: bold;
    color: #16a34a;
    margin-top: 5px;
}
.denom-total {
    font-size: 12px;
    color: #6b7280;
    margin-top: 3px;
}
.cash-reconciliation-section {
    background: #f0fdf4;
    border: 2px solid #22c55e;
    border-radius: 10px;
    padding: 15px;
    margin-top: 20px;
}
.reconciliation-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
    margin: 15px 0;
}
.reconciliation-item {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 10px;
    text-align: center;
}
.reconciliation-label {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 5px;
}
.reconciliation-value {
    font-weight: bold;
    font-size: 16px;
}
.bank-amount {
    color: #2563eb;
}
.float-remain {
    color: #ea580c;
}
.cash-to-bank {
    color: #16a34a;
    font-size: 20px;
    text-align: center;
    margin: 15px 0;
}
.denomination-inputs {
    background: #f9fafb;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}
.denom-input-row {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
}
.denom-label {
    flex: 1;
    font-weight: bold;
    color: #374151;
}
.denom-input {
    width: 80px;
    text-align: center;
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
}
.denom-subtotal {
    width: 100px;
    text-align: right;
    font-weight: bold;
    color: #16a34a;
}

/* Help Modal Styling */
.help-section {
    background: #f9fafb;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid #e5e7eb;
}
.help-section h3 {
    color: #3b82f6;
    margin-bottom: 10px;
    border-bottom: 2px solid #bfdbfe;
    padding-bottom: 5px;
    font-size: 16px;
}
.help-step {
    background: white;
    padding: 10px;
    margin-bottom: 8px;
    border-left: 4px solid #16a34a;
    font-size: 14px;
    color: #374151;
}
.help-step strong {
    color: #166534;
}
.help-step:last-child {
    margin-bottom: 0;
}
.help-icon {
    font-size: 20px;
    margin-right: 5px;
    vertical-align: middle;
}
.important-note {
    background: #fffbeb;
    border: 1px solid #fcd34d;
    color: #b45d04;
    padding: 10px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: bold;
    text-align: center;
    margin-top: 10px;
}

@media (max-width: 768px) {
  .container {
    padding-bottom: 80px;
  }
  .tab-btn {
    padding: 12px;
    font-size: 14px;
  }
  .product-grid {
    grid-template-columns: 1fr 1fr;
  }
  .quick-actions {
    grid-template-columns: 1fr;
  }
  .code-input-row {
    flex-direction: column;
  }
  .code-input {
    height: 50px;
  }
  .small-btn {
    height: 50px;
  }
  .editable-row {
    align-items: stretch;
  }
  .editable-row input,
  .editable-row select {
    width: 100%;
    max-width: none;
  }
  .form-row {
    flex-direction: column;
    gap: 16px;
  }
  .import-export-buttons,
  .share-buttons,
  .categories-grid,
  .filter-controls,
  .cash-amount-row,
  .toggle-switch,
  .sales-pagination {
    flex-direction: column;
  }
  .float-breakdown,
  .reconciliation-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}
@media (min-width: 700px) {
  .container {
    max-width: 700px;
  }
  .tab-content {
    padding: 30px;
  }
  .product-grid {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  }
  .section-title {
    font-size: 20px;
  }
  .card-title {
    font-size: 18px;
  }
  .button {
    font-size: 18px;
    padding: 18px;
  }
  input,
  select {
    font-size: 18px;
    padding: 16px;
  }
  .total-display {
    font-size: 24px;
  }
}

/* ============= Funky Button System (Overrides) ============= */

/* Core base for all buttons */
.button,
.quick-btn,
.tab-btn,
.lang-btn,
.page-btn,
.action-btn,
.owner-btn,
.quantity-btn,
.btn-red,
.btn-blue,
.btn-green,
.btn-orange,
.btn-purple {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;

  padding: 0.9em 1.15em;
  border-radius: 12px;
  border: 0;
  font-weight: 700;
  letter-spacing: 0.3px;
  line-height: 1;
  cursor: pointer;
  user-select: none;

  background: linear-gradient(135deg, #ffffff 0%, #f7f8ff 100%);
  color: #0f172a;
  box-shadow:
    0 8px 18px rgba(15, 23, 42, 0.15),
    inset 0 0 0 2px rgba(255,255,255,0.65);
  transition: transform 0.14s ease, box-shadow 0.22s ease, filter 0.22s ease, background 0.3s ease;

  -webkit-tap-highlight-color: transparent;
}

/* Hover lift */
.button:hover,
.quick-btn:hover,
.tab-btn:hover,
.lang-btn:hover,
.page-btn:hover,
.action-btn:hover,
.owner-btn:hover,
.quantity-btn:hover,
.btn-red:hover,
.btn-blue:hover,
.btn-green:hover,
.btn-orange:hover,
.btn-purple:hover {
  transform: translateY(-1px);
  box-shadow:
    0 12px 26px rgba(15, 23, 42, 0.18),
    inset 0 0 0 2px rgba(255,255,255,0.75);
  filter: saturate(1.08);
}

/* Pressed */
.button:active,
.quick-btn:active,
.tab-btn:active,
.lang-btn:active,
.page-btn:active,
.action-btn:active,
.owner-btn:active,
.quantity-btn:active,
.btn-red:active,
.btn-blue:active,
.btn-green:active,
.btn-orange:active,
.btn-purple:active {
  transform: translateY(1px) scale(0.99);
  box-shadow:
    0 6px 14px rgba(15, 23, 42, 0.16),
    inset 0 0 0 2px rgba(255,255,255,0.6);
}

/* Disabled */
.button:disabled,
.page-btn:disabled {
  opacity: 0.6 !important;
  cursor: not-allowed !important;
  filter: grayscale(20%) !important;
  transform: none !important;
}

/* Glow halo */
.button::after,
.quick-btn::after,
.tab-btn::after,
.lang-btn::after,
.page-btn::after,
.action-btn::after,
.owner-btn::after,
.quantity-btn::after,
.btn-red::after,
.btn-blue::after,
.btn-green::after,
.btn-orange::after,
.btn-purple::after {
  content: "";
  position: absolute;
  inset: -2px;
  border-radius: inherit;
  background: radial-gradient(60% 60% at 50% 50%, rgba(255,255,255,0.18), transparent 60%);
  opacity: 0;
  transition: opacity 0.2s ease;
  pointer-events: none;
}

.button:hover::after,
.quick-btn:hover::after,
.tab-btn:hover::after,
.lang-btn:hover::after,
.page-btn:hover::after,
.action-btn:hover::after,
.owner-btn:hover::after,
.quantity-btn:hover::after,
.btn-red:hover::after,
.btn-blue:hover::after,
.btn-green:hover::after,
.btn-orange:hover::after,
.btn-purple:hover::after {
  opacity: 1;
}

/* Sparkle */
.button::before,
.quick-btn::before,
.tab-btn::before,
.lang-btn::before,
.page-btn::before,
.action-btn::before,
.owner-btn::before,
.quantity-btn::before,
.btn-red::before,
.btn-blue::before,
.btn-green::before,
.btn-orange::before,
.btn-purple::before {
  content: "";
  position: absolute;
  width: 8px;
  height: 8px;
  top: 10%;
  right: 14%;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #ffffff, rgba(255,255,255,0.2) 60%, transparent 70%);
  opacity: 0;
  transform: scale(0.6);
  transition: opacity 0.25s ease, transform 0.25s ease;
  pointer-events: none;
}
.button:hover::before,
.quick-btn:hover::before,
.tab-btn:hover::before,
.lang-btn:hover::before,
.page-btn:hover::before,
.action-btn:hover::before,
.owner-btn:hover::before,
.quantity-btn:hover::before,
.btn-red:hover::before,
.btn-blue:hover::before,
.btn-green:hover::before,
.btn-orange:hover::before,
.btn-purple:hover::before {
  opacity: 0.9;
  transform: scale(1);
}

/* Themed variants */

/* Blue (primary) */
.btn-blue,
.tab-btn.active,
.lang-btn.active,
.quick-btn {
  color: #ffffff !important;
  background: linear-gradient(135deg, #2f7cf7 0%, #2563eb 100%) !important;
  box-shadow:
    0 12px 26px rgba(37, 99, 235, 0.35),
    inset 0 0 0 2px rgba(255,255,255,0.24) !important;
}

/* Inactive tab/lang */
.tab-btn.inactive,
.lang-btn.inactive {
  color: #2563eb !important;
  background: linear-gradient(135deg, rgba(37,99,235,0.10) 0%, rgba(37,99,235,0.18) 100%) !important;
  box-shadow:
    0 6px 14px rgba(37, 99, 235, 0.18),
    inset 0 0 0 2px rgba(37,99,235,0.18) !important;
}

/* Green (confirm) */
.btn-green {
  color: #ffffff !important;
  background: linear-gradient(135deg, #19c965 0%, #16a34a 100%) !important;
  box-shadow:
    0 12px 26px rgba(34, 197, 94, 0.35),
    inset 0 0 0 2px rgba(255,255,255,0.24) !important;
}

/* Orange (warn) */
.btn-orange,
.edit-btn {
  color: #ffffff !important;
  background: linear-gradient(135deg, #f9a74b 0%, #f59e0b 100%) !important;
  box-shadow:
    0 12px 26px rgba(245, 158, 11, 0.35),
    inset 0 0 0 2px rgba(255,255,255,0.24) !important;
}

/* Purple (alt) */
.btn-purple,
.owner-btn.francois {
  color: #ffffff !important;
  background: linear-gradient(135deg, #9c6bff 0%, #7c3aed 100%) !important;
  box-shadow:
    0 12px 26px rgba(124, 58, 237, 0.35),
    inset 0 0 0 2px rgba(255,255,255,0.24) !important;
}

/* Red (danger) */
.btn-red,
.delete-btn {
  color: #ffffff !important;
  background: linear-gradient(135deg, #ff6b6b 0%, #ef4444 100%) !important;
  box-shadow:
    0 12px 26px rgba(239, 68, 68, 0.35),
    inset 0 0 0 2px rgba(255,255,255,0.24) !important;
}

/* Pagination */
.page-btn {
  color: #2563eb !important;
  background: linear-gradient(135deg, rgba(37,99,235,0.08) 0%, rgba(37,99,235,0.16) 100%) !important;
  box-shadow:
    0 6px 14px rgba(37, 99, 235, 0.16),
    inset 0 0 0 2px rgba(37,99,235,0.16) !important;
}

/* Small formats */
.action-btn,
.quantity-btn,
.small-btn {
  padding: 0.65em 0.9em;
  border-radius: 10px;
  font-size: 12.5px;
}

/* Owner (Kotie blue, Francois purple already set) */
.owner-btn.Kotie {
  color: #ffffff !important;
  background: linear-gradient(135deg, #2f7cf7 0%, #2563eb 100%) !important;
  box-shadow:
    0 12px 26px rgba(37, 99, 235, 0.35),
    inset 0 0 0 2px rgba(255,255,255,0.24) !important;
}

/* Quantity buttons emphasis */
.quantity-btn {
  font-weight: 900;
}

/* Full width stays full width */
.button.full-width {
  width: 100%;
}

/* Mobile tuning */
@media (max-width: 768px) {
  .button,
  .quick-btn,
  .tab-btn,
  .lang-btn,
  .page-btn,
  .action-btn,
  .owner-btn,
  .quantity-btn {
    padding: 0.85em 1em;
    border-radius: 12px;
    font-size: 15px;
  }
  .action-btn,
  .quantity-btn,
  .small-btn {
    font-size: 13px;
  }
}

/* Focus-visible fun */
.button:focus-visible,
.quick-btn:focus-visible,
.tab-btn:focus-visible,
.lang-btn:focus-visible,
.page-btn:focus-visible,
.action-btn:focus-visible,
.owner-btn:focus-visible,
.quantity-btn:focus-visible {
  outline: none;
  box-shadow:
    0 0 0 3px rgba(99, 102, 241, 0.35),
    0 10px 22px rgba(15, 23, 42, 0.18),
    inset 0 0 0 2px rgba(255,255,255,0.7);
  animation: funky-focus 420ms ease;
}

@keyframes funky-focus {
  0% { transform: translateY(0) rotate(0); }
  40% { transform: translateY(-1px) rotate(-0.4deg); }
  100% { transform: translateY(0) rotate(0); }
}
</style>

 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
	 
</head>
<body>
       <div class="container">
		<div class="header-bar">
			<div class="language-selector">
				<button class="lang-btn active" onclick="setLanguage('en')">English</button>
				<button class="lang-btn inactive" onclick="setLanguage('af')">Afrikaans</button>
			</div>
		  
            <button class="button btn-green" onclick="openQuickInfoModal()">‚ûï Quick Add</button>
	      <button class="button btn-purple" onclick="openScannerHelp()">Scanner Info ‚ÑπÔ∏è</button>
        </div>
        <div class="tabs">
          <button class="tab-btn active" data-tab="sales" data-translate="sales">Sales</button>
          <button class="tab-btn inactive" data-tab="products" data-translate="products">Products</button>
          <button class="tab-btn inactive" data-tab="report" data-translate="report">Report</button>
          <button class="tab-btn inactive" data-tab="float" data-translate="float">Float</button>
        </div>
        <div id="sales" class="tab-content active">
          <div class="transaction-header">
            <div>
              <span class="transaction-name" data-translate="sales">Sales</span>
              <div style="font-size: 0.9rem; color: #7f8c8d; margin-top: 5px;" data-translate="transaction">Transaction: <span id="currentTransactionNumber">000001</span>
              </div>
            </div>
            <button class="button btn-blue" onclick="startNewTransaction()" data-translate="newTransaction">New Transaction</button>
          </div>
          <div class="form-group">
            <label data-translate="name">Name:</label>
            <select id="name" onchange="updateProductList()">
              <option value="" data-translate="selectName">Select Name</option>
              <option>Kotie</option>
              <option>Francois</option>
              <option value="Both" data-translate="both">Both</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label data-translate="date">Date:</label>
              <input type="date" id="date">
            </div>
            <div class="form-group">
              <label data-translate="time">Time:</label>
              <input type="time" id="time">
            </div>
          </div>
          <div class="quick-actions">
            <button class="quick-btn" onclick="setToday()" data-translate="today">Today</button>
            <button class="quick-btn" onclick="setNow()" data-translate="now">Now</button>
          </div>
          <div class="quantity-toggle-section">
            <div class="section-title" style="font-size: 16px; color: #3B82F6;" data-translate="quantityManagement">Quantity Management</div>
            <div class="toggle-switch">
              <button class="toggle-btn active" id="toggleNoQuantity" onclick="toggleQuantityMode('none')" data-translate="noQuantity">No Quantity</button>
              <button class="toggle-btn inactive" id="toggleWithQuantity" onclick="toggleQuantityMode('with')" data-translate="withQuantity">With Quantity</button>
            </div>
            <div id="quantityFields" class="quantity-field">
              <div class="form-row">
                <div class="form-group">
                  <label data-translate="availableQuantity">Available Quantity:</label>
                  <input type="number" id="availableQuantity" placeholder="0" min="0">
                </div>
                <div class="form-group">
                  <label data-translate="saleQuantity">Sale Quantity:</label>
                  <input type="number" id="sellQuantity" placeholder="1" min="1" value="1">
                </div>
              </div>
            </div>
            <div id="stockDisplay" class="stock-display">
              <div class="product-info-row">
                <span class="product-info-label" data-translate="availableStock">Available Stock:</span>
                <span class="product-info-value" id="stockQuantity">0</span>
              </div>
            </div>
            <div id="stockWarning" class="stock-warning">
              <span data-translate="noItemAvailable">No "</span>
              <span id="outOfStockItem">item</span>
              <span data-translate="noItemAvailableEnd">" Available</span>
            </div>
          </div>
          <div class="code-input-section">
            <div class="section-title" style="font-size: 16px; color: #B45D04;" data-translate="productCode">Product Code</div>
            <div class="code-input-row">
              <input type="text" id="productCode" placeholder="Enter product code" class="code-input" onkeypress="handleCodeEnter(event)" data-translate-placeholder="enterProductCode">
              <button class="button btn-orange small-btn" onclick="lookupProduct()" data-translate="findProduct">Find Product</button>
            </div>
            <div id="productInfo" class="product-info-display">
              <div class="product-info-row">
                <span class="product-info-label" data-translate="product">Product:</span>
                <span class="product-info-value" id="infoName">-</span>
              </div>
              <div class="product-info-row">
                <span class="product-info-label" data-translate="price">Price:</span>
                <span class="product-info-value" id="infoPrice">R0.00</span>
              </div>
              <div class="product-info-row">
                <span class="product-info-label" data-translate="owner">Owner:</span>
                <span class="product-info-value" id="infoOwner">-</span>
              </div>
              <div class="product-info-row">
                <span class="product-info-label" data-translate="category">Category:</span>
                <span class="product-info-value" id="infoCategory">-</span>
              </div>
              <div class="quantity-controls">
                <button class="quantity-btn" onclick="adjustQuantity(-1)">-</button>
                <div class="quantity-display" id="quantityDisplay">1</div>
                <button class="quantity-btn" onclick="adjustQuantity(1)">+</button>
              </div>
              <button class="button btn-green full-width" onclick="addProductFromCode()" style="margin-top: 12px;" data-translate="addProduct">Add Product</button>
            </div>
          </div>
          <div class="section">
            <div class="section-title" style="font-size: 16px; color: #3B82F6;" data-translate="productSelection">Product Selection</div>
            <div class="sales-search-section">
              <div class="sales-search-box">
                <input type="text" id="salesSearch" placeholder="Search products..." oninput="filterSalesProducts()" data-translate-placeholder="searchProducts">
                <div class="sales-search-icon">üîç</div>
              </div>
            </div>
            <div id="productList" class="product-grid"></div>
            <div class="sales-pagination">
              <button class="button btn-blue" onclick="changeSalesPage(-1)" id="salesPrevBtn" data-translate="previous">Previous</button>
              <div class="sales-page-info" id="salesPageInfo">Page 1 of 1</div>
              <button class="button btn-blue" onclick="changeSalesPage(1)" id="salesNextBtn" data-translate="next">Next</button>
            </div>
            <div class="manual-input-section">
              <div class="section-title" style="font-size: 16px; color: #3B82F6;" data-translate="manualAddition">Manual Addition</div>
              <button class="button btn-green full-width" onclick="openManualInputModal()" data-translate="manualInput">Manual Input</button>
            </div>
          </div>
          <div id="itemsContainer" style="display:none; margin-top: 20px;">
            <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
              <span data-translate="items" style="color: #374151;">Selected Products</span>
              <span id="itemCount" style="background: #3B82F6; color: white; padding: 2px 10px; border-radius: 12px; font-size: 14px;">0</span>
            </div>
            <div class="items-list" id="itemsList"></div>
          </div>
          <div id="paymentSection" style="display:none;">
            <div class="card green">
              <div style="font-size: 14px; color: #6B7280;" data-translate="total">TOTAL:</div>
              <div style="font-size: 28px; font-weight: bold; color: #16A34A;">R <span id="totalDisplay">0.00</span>
              </div>
            </div>
            <button class="button btn-green full-width" onclick="openPaymentModal()" data-translate="choosePaymentMethod">Choose Payment Method</button>
          </div>
        </div>
        <div id="products" class="tab-content">
          <div class="section-title" data-translate="productManagement">Product Management</div>
          <div class="categories-section">
            <div class="section-title" style="font-size: 16px; color: #3B82F6;" data-translate="categoryManagement">Category Management</div>
			
<div class="categories-grid">
    <div class="autocomplete">
        <input type="text" id="newCategory" placeholder="Type to see categories or add new one" class="code-input" oninput="showCategorySuggestions()" data-translate-placeholder="typeCategories">
        <div id="categoryAutocompleteList" class="autocomplete-items"></div>
    </div>
    <button class="button btn-blue" onclick="addCategory()" data-translate="addCategory">Add Category</button>
</div>
			
          </div>
          <div class="section">
            <div class="section-title" style="font-size: 16px; color: #3B82F6;" id="formTitle" data-translate="newProduct">New Product</div>
            <select id="newProductOwner" style="margin-bottom: 10px;">
              <option value="" data-translate="selectOwner">Select Owner</option>
              <option>Kotie</option>
              <option>Francois</option>
              <option value="Both" data-translate="both">Both</option>
            </select>
			
 <div class="autocomplete" style="margin-bottom: 10px;">
    <input type="text" id="newProductCategory" placeholder="Select Category" oninput="showProductCategoryDropdown()" data-translate-placeholder="selectCategory">
    <div id="productCategoryAutocompleteList" class="autocomplete-items"></div>
</div>
			
            <input type="text" id="newProductName" placeholder="Product name" style="margin-bottom: 10px;" data-translate-placeholder="productName">
            <input type="number" id="newProductPrice" placeholder="Price (R)" style="margin-bottom: 10px;" data-translate-placeholder="price">
            <input type="text" id="newProductCode" placeholder="Product code (optional)" style="margin-bottom: 10px;" data-translate-placeholder="productCodeOptional">
            <input type="number" id="newProductQuantity" placeholder="Starting Stock (leave empty for unlimited)" style="margin-bottom: 10px;" data-translate-placeholder="startingStock">
            <button class="button btn-green full-width" onclick="saveProduct()" id="saveProductBtn" data-translate="saveProduct">Save Product</button>
            <button class="button btn-blue full-width" onclick="cancelEdit()" id="cancelEditBtn" style="display: none; margin-top: 10px;" data-translate="cancel">Cancel</button>
          </div>
          <div class="products-management">
            <div class="filter-controls">
              <div class="form-group" style="flex: 2;">
                <input type="text" id="searchProducts" placeholder="Search product name or code..." oninput="filterProducts()" data-translate-placeholder="searchProducts">
              </div>
              <div class="form-group filter-select">
                <select id="filterCategory" onchange="filterProducts()">
                  <option value="" data-translate="allCategories">All Categories</option>
                </select>
              </div>
              <div class="form-group filter-select">
                <select id="filterOwner" onchange="filterProducts()">
                  <option value="" data-translate="allOwners">All Owners</option>
                  <option>Kotie</option>
                  <option>Francois</option>
                  <option value="Both" data-translate="both">Both</option>
                </select>
              </div>
            </div>
            <div style="overflow-x: auto;">
              <table class="products-table">
                <thead>
                  <tr>
                    <th data-translate="code">Code</th>
                    <th data-translate="name">Name</th>
                    <th data-translate="price">Price</th>
                    <th data-translate="owner">Owner</th>
                    <th data-translate="category">Category</th>
                    <th data-translate="stock">Stock</th>
                    <th data-translate="actions">Actions</th>
                  </tr>
                </thead>
                <tbody id="productsTableBody"></tbody>
              </table>
            </div>
            <div class="pagination">
              <button class="page-btn" onclick="changePage(-1)" id="prevPageBtn" data-translate="previous">Previous</button>
              <span class="page-info" id="pageInfo">Page 1 of 1</span>
              <button class="page-btn" onclick="changePage(1)" id="nextPageBtn" data-translate="next">Next</button>
            </div>
          </div>
		  
		  
<div class="download-section">
  <div class="section-title" style="font-size: 16px; color: #16A34A;" data-translate="dataManagement">Data Management</div>
  <div class="download-buttons">
    <button class="button btn-green" onclick="downloadCompleteBackup()" data-translate="downloadCompleteBackup">Download Complete Information</button>
    <button class="button btn-green" onclick="importCompleteBackup()" data-translate="restoreCompleteBackup">Restore Complete Information</button>
  </div>
  <div class="download-buttons" style="margin-top: 10px;">
    <button class="button btn-orange" onclick="downloadProductsAsText()" data-translate="downloadProductsOnly">Download Products + Float</button>
    <button class="button btn-orange" onclick="importProductsOnly()" data-translate="importProductsOnly">Restore Products + Float</button>
  </div>
  <div class="download-buttons" style="margin-top: 10px;">
    <button class="button btn-purple" onclick="downloadSalesData()" data-translate="downloadSalesOnly">Download Sales Only</button>
    <button class="button btn-purple" onclick="importSalesOnly()" data-translate="importSalesOnly">Import Sales Only</button>
  </div>
  <input type="file" id="completeBackupInput" style="display: none;" accept=".json" onchange="handleCompleteBackupUpload(event)">
  <input type="file" id="productsOnlyInput" style="display: none;" accept=".json" onchange="handleProductsOnlyUpload(event)">
  <input type="file" id="salesOnlyInput" style="display: none;" accept=".json" onchange="handleSalesOnlyUpload(event)">
</div>
		  
		  
		  
        </div>
        <div id="report" class="tab-content">
          <div class="section-title" data-translate="dailyReport">Daily Report</div>
          
          <!-- NEW HISTORY SECTION -->
          <div class="history-section">
              <div class="section-title" style="font-size: 16px; color: #3B82F6;" data-translate="pastReports">Past Reports</div>
              <div class="form-group">
                  <label data-translate="selectSavedDate">Select Saved Date to View:</label>
                  <select id="reportHistoryDropdown" onchange="loadReportFromHistory()">
                      <option value="" data-translate="selectDateDropdown">-- Select a Date --</option>
                  </select>
              </div>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="totalSales">R0</div>
              <div class="stat-label" data-translate="totalSales">Total Sales</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalTransactions">0</div>
              <div class="stat-label" data-translate="transactions">Transactions</div>
            </div>
          </div>
          <div class="form-group">
            <label data-translate="viewingReportFor">Viewing Report For:</label>
            <input type="date" id="daySelect" onchange="updateReport()">
          </div>
          <div class="card yellow">
            <div class="card-title">Kotie</div>
            <div style="font-size: 14px; margin-bottom: 12px;" data-translate="transactions">Transactions: <strong id="KotieCount">0</strong>
            </div>
            <div class="amounts-row">
              <div class="amount-box">
                <div class="amount-label" data-translate="cash">Cash</div>
                <div class="amount-value green">R <span id="KotieCash">0.00</span>
                </div>
              </div>
              <div class="amount-box">
                <div class="amount-label" data-translate="card">Card</div>
                <div class="amount-value blue">R <span id="KotieCard">0.00</span>
                </div>
              </div>
            </div>
            <div class="total-display">R <span id="KotieTotal">0.00</span>
            </div>
          </div>
          <div class="card purple">
            <div class="card-title">FRANCOIS</div>
            <div style="font-size: 14px; margin-bottom: 12px;" data-translate="transactions">Transactions: <strong id="francoisCount">0</strong>
            </div>
            <div class="amounts-row">
              <div class="amount-box">
                <div class="amount-label" data-translate="cash">Cash</div>
                <div class="amount-value green">R <span id="francoisCash">0.00</span>
                </div>
              </div>
              <div class="amount-box">
                <div class="amount-label" data-translate="card">Card</div>
                <div class="amount-value blue">R <span id="francoisCard">0.00</span>
                </div>
              </div>
            </div>
            <div class="total-display">R <span id="francoisTotal">0.00</span>
            </div>
          </div>
          <div class="card green">
            <div class="card-title" data-translate="dayTotal">DAY TOTAL</div>
            <div class="amounts-row">
              <div class="amount-box">
                <div class="amount-label" data-translate="cash">Cash</div>
                <div class="amount-value green">R <span id="totalCash">0.00</span>
                </div>
              </div>
              <div class="amount-box">
                <div class="amount-label" data-translate="card">Card</div>
                <div class="amount-value blue">R <span id="totalCard">0.00</span>
                </div>
              </div>
            </div>
            <div style="font-size: 28px; font-weight: bold; color: #16A34A; text-align: center; background: white; padding: 16px; border-radius: 8px; margin-top: 16px;">R <span id="grandTotal">0.00</span>
            </div>
            <div style="font-size: 14px; color: #6B7280; text-align: center; margin-top: 12px;" data-translate="totalTransactions">Total transactions: <strong id="totalTransactionsCount">0</strong>
            </div>
          </div>
          
          <!-- CASH RECONCILIATION SECTION -->
          <div class="cash-reconciliation-section" id="cashReconciliationSection" style="display: none;">
            <div class="section-title" style="font-size: 16px; color: #16A34A;" data-translate="cashReconciliation">Cash Reconciliation</div>
            <div class="reconciliation-grid">
                <div class="reconciliation-item">
                    <div class="reconciliation-label" data-translate="totalCashSales">Cash Sales</div>
                    <div class="reconciliation-value green" id="reportCashSales">R0.00</div>
                </div>
                <div class="reconciliation-item">
                    <div class="reconciliation-label" data-translate="startingFloat">Starting Float</div>
                    <div class="reconciliation-value orange" id="reportStartingFloat">R700.00</div>
                </div>
                <div class="reconciliation-item">
                    <div class="reconciliation-label" data-translate="totalInTill">Total in Till</div>
                    <div class="reconciliation-value blue" id="reportTotalInTill">R700.00</div>
                </div>
                <div class="reconciliation-item">
                    <div class="reconciliation-label" data-translate="floatToKeep">Float to Keep</div>
                    <div class="reconciliation-value orange" id="reportFloatToKeep">R700.00</div>
                </div>
            </div>
            <div class="cash-to-bank" id="cashToBankDisplay">
                <div data-translate="cashToBank">Cash to Bank:</div>
                <div style="font-size: 32px; font-weight: bold;" id="cashToBankAmount">R0.00</div>
            </div>
            <div class="denomination-inputs">
                <div class="section-title" style="font-size: 14px; color: #374151;" data-translate="countDenominations">Count Actual Cash in Till:</div>
                <div id="denominationInputsContainer"></div>
                <button class="button btn-green full-width" onclick="calculateReportCashToBank()" style="margin-top: 15px;" data-translate="calculateCashToBank">Calculate Cash to Bank</button>
            </div>
          </div>
 
            <div id="transListContainer" style="display:none; margin-top: 16px;">
            <div style="font-size: 14px; font-weight: bold; color: #374151; margin-bottom: 12px;" data-translate="transactions">Transactions:</div>
            <div class="trans-list" id="transList"></div>
          </div>
          <button class="button btn-blue full-width" onclick="generatePDF()" style="margin-top: 20px;" data-translate="generatePDFReport">Generate PDF Report</button>
          
          <div class="danger-zone">
              <div class="danger-title" data-translate="dangerZone">Danger Zone</div>
              <button class="button btn-orange full-width" onclick="clearData()" style="margin-top: 12px;" data-translate="clearAllData">Clear ALL Data</button>
          </div>
        </div>
        
        <!-- NEW FLOAT MANAGEMENT TAB -->
        <div id="float" class="tab-content">
            <div class="section-title" data-translate="floatManagement">Float Management</div>
            
            <div class="float-management-section">
                <div class="section-title" style="font-size: 16px; color: #ea580c;" data-translate="currentFloat">Current Float</div>
                <div class="float-summary">
                    <div style="text-align: center; color: #6b7280;" data-translate="floatAmount">Float Amount</div>
                    <div class="float-amount" id="floatTotalAmount">R700.00</div>
                    <div style="text-align: center; color: #6b7280; font-size: 14px;" data-translate="floatDescription">R700.00 remains in the till for next day's change</div>
                </div>
                
                <div class="section-title" style="font-size: 16px; color: #ea580c;" data-translate="floatBreakdown">Float Breakdown</div>
                <div class="float-breakdown" id="floatBreakdown"></div>
                
<div class="form-group" style="margin-top: 20px;">
    <label data-translate="adjustFloat">Adjust Float Amount:</label>
    <div style="position: relative;">
        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-weight: bold; color: #374151;">R</span>
        <input type="number" id="newFloatAmount" value="700.00" step="0.01" min="0" style="padding-left: 30px;">
    </div>
</div>
                
                <button class="button btn-orange full-width" onclick="updateFloatAmount()" style="margin-bottom: 15px;" data-translate="updateFloat">Update Float Amount</button>
                <button class="button btn-blue full-width" onclick="setupFloatDenominations()" data-translate="setupDenominations">Setup Float Denominations</button>
            </div>
            
            <div class="cash-reconciliation-section">
                <div class="section-title" style="font-size: 16px; color: #16A34A;" data-translate="dailyCashReconciliation">Daily Cash Reconciliation</div>
                <div class="form-group">
                    <label data-translate="selectDateForReconciliation">Select Date for Reconciliation:</label>
                    <input type="date" id="reconciliationDate" onchange="loadDailyCashReconciliation()">
                </div>
                
                <div id="reconciliationResults" style="display: none;">
                    <div class="reconciliation-grid">
                        <div class="reconciliation-item">
                            <div class="reconciliation-label" data-translate="date">Date</div>
                            <div class="reconciliation-value" id="reconDate">-</div>
                        </div>
                        <div class="reconciliation-item">
                            <div class="reconciliation-label" data-translate="cashSales">Cash Sales</div>
                            <div class="reconciliation-value green" id="reconCashSales">R0.00</div>
                        </div>
                        <div class="reconciliation-item">
                            <div class="reconciliation-label" data-translate="startingFloat">Starting Float</div>
                            <div class="reconciliation-value orange" id="reconStartingFloat">R700.00</div>
                        </div>
                        <div class="reconciliation-item">
                            <div class="reconciliation-label" data-translate="expectedInTill">Expected in Till</div>
                            <div class="reconciliation-value blue" id="reconExpectedInTill">R700.00</div>
                        </div>
                    </div>
                    
                    <div class="cash-to-bank">
                        <div data-translate="cashToBank">Cash to Bank:</div>
                        <div style="font-size: 32px; font-weight: bold;" id="reconCashToBank">R0.00</div>
                    </div>
                    
                    <div class="denomination-inputs">
                        <div class="section-title" style="font-size: 14px; color: #374151;" data-translate="actualCashCount">Actual Cash Count</div>
                        <div id="reconDenominationInputs"></div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <div style="font-weight: bold; color: #374151; margin-bottom: 10px;" data-translate="variance">Variance</div>
                            <div id="varianceDisplay" style="text-align: center; font-size: 20px; font-weight: bold;">R0.00</div>
                            <div id="varianceMessage" style="text-align: center; color: #6b7280; margin-top: 5px;"></div>
                        </div>
                        
                        <button class="button btn-green full-width" onclick="saveReconciliation()" style="margin-top: 15px;" data-translate="saveReconciliation">Save Reconciliation</button>
                    </div>
                </div>
            </div>
            
            <div class="history-section">
                <div class="section-title" style="font-size: 16px; color: #3B82F6;" data-translate="reconciliationHistory">Reconciliation History</div>
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: #f9fafb;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: #3b82f6; color: white;">
                                <th style="padding: 8px; text-align: left;" data-translate="date">Date</th>
                                <th style="padding: 8px; text-align: right;" data-translate="cashSales">Cash Sales</th>
                                <th style="padding: 8px; text-align: right;" data-translate="toBank">To Bank</th>
                                <th style="padding: 8px; text-align: right;" data-translate="variance">Variance</th>
                            </tr>
                        </thead>
                        <tbody id="reconciliationHistoryBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
      </div>
      <div id="paymentModal" class="modal">
        <div class="modal-content">
          <div class="modal-title" data-translate="setPayment">Set Payment</div>
          <div class="card green" style="margin-bottom: 20px;">
            <div style="font-size: 14px; color: #6B7280;" data-translate="totalAmount">Total Amount:</div>
            <div style="font-size: 28px; font-weight: bold; color: #16A34A;">R <span id="modalTotal">0.00</span>
            </div>
          </div>


  
		  
	
 <div class="cash-amount-section">
    <div class="cash-amount-label" data-translate="cashAmounts">Cash Amounts (Select or type):</div>
    <div class="cash-amount-row">
        <select class="cash-amount-select" id="cashAmountDropdown" onchange="selectCashAmount()">
            <option value="" data-translate="selectAmount">Select Amount</option>
            <option value="10">R10.00</option>
            <option value="20">R20.00</option>
            <option value="50">R50.00</option>
            <option value="100">R100.00</option>
            <option value="200">R200.00</option>
        </select>
        <input type="number" id="cashAmount" placeholder="0.00" class="cash-amount-input" oninput="updatePaymentModal()" data-translate-placeholder="amount">
    </div>
    <button class="button btn-blue" onclick="openCashDenominationModal()" style="margin-top: 10px; width: 100%;">Enter Cash Denomination Details</button>
</div>
	  
          <div class="form-group">
            <label data-translate="card">Card (R):</label>
            <input type="number" id="cardAmount" placeholder="0.00" oninput="updatePaymentModal()" data-translate-placeholder="amount">
          </div>
          <div class="form-group">
            <label data-translate="secondCard">Second Card (R) - Optional:</label>
            <input type="number" id="cardAmount2" placeholder="0.00" oninput="updatePaymentModal()" data-translate-placeholder="amount">
          </div>
          <div class="form-group">
            <div class="card" style="margin: 0; padding: 14px;">
              <div style="font-size: 14px; color: #6B7280;" data-translate="paidTogether">Paid Together:</div>
              <div style="font-weight: bold; font-size: 18px;">R <span id="paidTogether">0.00</span>
              </div>
            </div>
          </div>
          <div id="changeDisplay" style="display:none;">
            <div class="card yellow" style="margin: 0; padding: 14px;">
              <div style="font-size: 14px; color: #6B7280;" data-translate="change">Change:</div>
              <div style="font-weight: bold; font-size: 18px; color: #B45D04;">R <span id="change">0.00</span>
              </div>
            </div>
          </div>
          <div id="insufficientDisplay" style="display:none;">
            <div style="background: #FEE2E2; border: 2px solid #EF4444; border-radius: 8px; padding: 14px; margin: 16px 0;">
              <div style="color: #7F1D1D; font-weight: bold;" data-translate="insufficient">INSUFFICIENT!</div>
              <div style="color: #DC2626; font-size: 14px;" data-translate="stillNeeded">Still needed: R <span id="stillNeeded">0.00</span>
              </div>
            </div>
          </div>
          <div class="modal-buttons">
            <button class="button" style="background: #6B7280; color: white;" onclick="closePaymentModal()" data-translate="cancel">Cancel</button>
            <button class="button btn-green" id="completeBtn" onclick="completeTransaction()" data-translate="complete">Complete</button>
          </div>
        </div>
      </div>
      <div id="ownerSelectionModal" class="owner-selection-modal">
        <div class="owner-selection-content">
          <div class="modal-title" data-translate="selectOwner">Select Owner</div>
          <p style="margin-bottom: 20px;" data-translate="whoDoesThisBelong">Who does this product belong to?</p>
          <div class="owner-buttons">
            <button class="owner-btn Kotie" onclick="selectOwner('Kotie')">Kotie</button>
            <button class="owner-btn francois" onclick="selectOwner('Francois')">Francois</button>
          </div>
          <button class="button" style="background: #6B7280; color: white; width: 100%;" onclick="closeOwnerSelection()" data-translate="cancel">Cancel</button>
        </div>
      </div>
      <div id="manualInputModal" class="modal">
        <div class="modal-content">
          <div class="modal-title" data-translate="manualInput">Manual Input</div>
          <div class="form-group">
            <label data-translate="productName">Product Name:</label>
            <input type="text" id="manualProductName" placeholder="Product name" data-translate-placeholder="productName">
          </div>
          <div class="form-group">
            <label data-translate="price">Price (R):</label>
            <input type="number" id="manualProductPrice" placeholder="0.00" step="0.01" data-translate-placeholder="price">
          </div>
          <div class="form-group">
            <label data-translate="quantity">Quantity:</label>
            <input type="number" id="manualProductQuantity" placeholder="1" value="1" min="1" data-translate-placeholder="quantity">
          </div>
          <div class="modal-buttons">
            <button class="button" style="background: #6B7280; color: white;" onclick="closeManualInputModal()" data-translate="cancel">Cancel</button>
            <button class="button btn-green" onclick="addManualProduct()" data-translate="add">Add</button>
          </div>
        </div>
      </div>
      
      <!-- FLOAT DENOMINATION SETUP MODAL -->
      <div id="floatDenominationModal" class="modal">
        <div class="modal-content">
          <div class="modal-title" data-translate="setupFloatDenominations">Setup Float Denominations</div>
          <p style="margin-bottom: 20px; color: #6b7280;" data-translate="setupFloatInstructions">Enter how many of each denomination you want in your R700.00 float:</p>
          
          <div id="denominationSetupContainer"></div>
          
          <div style="margin-top: 20px; padding: 15px; background: #f0fdf4; border-radius: 8px; border: 1px solid #22c55e;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight: bold; color: #374151;" data-translate="totalFloat">Total Float:</span>
              <span style="font-size: 24px; font-weight: bold; color: #ea580c;" id="floatSetupTotal">R700.00</span>
            </div>
            <div id="floatSetupVariance" style="text-align: center; margin-top: 10px; font-size: 14px;"></div>
          </div>
          
          <div class="modal-buttons">
            <button class="button" style="background: #6B7280; color: white;" onclick="closeFloatDenominationModal()" data-translate="cancel">Cancel</button>
            <button class="button btn-green" onclick="saveFloatDenominations()" data-translate="save">Save</button>
          </div>
        </div>
      </div>
      
      <!-- SCANNER HELP MODAL -->
      <div id="scannerHelpModal" class="modal">
        <div class="modal-content">
          <div class="modal-title" data-translate="scanHelpTitle">How to Use the Barcode Scanner</div>
          
          <div class="help-section">
            <h3 data-translate="scanStep1Title">1. Setup (Linking Labels)</h3>
            <div class="help-step">
                <span class="help-icon">üñ®Ô∏è</span> <strong data-translate="step1">Step 1:</strong> <span data-translate="scanStep1_1">Create a label with your label maker. Give it a code number (e.g., 1005). Print it and stick it on the item.</span>
            </div>
            <div class="help-step">
                <span class="help-icon">üíª</span> <strong data-translate="step2">Step 2:</strong> <span data-translate="scanStep1_2">Go to the <strong>Products Tab</strong> in this app.</span>
            </div>
            <div class="help-step">
                <span class="help-icon">üìù</span> <strong data-translate="step3">Step 3:</strong> <span data-translate="scanStep1_3">Fill in the product details (Name, Price, Owner).</span>
            </div>
            <div class="help-step">
                <span class="help-icon">üî´</span> <strong data-translate="step4">Step 4:</strong> <span data-translate="scanStep1_4">Click inside the <strong>"Product Code"</strong> box and <strong>SCAN</strong> the sticker. The number (1005) will appear automatically.</span>
            </div>
            <div class="help-step">
                <span class="help-icon">üíæ</span> <strong data-translate="step5">Step 5:</strong> <span data-translate="scanStep1_5">Click <strong>Save Product</strong>.</span>
            </div>
            <div class="important-note" data-translate="scanNote">
                The Code on the Sticker MUST match the Code in the System!
            </div>
          </div>

          <div class="help-section">
            <h3 data-translate="scanStep2Title">2. Selling (The Action)</h3>
            <div class="help-step">
                <span class="help-icon">üõí</span> <strong data-translate="step1">Step 1:</strong> <span data-translate="scanStep2_1">Go to the <strong>Sales Tab</strong>.</span>
            </div>
            <div class="help-step">
                <span class="help-icon">üî´</span> <strong data-translate="step2">Step 2:</strong> <span data-translate="scanStep2_2">Simply <strong>SCAN</strong> the item with your scanner.</span>
            </div>
            <div class="help-step">
                <span class="help-icon">‚úÖ</span> <strong data-translate="step3">Step 3:</strong> <span data-translate="scanStep2_3">The system will find the product (e.g., "Silver Bangle") and show you the price.</span>
            </div>
            <div class="help-step">
                <span class="help-icon">‚ûï</span> <strong data-translate="step4">Step 4:</strong> <span data-translate="scanStep2_4">Click <strong>Add Product</strong> to put it in the cart.</span>
            </div>
          </div>

          <div class="modal-buttons">
            <button class="button btn-blue full-width" onclick="closeScannerHelp()" data-translate="gotIt">Got it!</button>
          </div>
        </div>
      </div>

    <script>
        const {
          jsPDF
        } = window.jspdf;
        const translations = {
          en: {
            sales: "Sales",
            transaction: "Transaction",
            newTransaction: "New Transaction",
            name: "Name",
            selectName: "Select Name",
            date: "Date",
            time: "Time",
            today: "Today",
            now: "Now",
            quantityManagement: "Quantity Management",
            noQuantity: "No Quantity",
            withQuantity: "With Quantity",
            availableQuantity: "Available Quantity",
            saleQuantity: "Sale Quantity",
            availableStock: "Available Stock",
            noItemAvailable: "No \"",
            noItemAvailableEnd: "\" Available",
            productCode: "Product Code",
            enterProductCode: "Enter product code",
            findProduct: "Find Product",
            product: "Product",
            price: "Price",
            owner: "Owner",
            category: "Category",
            addProduct: "Add Product",
            productSelection: "Product Selection",
            searchProducts: "Search products...",
            previous: "Previous",
            next: "Next",
            manualAddition: "Manual Addition",
            manualInput: "Manual Input",
            productName: "Product name",
            quantity: "Quantity",
            add: "Add",
            items: "Selected Products",
            total: "TOTAL",
            choosePaymentMethod: "Choose Payment Method",
            importProductsOnly: "Restore Products + Float",
            importSalesOnly: "Restore Sales Information",
            productsFound: "products found",
            currentProductsReplaced: "All current products will be replaced",
            productsUploaded: "Products uploaded successfully!",
            currentSalesReplaced: "All current sales data will be replaced",
            salesUploaded: "Sales data uploaded successfully!",
            found: "found",
            products: "Products",
            productManagement: "Product Management",
            categoryManagement: "Category Management",
            typeCategories: "Type to see categories or add new one",
            addCategory: "Add Category",
            newProduct: "New Product",
            selectOwner: "Select Owner",
            both: "Both",
            selectCategory: "Select Category",
            productCodeOptional: "Product code (optional)",
            startingStock: "Starting Stock (leave empty for unlimited)",
            saveProduct: "Save Product",
            cancel: "Cancel",
            allCategories: "All Categories",
            allOwners: "All Owners",
            code: "Code",
            stock: "Stock",
            actions: "Actions",
            edit: "Edit",
            delete: "Delete",
            dataManagement: "Data Management",
            downloadCompleteBackup: "Save Complete Information",
            restoreCompleteBackup: "Restore Complete Information",
            downloadProductsOnly: "Download Products + Float",
            downloadSalesOnly: "Save Sales Information",
            report: "Report",
            dailyReport: "Daily Report",
            totalSales: "Total Sales",
            transactions: "Transactions",
            chooseDay: "Choose Day",
            cash: "Cash",
            card: "Card",
            dayTotal: "DAY TOTAL",
            totalTransactions: "Total transactions",
            generatePDFReport: "Generate PDF Report",
            clearData: "Clear Data",
            setPayment: "Set Payment",
            totalAmount: "Total Amount",
            cashAmounts: "Cash Amounts (Select or type):",
            selectAmount: "Select Amount",
            amount: "0.00",
            secondCard: "Second Card (R) - Optional:",
            paidTogether: "Paid Together:",
            change: "Change:",
            insufficient: "INSUFFICIENT!",
            stillNeeded: "Still needed: R",
            complete: "Complete",
            whoDoesThisBelong: "Who does this product belong to?",
            pleaseSelectName: "Please select a name first",
            pleaseEnterCode: "Please enter a product code",
            productBelongsTo: "This product belongs to ",
            changeNameOrProduct: ". Please change the name or select a different product.",
            productNotFound: "Product with code ",
            notFound: " not found",
            firstFindProduct: "Please find a product first",
            cannotAdd: ". Cannot add to cart.",
            fillEverything: "Please fill in everything",
            transactionComplete: "Transaction completed successfully!",
            transactionNo: "Transaction Number",
            productValue: "Product Value",
            cashReceived: "Cash Received",
            cardReceived: "Card Received",
            card2Received: "Second Card Received",
            pdfLibraryError: "PDF library not loaded. Please check your internet connection.",
            noTransactionsDay: "No transactions found for this day",
            pdfGenerated: "PDF report generated successfully!",
            pdfError: "Error generating PDF: ",
            tryAgain: "Please try again.",
            noProductsDownload: "No products to download",
            productsDownloaded: "Products downloaded successfully!",
            noTransactionsDownload: "No transactions to download for this day",
            reportDownloaded: "Report downloaded successfully!",
            backupDownloaded: "Complete backup downloaded successfully!",
            invalidBackup: "Invalid backup file format",
            backupFound: "Backup data found",
            currentDataReplaced: "All current data will be replaced. Continue?",
            backupRestored: "Backup restored successfully!",
            errorReadingBackup: "Error reading backup file: ",
            salesDataDownloaded: "Sales data downloaded successfully!",
            invalidProductFile: "Invalid product file format",
            errorReadingFile: "Error reading file: ",
            transactionsUploaded: "transactions uploaded for date",
            invalidReportFile: "Invalid report file format",
            confirmClearData: "Are you sure you want to clear ALL data? This cannot be undone!",
            dataCleared: "All data has been cleared",
            salesExported: "Sales data exported successfully!",
            salesCopied: "Sales data copied to clipboard!",
            errorCopying: "Error copying to clipboard: ",
            pleasePasteData: "Please paste sales data in the text area",
            transactionsImported: "transactions imported for date",
            invalidDataFormat: "Invalid data format",
            errorReadingData: "Error reading data: ",
            invalidFileFormat: "Invalid file format",
            selectNameFirst: "Select a name above to see products",
            noProducts: "No products available",
            addProductsImport: "Add products in the Products tab or import from a file",
            noProductsFound: "No products found",
            tryDifferentSearch: "Try a different search term",
            outOfStock: "Out of Stock",
            pleaseEnterCategory: "Please enter a category name",
            categoryExists: "This category already exists",
            categoryAdded: "Category added: ",
            pleaseSelectOwner: "Please select an owner",
            fillNamePrice: "Please fill in name and price",
            pleaseChooseCategory: "Please choose a category",
            codeExists: "This product code already exists",
            productSaved: "Product saved successfully!",
            productUpdated: "Product updated successfully",
            editProduct: "Edit Product",
            updateProduct: "Update Product",
            confirmDelete: "Are you sure you want to delete this product?",
            remove: "Delete",
            page: "Page",
            of: "of",
            pleaseEnterProductCode: "Please enter a product code",
            started: "started",
            // New Translations
            dangerZone: "Danger Zone",
            clearAllData: "Clear ALL Data",
            confirmClearAll: "Are you REALLY sure? This will delete all history, products, and sales forever.",
            pastReports: "Past Reports",
            selectSavedDate: "Select Saved Date to View:",
            selectDateDropdown: "-- Select a Date --",
            viewingReportFor: "Viewing Report For:",
            newDayDetected: "New day detected! \n\nDo you want to download the Sales Report for the last active day",
            // Scanner Help
            scanHelpTitle: "How to Use the Barcode Scanner",
            scanStep1Title: "1. Setup (Linking Labels)",
            step1: "Step 1:",
            step2: "Step 2:",
            step3: "Step 3:",
            step4: "Step 4:",
            step5: "Step 5:",
            scanStep1_1: "Create a label with your label maker. Give it a code number (e.g., 1005). Print it and stick it on the item.",
            scanStep1_2: "Go to the Products Tab in this app.",
            scanStep1_3: "Fill in the product details (Name, Price, Owner).",
            scanStep1_4: "Click inside the \"Product Code\" box and SCAN the sticker. The number (1005) will appear automatically.",
            scanStep1_5: "Click Save Product.",
            scanNote: "The Code on the Sticker MUST match the Code in the System!",
            scanStep2Title: "2. Selling (The Action)",
            scanStep2_1: "Go to the Sales Tab.",
            scanStep2_2: "Simply SCAN the item with your scanner.",
            scanStep2_3: "The system will find the product (e.g., \"Silver Bangle\") and show you the price.",
            scanStep2_4: "Click Add Product to put it in the cart.",
            gotIt: "Got it!",
            // Float Management Translations
            float: "Float",
            floatManagement: "Float Management",
            currentFloat: "Current Float",
            floatAmount: "Float Amount",
            floatDescription: "R700.00 remains in the till for next day's change",
            floatBreakdown: "Float Breakdown",
            adjustFloat: "Adjust Float Amount:",
            updateFloat: "Update Float Amount",
            setupDenominations: "Setup Float Denominations",
            dailyCashReconciliation: "Daily Cash Reconciliation",
            selectDateForReconciliation: "Select Date for Reconciliation:",
            cashReconciliation: "Cash Reconciliation",
            totalCashSales: "Cash Sales",
            startingFloat: "Starting Float",
            totalInTill: "Total in Till",
            floatToKeep: "Float to Keep",
            cashToBank: "Cash to Bank",
            countDenominations: "Count Actual Cash in Till:",
            calculateCashToBank: "Calculate Cash to Bank",
            cashSales: "Cash Sales",
            expectedInTill: "Expected in Till",
            actualCashCount: "Actual Cash Count",
            variance: "Variance",
            saveReconciliation: "Save Reconciliation",
            reconciliationHistory: "Reconciliation History",
            toBank: "To Bank",
            setupFloatDenominations: "Setup Float Denominations",
            setupFloatInstructions: "Enter how many of each denomination you want in your R700.00 float:",
            totalFloat: "Total Float",
            save: "Save",
            notes: "Notes",
            coins: "Coins",
            over: "Over",
            short: "Short",
            correct: "Correct",
            tip: "Tip",
            clickAutoFill: 'Click "Auto-fill from Transactions"',
            toAddCash: 'to automatically add',
    sales: "Sales",
    products: "Products",
    report: "Report",
    float: "Float",
    transaction: "Transaction",
    newTransaction: "New Transaction",
    name: "Name",
    selectName: "Select Name",
    both: "Both",
    date: "Date",
    time: "Time",
    today: "Today",
    now: "Now",
    quantityManagement: "Quantity Management",
    noQuantity: "No Quantity",
    withQuantity: "With Quantity",
    availableQuantity: "Available Quantity",
    saleQuantity: "Sale Quantity",
    availableStock: "Available Stock",
    noItemAvailable: "No \"",
    noItemAvailableEnd: "\" Available",
    productCode: "Product Code",
    enterProductCode: "Enter product code",
    findProduct: "Find Product",
    product: "Product",
    price: "Price",
    owner: "Owner",
    category: "Category",
    addProduct: "Add Product",
    productSelection: "Product Selection",
    searchProducts: "Search products...",
    previous: "Previous",
    next: "Next",
    manualAddition: "Manual Addition",
    manualInput: "Manual Input",
    items: "Selected Products",
    total: "TOTAL",
    choosePaymentMethod: "Choose Payment Method",
    productManagement: "Product Management",
    categoryManagement: "Category Management",
    typeCategories: "Type to see categories or add new one",
    addCategory: "Add Category",
    newProduct: "New Product",
    selectOwner: "Select Owner",
    selectCategory: "Select Category",
    productName: "Product name",
    productCodeOptional: "Product code (optional)",
    startingStock: "Starting Stock (leave empty for unlimited)",
    saveProduct: "Save Product",
    cancel: "Cancel",
    allCategories: "All Categories",
    allOwners: "All Owners",
    code: "Code",
    stock: "Stock",
    actions: "Actions",
    dataManagement: "Data Management",
    downloadCompleteBackup: "Download Complete Information",
    restoreCompleteBackup: "Restore Complete Information",
    downloadProductsOnly: "Download Products + Float",
    importProductsOnly: "Restore Products + Float",
    downloadSalesOnly: "Download Sales Only",
    importSalesOnly: "Import Sales Only",
    dailyReport: "Daily Report",
    pastReports: "Past Reports",
    selectSavedDate: "Select Saved Date to View:",
    selectDateDropdown: "-- Select a Date --",
    totalSales: "Total Sales",
    transactions: "Transactions",
    viewingReportFor: "Viewing Report For:",
    cash: "Cash",
    card: "Card",
    dayTotal: "Day Total",
    totalTransactions: "Total transactions",
    cashReconciliation: "Cash Reconciliation",
    totalCashSales: "Cash Sales",
    startingFloat: "Starting Float",
    totalInTill: "Total in Till",
    floatToKeep: "Float to Keep",
    cashToBank: "Cash to Bank",
    countDenominations: "Count Actual Cash in Till:",
    calculateCashToBank: "Calculate Cash to Bank",
    generatePDFReport: "Generate PDF Report",
    dangerZone: "Danger Zone",
    clearAllData: "Clear ALL Data",
    floatManagement: "Float Management",
    currentFloat: "Current Float",
    floatAmount: "Float Amount",
    floatDescription: "Remains in the till for next day's change",
    floatBreakdown: "Float Breakdown",
    adjustFloat: "Adjust Float Amount:",
    updateFloat: "Update Float Amount",
    setupDenominations: "Setup Float Denominations",
    dailyCashReconciliation: "Daily Cash Reconciliation",
    selectDateForReconciliation: "Select Date for Reconciliation:",
    cashSales: "Cash Sales",
    expectedInTill: "Expected in Till",
    actualCashCount: "Actual Cash Count",
    variance: "Variance",
    saveReconciliation: "Save Reconciliation",
    reconciliationHistory: "Reconciliation History",
    toBank: "To Bank",		
  notes: "Notes",
  coins: "Coins",
  enterCashReceived: "Enter Cash Received",
  enterCashReceivedDesc: "Enter the denominations you received from the customer:",
  totalReceived: "Total Received",
  giveChange: "Give Change",
  changeToGive: "Change to give",
  specifyChangeDenoms: "Specify which denominations to give as change:",
  changeTotal: "Change Total",
  difference: "Difference",
  saveChanges: "Save Changes",
  
  priceR: "Price (R):",
  productCodeOptional: "Product code (optional)", // already present
  startingStockDesc: "Starting Stock (leave empty for unlimited):",
  productNameLabel: "Product Name:",
  editTransactionTitle: "Edit Transaction",
  warningReverseCash: "Warning: Editing will reverse the original cash movements and apply new ones.",
  customerName: "Customer Name",
  itemsLabel: "Items:",
  paymentMethod: "Payment Method:",
  cashOnly: "Cash Only",
  cardOnly: "Card Only",
  mixedCashCard: "Mixed (Cash + Card)",
  cashAmount: "Cash Amount:",
  cardAmount: "Card Amount:",
  secondCardOptional: "Second Card (Optional):",
  totalLabel: "Total:",
  amountToBank: "Amount to Bank",
  currentTillTotal: "Current Till Total",
  floatToKeepShort: "Float to Keep",
  amount: "Amount", // generic
  installApp: "Install App",
   editTransactionTitle: "Edit Transaction",
  warningReverseCash: "Warning: Editing will reverse the original cash movements and apply new ones.",
  customerName: "Customer Name",
  itemsLabel: "Items:",
  paymentMethod: "Payment Method:",
  cashOnly: "Cash Only",
  cardOnly: "Card Only",
  mixedCashCard: "Mixed (Cash + Card)",
  cashAmount: "Cash Amount:",
  cardAmount: "Card Amount:",
  secondCardOptional: "Second Card (Optional):",
  totalLabel: "Total:",
  saveChanges: "Save Changes"
		
          },
          af: {
            sales: "Verkope",
            transaction: "Transaksie",
            newTransaction: "Nuwe Transaksie",
            name: "Naam",
            selectName: "Kies Naam",
            date: "Datum",
            time: "Tyd",
            today: "Vandag",
            now: "Nou",
            quantityManagement: "Hoeveelheid Bestuur",
            noQuantity: "Geen Hoeveelheid",
            withQuantity: "Met Hoeveelheid",
            availableQuantity: "Beskikbare Hoeveelheid",
            saleQuantity: "Verkoop Hoeveelheid",
            availableStock: "Beskikbare Voorraad",
            noItemAvailable: "Geen \"",
            noItemAvailableEnd: "\" Beskikbaar",
            productCode: "Produk Kode",
            enterProductCode: "Voer produk kode in",
            findProduct: "Vind Produk",
            product: "Produk",
            price: "Prys",
            owner: "Eienaar",
            category: "Kategorie",
            addProduct: "Voeg Produk By",
            productSelection: "Produk Keuse",
            searchProducts: "Soek produkte...",
            previous: "Vorige",
            next: "Volgende",
            manualAddition: "Handmatige Byvoeging",
            manualInput: "Handmatige Invoer",
            productName: "Produk naam",
            quantity: "Hoeveelheid",
            add: "Voeg By",
            items: "Gekose Produkte",
            total: "TOTAAL",
            choosePaymentMethod: "Kies Betaal Metode",
            importProductsOnly: "Herstel Produkte + Float",
            importSalesOnly: "Herstel Verkope Informasie",
            productsFound: "produkte gevind",
            currentProductsReplaced: "Alle huidige produkte sal vervang word",
            productsUploaded: "Produkte suksesvol opgelaai!",
            currentSalesReplaced: "Alle huidige verkoopdata sal vervang word",
            salesUploaded: "Verkoopdata suksesvol opgelaai!",
            found: "gevind",
            products: "Produkte",
            productManagement: "Produk Bestuur",
            categoryManagement: "Kategorie Bestuur",
            typeCategories: "Tik om kategorie√´ te sien of voeg nuwe een by",
            addCategory: "Voeg Kategorie By",
            newProduct: "Nuwe Produk",
            selectOwner: "Kies Eienaar",
            both: "Beide",
            selectCategory: "Kies Kategorie",
            productCodeOptional: "Produk kode (opsioneel)",
            startingStock: "Begin Voorraad (laat leeg vir onbeperk)",
            saveProduct: "Stoor Produk",
            cancel: "Kanselleer",
            allCategories: "Alle Kategorie√´",
            allOwners: "Alle Eienaars",
            code: "Kode",
            stock: "Voorraad",
            actions: "Aksies",
            edit: "Wysig",
            delete: "Verwyder",
            dataManagement: "Data Bestuur",
            downloadCompleteBackup: "Stoor Volledige Informasie",
            restoreCompleteBackup: "Herstel Volledige Informasie",
            downloadProductsOnly: "Stoor Produkte + Float",
            downloadSalesOnly: "Stoor Verkope Informasie",
            report: "Verslag",
            dailyReport: "Daaglikse Verslag",
            totalSales: "Totale Verkope",
            transactions: "Transaksies",
            chooseDay: "Kies Dag",
            cash: "Kontant",
            card: "Kaart",
            dayTotal: "DAG TOTAAL",
            totalTransactions: "Totale transaksies",
            generatePDFReport: "Genereer PDF Verslag",
            clearData: "Maak Data Skoon",
            setPayment: "Stel Betaling",
            totalAmount: "Totale Bedrag",
            cashAmounts: "Kontant Bedrae (Kies of tik):",
            selectAmount: "Kies Bedrag",
            amount: "0.00",
            secondCard: "Tweede Kaart (R) - Opsioneel:",
            paidTogether: "Saam Betaal:",
            change: "Kleingeld:",
            insufficient: "ONVOLDOENDE!",
            stillNeeded: "Nog nodig: R",
            complete: "Voltooi",
            whoDoesThisBelong: "Aan wie behoort hierdie produk?",
            pleaseSelectName: "Kies asseblief eers 'n naam",
            pleaseEnterCode: "Voer asseblief 'n produk kode in",
            productBelongsTo: "Hierdie produk behoort aan ",
            changeNameOrProduct: ". Verander asseblief die naam of kies 'n ander produk.",
            productNotFound: "Produk met kode ",
            notFound: " nie gevind nie",
            firstFindProduct: "Vind asseblief eers 'n produk",
            cannotAdd: ". Kan nie by die mandjie voeg nie.",
            fillEverything: "Vul asseblief alles in",
            transactionComplete: "Transaksie suksesvol voltooi!",
            transactionNo: "Transaksie Nommer",
            productValue: "Produk Waarde",
            cashReceived: "Kontant Ontvang",
            cardReceived: "Kaart Ontvang",
            card2Received: "Tweede Kaart Ontvang",
            pdfLibraryError: "PDF biblioteek nie gelaai nie. Kontroleer asseblief jou internet verbinding.",
            noTransactionsDay: "Geen transaksies gevind vir hierdie dag",
            pdfGenerated: "PDF verslag suksesvol gegenereer!",
            pdfError: "Fout met genereer PDF: ",
            tryAgain: "Probeer asseblief weer.",
            noProductsDownload: "Geen produkte om af te laai",
            productsDownloaded: "Produkte suksesvol afgelaai!",
            noTransactionsDownload: "Geen transaksies om af te laai vir hierdie dag",
            reportDownloaded: "Verslag suksesvol afgelaai!",
            backupDownloaded: "Volledige rugsteun suksesvol afgelaai!",
            invalidBackup: "Ongeldige rugsteun l√™er formaat",
            backupFound: "Rugsteun data gevind",
            currentDataReplaced: "Alle huidige data sal vervang word. Gaan voort?",
            backupRestored: "Rugsteun suksesvol herstel!",
            errorReadingBackup: "Fout met lees van rugsteun l√™er: ",
            salesDataDownloaded: "Verkoopdata suksesvol afgelaai!",
            invalidProductFile: "Ongeldige produk l√™er formaat",
            errorReadingFile: "Fout met lees van l√™er: ",
            transactionsUploaded: "transaksies opgelaai vir datum",
            invalidReportFile: "Ongeldige verslag l√™er formaat",
            confirmClearData: "Is jy seker jy wil ALLE data skoonmaak? Dit kan nie ongedaan gemaak word nie!",
            dataCleared: "Alle data is skoongemaak",
            salesExported: "Verkoopdata suksesvol uitgevoer!",
            salesCopied: "Verkoopdata na knipbord gekopieer!",
            errorCopying: "Fout met kopi√´ring na knipbord: ",
            pleasePasteData: "Plak asseblief verkoopdata in die teks area",
            transactionsImported: "transaksies ingevoer vir datum",
            invalidDataFormat: "Ongeldige data formaat",
            errorReadingData: "Fout met lees van data: ",
            invalidFileFormat: "Ongeldige l√™er formaat",
            selectNameFirst: "Kies 'n naam hierbo om produkte te sien",
            noProducts: "Geen produkte beskikbaar",
            addProductsImport: "Voeg produkte by in die Produkte oortjie of voer in vanaf 'n l√™er",
            noProductsFound: "Geen produkte gevind",
            tryDifferentSearch: "Probeer 'n ander soek term",
            outOfStock: "Uit Voorraad",
            pleaseEnterCategory: "Voer asseblief 'n kategorie naam in",
            categoryExists: "Hierdie kategorie bestaan reeds",
            categoryAdded: "Kategorie bygevoeg: ",
            pleaseSelectOwner: "Kies asseblief 'n eienaar",
            fillNamePrice: "Vul asseblief naam en prys in",
            pleaseChooseCategory: "Kies asseblief 'n kategorie",
            codeExists: "Hierdie produk kode bestaan reeds",
            productSaved: "Produk suksesvol gestoor!",
            productUpdated: "Produk suksesvol opgedateer",
            editProduct: "Wysig Produk",
            updateProduct: "Opdateer Produk",
            confirmDelete: "Is jy seker jy wil hierdie produk verwyder?",
            remove: "Verwyder",
            page: "Bladsy",
            of: "van",
            pleaseEnterProductCode: "Voer asseblief 'n produk kode in",
            started: "begin",
            // New Translations
            dangerZone: "Gevaar Sone",
            clearAllData: "Maak ALLE Data Skoon",
            confirmClearAll: "Is jy REGTIG seker? Hierdie sal alle geskiedenis, produkte, en verkope vir ewig uitvee.",
            pastReports: "Vorige Verslae",
            selectSavedDate: "Kies Gestoorde Datum om te Sien:",
            selectDateDropdown: "-- Kies 'n Datum --",
            viewingReportFor: "Bekyk Verslag Vir:",
            newDayDetected: "Nuwe dag bespeur! \n\nWil jy die Verkope Verslag vir die laaste aktiewe dag aflaai",
            // Scanner Help
            scanHelpTitle: "Hoe om die Strepieskode Skandeerder te Gebruik",
            scanStep1Title: "1. Opstelling (Koppel Etikette)",
            step1: "Stap 1:",
            step2: "Stap 2:",
            step3: "Stap 3:",
            step4: "Stap 4:",
            step5: "Stap 5:",
            scanStep1_1: "Skep 'n etiket met jou etiketmaker. Gee dit 'n kodenommer (bv. 1005). Druk dit en plak dit op die item.",
            scanStep1_2: "Gaan na die Produkte Oortjie in hierdie toepassing.",
            scanStep1_3: "Vul die produkbesonderhede in (Naam, Prys, Eienaar).",
            scanStep1_4: "Klik binne die \"Produk Kode\" boks en SKANDEER die plakker. Die nommer (1005) sal outomaties verskyn.",
            scanStep1_5: "Klik Stoor Produk.",
            scanNote: "Die Kode op die Plakker MOET ooreenstem met die Kode in die Stelsel!",
            scanStep2Title: "2. Verkope (Die Aksie)",
            scanStep2_1: "Gaan na die Verkope Oortjie.",
            scanStep2_2: "SKANDEER eenvoudig die item met jou skandeerder.",
            scanStep2_3: "Die stelsel sal die produk vind (bv. \"Silwer Armband\") en die prys wys.",
            scanStep2_4: "Klik Voeg Produk By om dit in die mandjie te plaas.",
            gotIt: "Ek verstaan!",
            // Float Management Translations
            float: "Float",
            floatManagement: "Float Bestuur",
            currentFloat: "Huidige Float",
            floatAmount: "Float Bedrag",
            floatDescription: "R700.00 bly in die kas vir volgende dag se kleingeld",
            floatBreakdown: "Float Opsplitsing",
            adjustFloat: "Pas Float Bedrag aan:",
            updateFloat: "Opdateer Float Bedrag",
            setupDenominations: "Stel Float Denomasies Op",
            dailyCashReconciliation: "Daaglikse Kontant Versoening",
            selectDateForReconciliation: "Kies Datum vir Versoening:",
            cashReconciliation: "Kontant Versoening",
            totalCashSales: "Kontant Verkope",
            startingFloat: "Begin Float",
            totalInTill: "Totaal in Kas",
            floatToKeep: "Float om te Hou",
            cashToBank: "Kontant om te Bank",
            countDenominations: "Tel Werklike Kontant in Kas:",
            calculateCashToBank: "Bereken Kontant om te Bank",
            cashSales: "Kontant Verkope",
            expectedInTill: "Verwag in Kas",
            actualCashCount: "Werklike Kontant Telling",
            variance: "Variansie",
            saveReconciliation: "Stoor Versoening",
            reconciliationHistory: "Versoenings Geskiedenis",
            toBank: "Na Bank",
            setupFloatDenominations: "Stel Float Denomasies Op",
            setupFloatInstructions: "Voer in hoeveel van elke denomasie jy in jou R700.00 float wil h√™:",
            totalFloat: "Totaal Float",
            save: "Stoor",
            notes: "Note",
            coins: "Munte",
            over: "Oor",
            short: "Kort",
            correct: "Korrek",
            tip: "Wenk",
            clickAutoFill: 'Klik "Vul outomaties uit Transaksies"',
            toAddCash: 'om outomaties by te voeg',

    sales: "Verkope",
    products: "Produkte",
    report: "Verslag",
    float: "Kleingeld",
    transaction: "Transaksie",
    newTransaction: "Nuwe Transaksie",
    name: "Naam",
    selectName: "Kies Naam",
    both: "Albei",
    date: "Datum",
    time: "Tyd",
    today: "Vandag",
    now: "Nou",
    quantityManagement: "Hoeveelheid Bestuur",
    noQuantity: "Geen Hoeveelheid",
    withQuantity: "Met Hoeveelheid",
    availableQuantity: "Beskikbare Hoeveelheid",
    saleQuantity: "Verkoop Hoeveelheid",
    availableStock: "Beskikbare Voorraad",
    noItemAvailable: "Geen \"",
    noItemAvailableEnd: "\" Beskikbaar",
    productCode: "Produk Kode",
    enterProductCode: "Voer produk kode in",
    findProduct: "Soek Produk",
    product: "Produk",
    price: "Prys",
    owner: "Eienaar",
    category: "Kategorie",
    addProduct: "Voeg Produk By",
    productSelection: "Produk Keuse",
    searchProducts: "Soek produkte...",
    previous: "Vorige",
    next: "Volgende",
    manualAddition: "Handmatige Byvoeging",
    manualInput: "Handmatige Invoer",
    items: "Gekose Produkte",
    total: "TOTAAL",
    choosePaymentMethod: "Kies Betaal Metode",
    productManagement: "Produk Bestuur",
    categoryManagement: "Kategorie Bestuur",
    typeCategories: "Tik om kategorie√´ te sien of voeg nuwe een by",
    addCategory: "Voeg Kategorie By",
    newProduct: "Nuwe Produk",
    selectOwner: "Kies Eienaar",
    selectCategory: "Kies Kategorie",
    productName: "Produk naam",
    productCodeOptional: "Produk kode (opsioneel)",
    startingStock: "Begin Voorraad (los leeg vir onbeperk)",
    saveProduct: "Stoor Produk",
    cancel: "Kanselleer",
    allCategories: "Alle Kategorie√´",
    allOwners: "Alle Eienaars",
    code: "Kode",
    stock: "Voorraad",
    actions: "Aksies",
    dataManagement: "Data Bestuur",
    downloadCompleteBackup: "Laai Volledige Inligting Af",
    restoreCompleteBackup: "Herstel Volledige Inligting",
    downloadProductsOnly: "Laai Produkte + Kleingeld Af",
    importProductsOnly: "Herstel Produkte + Kleingeld",
    downloadSalesOnly: "Laai Slegs Verkope Af",
    importSalesOnly: "Herstel Slegs Verkope",
    dailyReport: "Daaglikse Verslag",
    pastReports: "Vorige Verslae",
    selectSavedDate: "Kies Gestoorde Datum:",
    selectDateDropdown: "-- Kies 'n Datum --",
    totalSales: "Totale Verkope",
    transactions: "Transaksies",
    viewingReportFor: "Bekyk Verslag Vir:",
    cash: "Kontant",
    card: "Kaart",
    dayTotal: "Dag Totaal",
    totalTransactions: "Totale transaksies",
    cashReconciliation: "Kontant Rekonsiliasie",
    totalCashSales: "Kontant Verkope",
    startingFloat: "Begin Kleingeld",
    totalInTill: "Totaal in Kas",
    floatToKeep: "Kleingeld om te Hou",
    cashToBank: "Kontant na Bank",
    countDenominations: "Tel Werklike Kontant in Kas:",
    calculateCashToBank: "Bereken Kontant na Bank",
    generatePDFReport: "Genereer PDF Verslag",
    dangerZone: "Gevaar Sone",
    clearAllData: "Vee ALLE Data Uit",
    floatManagement: "Kleingeld Bestuur",
    currentFloat: "Huidige Kleingeld",
    floatAmount: "Kleingeld Bedrag",
    floatDescription: "Bly in die kas vir volgende dag se kleingeld",
    floatBreakdown: "Kleingeld Uiteensetting",
    adjustFloat: "Pas Kleingeld Bedrag Aan:",
    updateFloat: "Werk Kleingeld By",
    setupDenominations: "Stel Kleingeld Denominasies Op",
    dailyCashReconciliation: "Daaglikse Kontant Rekonsiliasie",
    selectDateForReconciliation: "Kies Datum vir Rekonsiliasie:",
    cashSales: "Kontant Verkope",
    expectedInTill: "Verwag in Kas",
    actualCashCount: "Werklike Kontant Telling",
    variance: "Verskil",
    saveReconciliation: "Stoor Rekonsiliasie",
    reconciliationHistory: "Rekonsiliasie Geskiedenis",
    toBank: "Na Bank",
	  notes: "Note",
  coins: "Munte",
  enterCashReceived: "Voer Ontvangde Kontant In",
  enterCashReceivedDesc: "Voer die denomasies in wat van die kli√´nt ontvang is:",
  totalReceived: "Totaal Ontvang",
  giveChange: "Gee Kleingeld",
  changeToGive: "Kleingeld om te gee",
  specifyChangeDenoms: "Spesifiseer watter denomasies as kleingeld gegee word:",
  changeTotal: "Kleingeld Totaal",
  difference: "Verskil",
  saveChanges: "Stoor Veranderings",
  priceR: "Prys (R):",
  productCodeOptional: "Produk kode (opsioneel)",
  startingStockDesc: "Begin Voorraad (laat leeg vir onbeperk):",
  productNameLabel: "Produk Naam:",
  editTransactionTitle: "Wysig Transaksie",
  warningReverseCash: "Waarskuwing: Wysiging sal die oorspronklike kontantbewegings omkeer en nuwe toepas.",
  customerName: "Kli√´nt Naam",
  itemsLabel: "Items:",
  paymentMethod: "Betaal Metode:",
  cashOnly: "Slegs Kontant",
  cardOnly: "Slegs Kaart",
  mixedCashCard: "Gemeng (Kontant + Kaart)",
  cashAmount: "Kontant Bedrag:",
  cardAmount: "Kaart Bedrag:",
  secondCardOptional: "Tweede Kaart (Opsioneel):",
  totalLabel: "Totaal:",
  amountToBank: "Bedrag na Bank",
  currentTillTotal: "Huidige Kas Totaal",
  floatToKeepShort: "Kleingeld om te Hou",
  amount: "Bedrag",
  installApp: "Installeer App",
  editTransactionTitle: "Wysig Transaksie",
  warningReverseCash: "Waarskuwing: Wysiging sal die oorspronklike kontantbewegings omkeer en nuwe toepas.",
  customerName: "Kli√´nt Naam",
  itemsLabel: "Items:",
  paymentMethod: "Betaal Metode:",
  cashOnly: "Slegs Kontant",
  cardOnly: "Slegs Kaart",
  mixedCashCard: "Gemeng (Kontant + Kaart)",
  cashAmount: "Kontant Bedrag:",
  cardAmount: "Kaart Bedrag:",
  secondCardOptional: "Tweede Kaart (Opsioneel):",
  totalLabel: "Totaal:",
  saveChanges: "Stoor Veranderings"
  }
};
   
 
        var currentLanguage = 'en';

var cashReceivedDenominations = {
    'R200': { count: 0, value: 200 },
    'R100': { count: 0, value: 100 },
    'R50': { count: 0, value: 50 },
    'R20': { count: 0, value: 20 },
    'R10': { count: 0, value: 10 },
    'R5': { count: 0, value: 5 },
    'R2': { count: 0, value: 2 },
    'R1': { count: 0, value: 1 },
    '50c': { count: 0, value: 0.5 },
    '20c': { count: 0, value: 0.2 },
    '10c': { count: 0, value: 0.1 }
};

var changeGivenDenominations = {
    'R200': { count: 0, value: 200 },
    'R100': { count: 0, value: 100 },
    'R50': { count: 0, value: 50 },
    'R20': { count: 0, value: 20 },
    'R10': { count: 0, value: 10 },
    'R5': { count: 0, value: 5 },
    'R2': { count: 0, value: 2 },
    'R1': { count: 0, value: 1 },
    '50c': { count: 0, value: 0.5 },
    '20c': { count: 0, value: 0.2 },
    '10c': { count: 0, value: 0.1 }
};


var tillDenominations = {
    'R200': { count: 0, value: 200 },
    'R100': { count: 0, value: 100 },
    'R50': { count: 0, value: 50 },
    'R20': { count: 0, value: 20 },
    'R10': { count: 0, value: 10 },
    'R5': { count: 0, value: 5 },
    'R2': { count: 0, value: 2 },
    'R1': { count: 0, value: 1 },
    '50c': { count: 0, value: 0.5 },
    '20c': { count: 0, value: 0.2 },
    '10c': { count: 0, value: 0.1 }
};

function saveTillState() {
    localStorage.setItem('salesSystemTillState', JSON.stringify(tillDenominations));
}

function loadTillState() {
    var saved = localStorage.getItem('salesSystemTillState');
    if (saved) {
        try {
            tillDenominations = JSON.parse(saved);
        } catch (e) {
            console.error('Error loading till state:', e);
            initializeTillFromFloat();
        }
    } else {
        initializeTillFromFloat();
    }
}

function getTranslation(key) {
  const lang = window.currentLanguage || 'en';

  const enText = translations.en?.[key];
  let afText = translations.af?.[key];

  // Auto-insert missing Afrikaans keys
  if (enText && afText === undefined) {
    translations.af[key] = `${enText} (AF)`;
    afText = translations.af[key];
    window.missingTranslationKeys.add(key);
  }

  // Preferred language
  if (translations[lang]?.[key]) {
    return translations[lang][key];
  }

  // Bilingual fallback
  if (enText && afText) {
    return `${enText} | ${afText}`;
  }

  // Single fallback
  if (enText) return enText;
  if (afText) return afText;

  window.missingTranslationKeys.add(key);
  return `‚ü®${key}‚ü©`;
}












// Function to open cash denomination modal for payment
function openCashDenominationModal() {
    // Reset cash received denominations
    Object.keys(cashReceivedDenominations).forEach(key => {
        cashReceivedDenominations[key].count = 0;
    });
    
    // Create and show modal
    var modalHTML = `
        <div id="cashDenominationModal" class="modal active">
            <div class="modal-content">
                <div class="modal-title">Enter Cash Received</div>
                <p style="margin-bottom: 20px; color: #6b7280;">Enter the denominations you received from the customer:</p>
                
                <div id="cashDenominationInputs" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                    <!-- Will be filled by JavaScript -->
                </div>
                
                <div style="background: #f0fdf4; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; color: #374151;">Total Received:</span>
                        <span style="font-size: 24px; font-weight: bold; color: #16a34a;" id="cashReceivedTotalModal">R0.00</span>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="button" style="background: #6B7280; color: white;" onclick="closeCashDenominationModal()">Cancel</button>
                    <button class="button btn-green" onclick="saveCashDenomination()">Save</button>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to body
    var modalDiv = document.createElement('div');
    modalDiv.innerHTML = modalHTML;
    document.body.appendChild(modalDiv);
    
    // Render denomination inputs
    renderCashDenominationInputs();
}

// Function to render cash denomination inputs
function renderCashDenominationInputs() {
    var container = document.getElementById('cashDenominationInputs');
    if (!container) return;
    
    var html = '';
    
    // Notes Section
    html += '<div style="margin-bottom: 10px; font-weight: bold; color: #374151;">Notes</div>';
    var notes = ['R200', 'R100', 'R50', 'R20', 'R10'];
    notes.forEach(denom => {
        html += `
            <div class="denom-input-row">
                <div class="denom-label">${denom}:</div>
                <input type="number" class="denom-input" id="cash_received_${denom}" value="0" min="0" oninput="calculateCashReceivedTotal()">
                <div class="denom-subtotal" id="cash_received_subtotal_${denom}">R0.00</div>
            </div>
        `;
    });
    
    // Coins Section
    html += '<div style="margin-top: 15px; margin-bottom: 10px; font-weight: bold; color: #374151;">Coins</div>';
    var coins = ['R5', 'R2', 'R1', '50c', '20c', '10c'];
    coins.forEach(denom => {
        html += `
            <div class="denom-input-row">
                <div class="denom-label">${denom}:</div>
                <input type="number" class="denom-input" id="cash_received_${denom}" value="0" min="0" oninput="calculateCashReceivedTotal()">
                <div class="denom-subtotal" id="cash_received_subtotal_${denom}">R0.00</div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    calculateCashReceivedTotal();
}

// Function to calculate total cash received from denominations
function calculateCashReceivedTotal() {
    var total = 0;
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    allDenoms.forEach(denom => {
        var input = document.getElementById('cash_received_' + denom);
        if (input) {
            var count = parseInt(input.value) || 0;
            var value = cashReceivedDenominations[denom].value;
            var subtotal = count * value;
            total += subtotal;
            document.getElementById('cash_received_subtotal_' + denom).textContent = 'R' + subtotal.toFixed(2);
        }
    });
    
    document.getElementById('cashReceivedTotalModal').textContent = 'R' + total.toFixed(2);
    return total;
}

// Function to save cash denomination and update payment modal
function saveCashDenomination() {
    var total = calculateCashReceivedTotal();
    
    // Update cashReceivedDenominations object
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    allDenoms.forEach(denom => {
        var input = document.getElementById('cash_received_' + denom);
        if (input) {
            cashReceivedDenominations[denom].count = parseInt(input.value) || 0;
        }
    });
    
    // Update cash amount in payment modal
    document.getElementById('cashAmount').value = total.toFixed(2);
    
    // Close the modal
    closeCashDenominationModal();
    
    // Update payment modal to check if change is needed
    updatePaymentModal();
    
    // If cash received is more than total, open change denomination modal
    var modalTotal = parseFloat(document.getElementById('modalTotal').textContent);
    if (total > modalTotal) {
        setTimeout(function() {
            if (confirm('Cash received is more than total. Do you want to specify how to give change?')) {
                openChangeDenominationModal(modalTotal, total);
            }
        }, 500);
    }
}

// Function to open change denomination modal
function openChangeDenominationModal(totalDue, cashReceived) {
    var changeAmount = cashReceived - totalDue;
    
    // Reset change denominations
    Object.keys(changeGivenDenominations).forEach(key => {
        changeGivenDenominations[key].count = 0;
    });
    
    // Auto-fill change with optimal denominations
    var optimalChange = breakCashIntoDenominations(changeAmount);
    Object.keys(optimalChange).forEach(key => {
        if (changeGivenDenominations[key]) {
            changeGivenDenominations[key].count = optimalChange[key];
        }
    });
    
    var modalHTML = `
        <div id="changeDenominationModal" class="modal active">
            <div class="modal-content">
                <div class="modal-title">Give Change</div>
                <p style="margin-bottom: 20px; color: #6b7280;">
                    Change to give: <strong style="color: #ea580c; font-size: 18px;">R${changeAmount.toFixed(2)}</strong><br>
                    Specify which denominations to give as change:
                </p>
                
                <div id="changeDenominationInputs" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                    <!-- Will be filled by JavaScript -->
                </div>
                
                <div style="background: #fffbeb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; color: #374151;">Change Total:</span>
                        <span style="font-size: 24px; font-weight: bold; color: #ea580c;" id="changeGivenTotalModal">R${changeAmount.toFixed(2)}</span>
                    </div>
                    <div id="changeVarianceMessage" style="text-align: center; margin-top: 10px; font-size: 14px;"></div>
                </div>
                
                <div class="modal-buttons">
                    <button class="button" style="background: #6B7280; color: white;" onclick="closeChangeDenominationModal()">Cancel</button>
                    <button class="button btn-green" onclick="saveChangeDenomination(${changeAmount})">Save</button>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to body
    var modalDiv = document.createElement('div');
    modalDiv.innerHTML = modalHTML;
    document.body.appendChild(modalDiv);
    
    // Render denomination inputs
    renderChangeDenominationInputs();
}

// Function to render change denomination inputs
function renderChangeDenominationInputs() {
    var container = document.getElementById('changeDenominationInputs');
    if (!container) return;
    
    var html = '';
    
    // Notes Section
    html += '<div style="margin-bottom: 10px; font-weight: bold; color: #374151;">Notes</div>';
    var notes = ['R200', 'R100', 'R50', 'R20', 'R10'];
    notes.forEach(denom => {
        html += `
            <div class="denom-input-row">
                <div class="denom-label">${denom}:</div>
                <input type="number" class="denom-input" id="change_given_${denom}" value="${changeGivenDenominations[denom].count}" min="0" oninput="calculateChangeGivenTotal()">
                <div class="denom-subtotal" id="change_given_subtotal_${denom}">R0.00</div>
            </div>
        `;
    });
    
    // Coins Section
    html += '<div style="margin-top: 15px; margin-bottom: 10px; font-weight: bold; color: #374151;">Coins</div>';
    var coins = ['R5', 'R2', 'R1', '50c', '20c', '10c'];
    coins.forEach(denom => {
        html += `
            <div class="denom-input-row">
                <div class="denom-label">${denom}:</div>
                <input type="number" class="denom-input" id="change_given_${denom}" value="${changeGivenDenominations[denom].count}" min="0" oninput="calculateChangeGivenTotal()">
                <div class="denom-subtotal" id="change_given_subtotal_${denom}">R0.00</div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    calculateChangeGivenTotal();
}

// Function to calculate total change given from denominations
function calculateChangeGivenTotal() {
    var total = 0;
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    allDenoms.forEach(denom => {
        var input = document.getElementById('change_given_' + denom);
        if (input) {
            var count = parseInt(input.value) || 0;
            var value = changeGivenDenominations[denom].value;
            var subtotal = count * value;
            total += subtotal;
            document.getElementById('change_given_subtotal_' + denom).textContent = 'R' + subtotal.toFixed(2);
        }
    });
    
    document.getElementById('changeGivenTotalModal').textContent = 'R' + total.toFixed(2);
    return total;
}

// Function to save change denomination
function saveChangeDenomination(expectedChange) {
    var actualChange = calculateChangeGivenTotal();
    var variance = actualChange - expectedChange;
    
    // Check if change matches expected
    if (Math.abs(variance) > 0.01) {
        if (!confirm(`Change total (R${actualChange.toFixed(2)}) doesn't match expected change (R${expectedChange.toFixed(2)}). Difference: R${Math.abs(variance).toFixed(2)}. Save anyway?`)) {
            return;
        }
    }
    
    // Update changeGivenDenominations object
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    allDenoms.forEach(denom => {
        var input = document.getElementById('change_given_' + denom);
        if (input) {
            changeGivenDenominations[denom].count = parseInt(input.value) || 0;
        }
    });
    
    // Close the modal
    closeChangeDenominationModal();
    
    // Update payment modal to show correct change
    updatePaymentModal();
}

// Function to close cash denomination modal
function closeCashDenominationModal() {
    var modal = document.getElementById('cashDenominationModal');
    if (modal) {
        modal.remove();
    }
}

// Function to close change denomination modal
function closeChangeDenominationModal() {
    var modal = document.getElementById('changeDenominationModal');
    if (modal) {
        modal.remove();
    }
}



        var purchasedItems = [],
          allTransactions = [],
          allProducts = [],
          currentQuantity = 1,
          currentProduct = null,
          currentTransactionNumber = 1;
        var editingProductIndex = -1,
          currentPage = 1,
          itemsPerPage = 10,
          filteredProducts = [];
        var allCategories = ['Balls', 'Knives', 'Puzzles', 'Games', 'Board Games', 'Polstized Sunglasses', 'Sunglasses', 'Caps', 'Bucket Hats', 'Silver Stainless Steel Bangles', 'Golden Stainless Steel Bangles', 'Other'];
        var pendingItem = null,
          pendingItemType = '',
          quantityMode = 'none',
          productQuantities = {};
        var salesCurrentPage = 1,
          salesItemsPerPage = 10,
          filteredSalesProducts = [],
          salesSearchTerm = '';
        
        // Float Management Variables
        var floatAmount = 700.00;
        var floatDenominations = {
            // Notes
            'R200': { count: 0, value: 200 },
            'R100': { count: 0, value: 100 },
            'R50': { count: 0, value: 50 },
            'R20': { count: 0, value: 20 },
            'R10': { count: 0, value: 10 },
            // Coins
            'R5': { count: 0, value: 5 },
            'R2': { count: 0, value: 2 },
            'R1': { count: 0, value: 1 },
            '50c': { count: 0, value: 0.5 },
            '20c': { count: 0, value: 0.2 },
            '10c': { count: 0, value: 0.1 }
        };
        var dailyReconciliations = [];

        // Initialize with today's date
        var today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        document.getElementById('time').value = new Date().toTimeString().slice(0, 5);
        document.getElementById('daySelect').value = today;
        document.getElementById('name').value = '';
        document.getElementById('reconciliationDate').value = today;

        document.addEventListener('DOMContentLoaded', function () {
          const tabButtons = document.querySelectorAll('.tab-btn');
          tabButtons.forEach(button => {
            button.addEventListener('click', function () {
              const tabId = this.getAttribute('data-tab');
              switchTab(tabId);
            });
          });
          loadData();
          loadCategories();
          loadQuantityData();
          loadLanguage();
          filteredProducts = [...allProducts];
          renderProductsTable();
          updateProductList();
          
          // Load Float Data
          loadFloatData();
          loadCompressionLibrary();
          renderFloatBreakdown();
          startAutoSave();
          // NEW: Auto Save/Prompt Check
          checkForPreviousDay();
          updateReportHistoryDropdown();
          
          // Initialize report with today's data
          updateReport();
          checkUrlParams();	  
        
          // NEW: Auto-focus on scanner input for mobile
            setTimeout(() => {
                if (window.innerWidth < 768) {
                    document.getElementById('productCode').focus();
                }
            }, 500);
            
            // NEW: Register service worker
          });
        
        // Load saved language preference
        function loadLanguage() {
            var savedLang = localStorage.getItem('salesSystemLanguage');
            if (savedLang) {
                setLanguage(savedLang);
            }
        }

function applyTranslations() {
  document.querySelectorAll('[data-translate]').forEach(el => {
    const key = el.getAttribute('data-translate');
    el.textContent = getTranslation(key);
  });

  document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
    const key = el.getAttribute('data-translate-placeholder');
    el.placeholder = getTranslation(key);
  });

  logMissingTranslations();
}


function logMissingTranslations() {
  if (!window.missingTranslationKeys.size) return;

  console.groupCollapsed('Missing translations (auto-filled)');
  [...window.missingTranslationKeys].sort().forEach(k => console.warn(k));
  console.groupEnd();
}

window.missingTranslationKeys ??= new Set();

function getTranslation(key) {
  const lang = currentLanguage || 'en';

  const enText = translations.en?.[key];
  let afText = translations.af?.[key];

  // Auto-insert missing Afrikaans key
  if (enText && afText === undefined) {
    translations.af[key] = enText + " (AF)";
    afText = translations.af[key];
    missingTranslationKeys.add(key);
  }

  // Preferred language exists
  if (translations[lang]?.[key]) {
    return translations[lang][key];
  }

  // Bilingual fallback
  if (enText && afText) {
    return `${enText} | ${afText}`;
  }

  // English only
  if (enText) {
    missingTranslationKeys.add(key);
    return enText;
  }

  // Afrikaans only
  if (afText) {
    missingTranslationKeys.add(key);
    return afText;
  }

  // Completely missing
  missingTranslationKeys.add(key);
  return `‚ü®${key}‚ü©`;
}

function exportAutoGeneratedAfrikaans() {
  const generated = {};

  missingTranslationKeys.forEach(key => {
    if (translations.af[key]?.endsWith('(AF)')) {
      generated[key] = translations.af[key];
    }
  });

  console.log(
    'Auto-generated Afrikaans translations:',
    JSON.stringify(generated, null, 2)
  );

  return generated;
}


 function loadData() {
    try {
        var saved = localStorage.getItem('salesSystemData');
        if (saved) allTransactions = JSON.parse(saved);
        
        var savedProducts = localStorage.getItem('salesSystemProducts');
        if (savedProducts) allProducts = JSON.parse(savedProducts);
        
        var savedCategories = localStorage.getItem('salesSystemCategories');
        if (savedCategories) allCategories = JSON.parse(savedCategories);
        
        var savedNumber = localStorage.getItem('salesSystemTransactionNumber');
        if (savedNumber) currentTransactionNumber = parseInt(savedNumber);
        
        var savedQuantities = localStorage.getItem('salesSystemQuantities');
        if (savedQuantities) productQuantities = JSON.parse(savedQuantities);
        
        loadFloatData();
        
        // CRITICAL: Load till state
        loadTillState();
        
        var savedReconciliations = localStorage.getItem('salesSystemReconciliations');
        if (savedReconciliations) dailyReconciliations = JSON.parse(savedReconciliations);
        
        // NEW: Check for new day and prompt to clear if needed
        checkForNewDay();
    } catch (error) {
        console.error('Error loading data:', error);
        alert('Error loading data. Starting fresh.');
    }
    
    updateTransactionNumberDisplay();
    updateStats();
    renderReconciliationHistory();
}

function getCurrentTillTotal() {
    var total = 0;
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    allDenoms.forEach(denom => {
        total += tillDenominations[denom].count * tillDenominations[denom].value;
    });
    
    return total;
}


 function setLanguage(lang) {
  currentLanguage = lang;

  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.classList.remove('active');
    btn.classList.add('inactive');
  });

  document
    .querySelector(`.lang-btn[onclick="setLanguage('${lang}')"]`)
    ?.classList.add('active');

  applyTranslations();
}

function loadCompressionLibrary() {
    if (typeof LZString === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js';
        script.onload = () => {
            console.log('Compression library loaded');
            // Create initial compressed backup
            setTimeout(() => {
                const consolidatedData = {
                    exportType: 'complete_backup',
                    timestamp: new Date().toISOString(),
                    products: allProducts,
                    categories: allCategories,
                    transactions: allTransactions,
                    quantities: productQuantities,
                    transactionNumber: currentTransactionNumber,
                    floatAmount: floatAmount,
                    floatDenominations: floatDenominations,
                    reconciliations: dailyReconciliations
                };
                const compressedData = LZString.compressToUTF16(JSON.stringify(consolidatedData));
                localStorage.setItem('salesSystemCompressedBackup', compressedData);
            }, 1000);
        };
        document.head.appendChild(script);
    }
}        
        
function loadFloatData() {
    var savedFloat = localStorage.getItem('salesSystemFloat');
    if (savedFloat) try {
        var floatData = JSON.parse(savedFloat);
        floatAmount = floatData.amount || 700.00;
        floatDenominations = floatData.denominations || {
            'R200': { count: 0, value: 200 },
            'R100': { count: 0, value: 100 },
            'R50': { count: 0, value: 50 },
            'R20': { count: 0, value: 20 },
            'R10': { count: 0, value: 10 },
            'R5': { count: 0, value: 5 },
            'R2': { count: 0, value: 2 },
            'R1': { count: 0, value: 1 },
            '50c': { count: 0, value: 0.5 },
            '20c': { count: 0, value: 0.2 },
            '10c': { count: 0, value: 0.1 }
        };
    } catch (e) {
        floatAmount = 700.00;
    }
    document.getElementById('floatTotalAmount').textContent = 'R ' + floatAmount.toFixed(2);
    document.getElementById('newFloatAmount').value = floatAmount.toFixed(2);
}
        
        function saveFloatData() {
            var floatData = {
                amount: floatAmount,
                denominations: floatDenominations
            };
            localStorage.setItem('salesSystemFloat', JSON.stringify(floatData));
        }
        
        function saveReconciliations() {
            localStorage.setItem('salesSystemReconciliations', JSON.stringify(dailyReconciliations));
        }
        
        // --- NEW AUTO SAVE / NEW DAY LOGIC ---
        
        function checkForPreviousDay() {
            if(allTransactions.length === 0) return;
            
            // Get unique dates in DB
            const dates = [...new Set(allTransactions.map(t => t.date))].sort();
            if(dates.length === 0) return;
            
            const lastDate = dates[dates.length - 1];
            const today = new Date().toISOString().split('T')[0];
            
            // If the last date in the DB is NOT today, it means we have opened the app on a new day.
            // Check if we have already "viewed" or "downloaded" it? 
            // Simplified: Just prompt if it's not today.
            
            if (lastDate !== today) {
                // Ensure the interface starts clean for Today
                setToday(); 
                
                // Prompt user
                const confirmDownload = confirm(translations[currentLanguage]['newDayDetected'] + " (" + lastDate + ")?");
                if(confirmDownload) {
                    // Temporarily set daySelect to lastDate to generate PDF, then swap back
                    document.getElementById('daySelect').value = lastDate;
                    generatePDF(lastDate); // Generate PDF for that specific date
                    document.getElementById('daySelect').value = today; // Reset to today
                }
            }
        }
        
        function updateReportHistoryDropdown() {
            const dates = [...new Set(allTransactions.map(t => t.date))].sort().reverse();
            const dropdown = document.getElementById('reportHistoryDropdown');
            
            // Keep first option
            dropdown.innerHTML = '<option value="">' + translations[currentLanguage]['selectDateDropdown'] + '</option>';
            
            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                dropdown.appendChild(option);
            });
        }
 
// ========== QUICK INFO MODAL ==========
function openQuickInfoModal() {
  var html = `
    <div id="quickInfoModal" class="modal active">
      <div class="modal-content">
        <div class="modal-title">Quick Add</div>

        <!-- Owner -->
        <div class="form-group">
          <label>Owner:</label>
          <select id="quickItemOwner">
		  <option value="Both">Both</option>
             <option value="Francois">Francois</option>
		 <option value="Kotie">Kotie</option>
            
          </select>
        </div>

        <!-- Category with autocomplete -->
        <div class="form-group">
          <label>Category:</label>
          <div class="autocomplete">
            <input type="text" id="quickItemCategory" placeholder="Type to select category" oninput="showQuickCategoryDropdown()">
            <div id="quickCategoryAutocompleteList" class="autocomplete-items"></div>
          </div>
        </div>

        <!-- Product Name -->
        <div class="form-group">
          <label>Product Name:</label>
          <input type="text" id="quickItemName" placeholder="Enter item name">
        </div>

        <!-- Price -->
        <div class="form-group">
          <label>Price (R):</label>
          <input type="number" id="quickItemPrice" placeholder="0.00" step="0.01" min="0">
        </div>

        <!-- Product Code (optional) -->
        <div class="form-group">
          <label>Product Code (optional):</label>
          <input type="text" id="quickItemCode" placeholder="Product code">
        </div>

        <!-- Starting Stock -->
        <div class="form-group">
          <label>Starting Stock (leave empty for unlimited):</label>
          <input type="number" id="quickItemQuantity" placeholder="" min="0">
        </div>

        <div class="modal-buttons">
          <button class="button" style="background: #6B7280; color: white;" onclick="closeQuickInfoModal()">Cancel</button>
          <button class="button btn-green" onclick="saveQuickInfo()">Save & Add</button>
        </div>
      </div>
    </div>
  `;

  var modalDiv = document.createElement('div');
  modalDiv.innerHTML = html;
  document.body.appendChild(modalDiv);
}

function showProductCategoryDropdown() {
    var val = document.getElementById("newProductCategory").value.toUpperCase();
    var list = document.getElementById("productCategoryAutocompleteList");
    list.innerHTML = '';
    if (!val) return;
    
    allCategories.forEach(c => {
        if (c.toUpperCase().includes(val)) {
            var div = document.createElement("div");
            div.innerHTML = c;
            div.innerHTML += "<input type='hidden' value='" + c + "'>";
            div.addEventListener("click", function () {
                document.getElementById("newProductCategory").value = this.getElementsByTagName("input")[0].value;
                list.innerHTML = '';
            });
            list.appendChild(div);
        }
    });
}



function showQuickCategoryDropdown() {
    var val = document.getElementById("quickItemCategory").value.toUpperCase();
    var list = document.getElementById("quickCategoryAutocompleteList");
    if (!list) return;
    
    list.innerHTML = '';
    if (!val) return;
    
    allCategories.forEach(c => {
        if (c.toUpperCase().includes(val)) {
            var div = document.createElement("div");
            div.innerHTML = c;
            div.innerHTML += "<input type='hidden' value='" + c + "'>";
            div.addEventListener("click", function () {
                document.getElementById("quickItemCategory").value = this.getElementsByTagName("input")[0].value;
                list.innerHTML = '';
            });
            list.appendChild(div);
        }
    });
}


function saveQuickInfo() {
  var name = (document.getElementById('quickItemName').value || '').trim();
  var price = parseFloat(document.getElementById('quickItemPrice').value);
  var owner = document.getElementById('quickItemOwner').value;
  var category = (document.getElementById('quickItemCategory').value || '').trim();
  var code = (document.getElementById('quickItemCode').value || '').trim();
  var startQtyRaw = document.getElementById('quickItemQuantity').value;
  var startQty = startQtyRaw === '' ? null : Math.max(0, parseInt(startQtyRaw, 10) || 0);

  if (!name || isNaN(price)) {
    alert("Please enter item name and price");
    return;
  }

  // Ensure category in list
  if (category && !allCategories.includes(category)) {
    allCategories.push(category);
    saveCategories();
    updateCategorySelects();
  }

  // Build product
  var newProduct = {
    id: Date.now(),
    code: code || null,
    name: name,
    price: price,
    owner: owner,
    category: category || "Other",
    quantity: startQty || 0
  };

  // Add to products
  allProducts.push(newProduct);
  saveProducts();

  // If starting stock provided (> 0), store it into productQuantities
  if (startQty && startQty > 0) {
    var key = (newProduct.code) ? newProduct.code : newProduct.id.toString();
    productQuantities[key] = startQty;
    saveQuantityData();
  }

  // If we're on Sales tab, attempt to add to cart if owner matches selection
  var currentTab = document.querySelector('.tab-content.active').id;
  if (currentTab === 'sales') {
    var currentName = document.getElementById('name').value;
    if (currentName && (currentName === owner || currentName === 'Both' || owner === 'Both')) {
      addProductToCart(name, price, 1, currentName, (newProduct.code ? newProduct.code : newProduct.id.toString()));
    } else {
      alert("Product owner doesn't match selected name. Please change the name or select a different owner.");
    }
  }

  alert("Product saved successfully!");
  closeQuickInfoModal();

  // Update lists
  updateProductList();
  filteredProducts = [...allProducts];
  renderProductsTable();
}


function closeQuickInfoModal() {
    var modal = document.getElementById('quickInfoModal');
    if (modal) {
        // Clear any autocomplete dropdowns before removing
        var lists = ['quickCategoryAutocompleteList'];
        lists.forEach(id => {
            var list = document.getElementById(id);
            if (list) list.innerHTML = '';
        });
        modal.remove();
    }
}

// ========== HOME SCREEN INSTALL PROMPT ==========
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    // Prevent Chrome 67 and earlier from automatically showing the prompt
    e.preventDefault();
    // Stash the event so it can be triggered later
    deferredPrompt = e;
    // Show install button (optional)
    showInstallPromotion();
});

function showInstallPromotion() {
    // You can show a custom button to install the app
    if (deferredPrompt) {
        var installBtn = document.createElement('button');
        installBtn.className = 'button btn-purple';
        installBtn.innerHTML = 'üì± Install App';
        installBtn.style.position = 'fixed';
        installBtn.style.bottom = '20px';
        installBtn.style.right = '20px';
        installBtn.style.zIndex = '1000';
        installBtn.onclick = installApp;
        document.body.appendChild(installBtn);
    }
}

function installApp() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                console.log('User accepted the install prompt');
            } else {
                console.log('User dismissed the install prompt');
            }
            deferredPrompt = null;
        });
    }
}
/* TEST CUT */
// ========== URL PARAMETER HANDLING ==========
function checkUrlParams() {
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab');
    if (tab && ['sales', 'products', 'report', 'float'].includes(tab)) {
        switchTab(tab);
    }
} 
 
function breakCashIntoDenominations(amount) {
    const denominations = [
        { key: 'R200', value: 200 },
        { key: 'R100', value: 100 },
        { key: 'R50', value: 50 },
        { key: 'R20', value: 20 },
        { key: 'R10', value: 10 },
        { key: 'R5', value: 5 },
        { key: 'R2', value: 2 },
        { key: 'R1', value: 1 },
        { key: '50c', value: 0.5 },
        { key: '20c', value: 0.2 },
        { key: '10c', value: 0.1 }
    ];
    
    let remaining = amount;
    const result = {};
    
    // Initialize with 0 for all denominations
    denominations.forEach(d => result[d.key] = 0);
    
    // Greedy algorithm to break down the amount
    denominations.forEach(d => {
        if (remaining >= d.value) {
            const count = Math.floor(remaining / d.value);
            result[d.key] = count;
            remaining = remaining - (count * d.value);
            // Round to avoid floating point errors
            remaining = Math.round(remaining * 100) / 100;
        }
    });
    
    return result;
}

function renderReportDenominationInputs(date, existingRecon = null) {
    var container = document.getElementById('denominationInputsContainer');
    if (!container) return;
    
    var html = '';
    
    // Use current till state as the expected count
    var expectedCounts = existingRecon ? existingRecon.actualCount : tillDenominations;
    
    // Notes Section
    html += '<div style="margin-bottom: 10px; font-weight: bold; color: #374151;">Notes</div>';
    var notes = ['R200', 'R100', 'R50', 'R20', 'R10'];
    notes.forEach(denom => {
        var count = expectedCounts[denom] ? expectedCounts[denom].count : tillDenominations[denom].count;
        var value = tillDenominations[denom].value;
        var subtotal = count * value;
        html += `
            <div class="denom-input-row">
                <div class="denom-label">${denom}:</div>
                <input type="number" class="denom-input" id="report_${denom}" value="${count}" min="0" oninput="calculateReportCashToBank()">
                <div class="denom-subtotal" id="report_subtotal_${denom}">R${subtotal.toFixed(2)}</div>
            </div>
        `;
    });
    
    // Coins Section
    html += '<div style="margin-top: 15px; margin-bottom: 10px; font-weight: bold; color: #374151;">Coins</div>';
    var coins = ['R5', 'R2', 'R1', '50c', '20c', '10c'];
    coins.forEach(denom => {
        var count = expectedCounts[denom] ? expectedCounts[denom].count : tillDenominations[denom].count;
        var value = tillDenominations[denom].value;
        var subtotal = count * value;
        html += `
            <div class="denom-input-row">
                <div class="denom-label">${denom}:</div>
                <input type="number" class="denom-input" id="report_${denom}" value="${count}" min="0" oninput="calculateReportCashToBank()">
                <div class="denom-subtotal" id="report_subtotal_${denom}">R${subtotal.toFixed(2)}</div>
            </div>
        `;
    });
    
    // Show tracking info
    var totalCashSales = 0;
    var dayTransactions = allTransactions.filter(t => t.date === date);
    dayTransactions.forEach(t => {
        totalCashSales += t.cashAmount || 0;
    });
    
    if (totalCashSales > 0) {
        html += `
            <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 10px; margin-top: 15px; font-size: 12px; color: #374151;">
                <strong>üí° Denomination Tracking Active</strong><br>
                ‚Ä¢ Starting Float: R${floatAmount.toFixed(2)}<br>
                ‚Ä¢ Cash Sales Today: R${totalCashSales.toFixed(2)}<br>
                ‚Ä¢ Expected counts shown above include all cash received and change given<br>
                <em>These counts represent what should physically be in your till right now</em>
            </div>
        `;
    }
    
    container.innerHTML = html;
    calculateReportCashToBank();
}





function autoFillCashFromTransactions() {
    var date = document.getElementById('daySelect').value;
    if (!date) return;
    
    // Calculate total cash sales for this date from transactions
    var dayTransactions = allTransactions.filter(t => t.date === date);
    var cashSalesAmount = 0;
    dayTransactions.forEach(t => {
        cashSalesAmount += t.cashAmount || 0;
    });
    
    if (cashSalesAmount <= 0) {
        alert("No cash sales found for this date.");
        return;
    }
    
    // Break down cash sales into denominations
    var cashSalesBreakdown = breakCashIntoDenominations(cashSalesAmount);
    
    // Update all denomination inputs
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    allDenoms.forEach(denom => {
        var input = document.getElementById('report_' + denom);
        if (input) {
            var floatCount = floatDenominations[denom].count || 0;
            var cashSalesCount = cashSalesBreakdown[denom] || 0;
            input.value = floatCount + cashSalesCount;
        }
    });
    
    // Recalculate
    calculateReportCashToBank();
    
    alert("Auto-filled cash from transactions: R" + cashSalesAmount.toFixed(2));
}

function resetToFloatOnly() {
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    allDenoms.forEach(denom => {
        var input = document.getElementById('report_' + denom);
        if (input) {
            input.value = floatDenominations[denom].count || 0;
        }
    });
    
    // Recalculate
    calculateReportCashToBank();
    
    alert("Reset to float amounts only.");
}

function calculateReportCashToBank() {
    var actualTotal = 0;
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    allDenoms.forEach(denom => {
        var input = document.getElementById('report_' + denom);
        if (input) {
            var count = parseInt(input.value) || 0;
            var value = tillDenominations[denom].value;
            var subtotal = count * value;
            actualTotal += subtotal;
            document.getElementById('report_subtotal_' + denom).textContent = 'R' + subtotal.toFixed(2);
        }
    });
    
    // Calculate expected total (float + cash sales)
    var cashSales = parseFloat(document.getElementById('reportCashSales').textContent.replace('R', ''));
    var expectedInTill = floatAmount + cashSales;
    
    var variance = actualTotal - expectedInTill;
    var actualCashToBank = actualTotal - floatAmount;
    
    // Update display
    var cashToBankElement = document.getElementById('cashToBankAmount');
    if (cashToBankElement) {
        if (Math.abs(variance) > 0.01) {
            var varianceText = variance > 0 ? 'Over' : 'Short';
            var varianceColor = variance > 0 ? '#16a34a' : '#dc2626';
            cashToBankElement.innerHTML = `R${actualCashToBank.toFixed(2)} <span style="font-size: 14px; color: ${varianceColor};">(${variance > 0 ? '+' : ''}R${Math.abs(variance).toFixed(2)} ${varianceText})</span>`;
        } else {
            cashToBankElement.textContent = 'R' + actualCashToBank.toFixed(2);
        }
    }
}

 
        function loadReportFromHistory() {
            const selectedDate = document.getElementById('reportHistoryDropdown').value;
            if(selectedDate) {
                document.getElementById('daySelect').value = selectedDate;
                updateReport();
            }
        }
        
        // --- END NEW LOGIC ---

        function saveTransactionNumber() {
          localStorage.setItem('salesSystemTransactionNumber', currentTransactionNumber.toString());
        }

function updateTransactionNumberDisplay() {
  var el = document.getElementById('currentTransactionNumber');
  if (el) {
    el.textContent = currentTransactionNumber.toString().padStart(6, '0');
  }
}

        function saveData() {
          localStorage.setItem('salesSystemData', JSON.stringify(allTransactions));
          // Update history dropdown whenever data changes
          updateReportHistoryDropdown();
        }

        function saveProducts() {
          localStorage.setItem('salesSystemProducts', JSON.stringify(allProducts));
        }

        function switchTab(tab) {
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active');
            b.classList.add('inactive');
          });
          document.getElementById(tab).classList.add('active');
          document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('active');
          document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.remove('inactive');
          if (tab === 'report') {
              updateReport();
              // Re-apply language to dropdown
              const dropdown = document.getElementById('reportHistoryDropdown');
              if (dropdown && dropdown.options.length > 0) {
                  dropdown.options[0].text = translations[currentLanguage]['selectDateDropdown'];
              }
          }
          if (tab === 'products') {
            filteredProducts = [...allProducts];
            renderProductsTable();
            updateCategorySelects();
          }
          if (tab === 'sales') {
            // Auto focus for scanner
            setTimeout(() => document.getElementById('productCode').focus(), 300);
          }
          if (tab === 'float') {
              renderFloatBreakdown();
              renderReconciliationHistory();
          }
        }

        // ========== FLOAT MANAGEMENT FUNCTIONS ==========
        
function renderFloatBreakdown() {
    var breakdownHtml = '';
    var totalCalculated = getCurrentTillTotal();
    
    // Notes Section
    breakdownHtml += '<div style="grid-column: 1 / -1; font-weight: bold; color: #374151; margin-bottom: 5px;">Notes</div>';
    var notes = ['R200', 'R100', 'R50', 'R20', 'R10'];
    notes.forEach(denom => {
        var denomData = tillDenominations[denom];
        var subtotal = denomData.count * denomData.value;
        breakdownHtml += `
            <div class="float-denomination">
                <div class="denom-value">${denom}</div>
                <div class="denom-count">${denomData.count}</div>
                <div class="denom-total">R ${subtotal.toFixed(2)}</div>
            </div>
        `;
    });
    
    // Coins Section
    breakdownHtml += '<div style="grid-column: 1 / -1; font-weight: bold; color: #374151; margin-top: 10px; margin-bottom: 5px;">Coins</div>';
    var coins = ['R5', 'R2', 'R1', '50c', '20c', '10c'];
    coins.forEach(denom => {
        var denomData = tillDenominations[denom];
        var subtotal = denomData.count * denomData.value;
        breakdownHtml += `
            <div class="float-denomination">
                <div class="denom-value">${denom}</div>
                <div class="denom-count">${denomData.count}</div>
                <div class="denom-total">R ${subtotal.toFixed(2)}</div>
            </div>
        `;
    });
    
    document.getElementById('floatBreakdown').innerHTML = breakdownHtml;
    
    // Calculate amount to bank (till total minus float amount)
    var amountToBank = totalCalculated - floatAmount;
    
    // Update the float summary section with all three amounts
    document.getElementById('floatTotalAmount').innerHTML = 
        '<div style="margin-bottom: 10px;">' +
        '<div style="font-size: 12px; color: #6b7280;">Current Till Total</div>' +
        '<div style="font-size: 24px; font-weight: bold; color: #ea580c;">R ' + totalCalculated.toFixed(2) + '</div>' +
        '</div>' +
        '<div style="margin-bottom: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;">' +
        '<div style="font-size: 12px; color: #6b7280;">Float Amount (to keep)</div>' +
        '<div style="font-size: 20px; font-weight: bold; color: #f59e0b;">R ' + floatAmount.toFixed(2) + '</div>' +
        '</div>' +
        '<div style="padding-top: 10px; border-top: 2px solid #22c55e;">' +
        '<div style="font-size: 12px; color: #6b7280;">Amount to Bank</div>' +
        '<div style="font-size: 20px; font-weight: bold; color: #16a34a;">R ' + amountToBank.toFixed(2) + '</div>' +
        '</div>';
}




function initializeTillFromFloat() {
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    allDenoms.forEach(denom => {
        tillDenominations[denom].count = floatDenominations[denom].count;
    });
    
    saveTillState();
}    




function openEditTransactionModal(transaction, transactionIndex) {
    // First close any existing modal
    closeEditTransactionModal();
    
    // Get current translations
    const t = {
        editTransactionTitle: getTranslation('editTransactionTitle'),
        warningReverseCash: getTranslation('warningReverseCash'),
        date: getTranslation('date'),
        time: getTranslation('time'),
        customerName: getTranslation('customerName'),
        both: getTranslation('both'),
        itemsLabel: getTranslation('itemsLabel'),
        paymentMethod: getTranslation('paymentMethod'),
        cashOnly: getTranslation('cashOnly'),
        cardOnly: getTranslation('cardOnly'),
        mixedCashCard: getTranslation('mixedCashCard'),
        cashAmount: getTranslation('cashAmount'),
        cardAmount: getTranslation('cardAmount'),
        secondCardOptional: getTranslation('secondCardOptional'),
        totalLabel: getTranslation('totalLabel'),
        cancel: getTranslation('cancel'),
        saveChanges: getTranslation('saveChanges')
    };
    
    // Create modal HTML with translations
    const modalHTML = `
<div id="editTransactionModal" class="modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
  <div style="background: white; border-radius: 8px; padding: 20px; width: 90%; max-width: 500px; max-height: 90%; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0;">${t.editTransactionTitle} #${transaction.transactionNumber}</h3>
      <button onclick="closeEditTransactionModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
    </div>

    <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 20px;">
      <strong>‚ö†Ô∏è ${t.warningReverseCash}</strong>
    </div>

    <div class="form-group">
      <label>${t.date}:</label>
      <input type="date" id="editDate" value="${transaction.date}">
    </div>

    <div class="form-group">
      <label>${t.time}:</label>
      <input type="time" id="editTime" value="${transaction.time}">
    </div>

    <div class="form-group">
      <label>${t.customerName}:</label>
      <select id="editName">
        <option value="Kotie" ${transaction.name === 'Kotie' ? 'selected' : ''}>Kotie</option>
        <option value="Francois" ${transaction.name === 'Francois' ? 'selected' : ''}>Francois</option>
        <option value="Both" ${transaction.name === 'Both' ? 'selected' : ''}>${t.both}</option>
      </select>
    </div>

    <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
      <div style="font-weight: bold; margin-bottom: 10px;">${t.itemsLabel}</div>
      <div id="editItemsList"></div>
    </div>

    <div class="form-group">
      <label>${t.paymentMethod}</label>
      <select id="editPaymentMethod" onchange="updateEditPaymentFields()">
        <option value="Cash" ${transaction.paymentMethod === 'Cash' ? 'selected' : ''}>${t.cashOnly}</option>
        <option value="Card" ${transaction.paymentMethod === 'Card' ? 'selected' : ''}>${t.cardOnly}</option>
        <option value="Mixed" ${transaction.paymentMethod.includes('Mixed') ? 'selected' : ''}>${t.mixedCashCard}</option>
      </select>
    </div>

    <div id="editCashSection" style="display: none;">
      <div class="form-group">
        <label>${t.cashAmount}</label>
        <input type="number" id="editCashAmount" step="0.01" value="${transaction.cashAmount || 0}">
      </div>
    </div>

    <div id="editCardSection" style="display: none;">
      <div class="form-group">
        <label>${t.cardAmount}</label>
        <input type="number" id="editCardAmount" step="0.01" value="${transaction.cardAmount || 0}">
      </div>
      <div class="form-group">
        <label>${t.secondCardOptional}</label>
        <input type="number" id="editCardAmount2" step="0.01" value="${transaction.cardAmount2 || 0}">
      </div>
    </div>

    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; margin: 16px 0;">
      <strong>${t.totalLabel}</strong> R<span id="editTotalDisplay">${transaction.totalAmount.toFixed(2)}</span>
    </div>

    <div class="modal-buttons">
      <button class="button" style="background: #6B7280; color: white;" onclick="closeEditTransactionModal()">${t.cancel}</button>
      <button class="button btn-orange" onclick="saveEditedTransaction(${transactionIndex})">${t.saveChanges}</button>
    </div>
  </div>
</div>`;


    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Render items list
    renderEditItemsList(transaction.items, transactionIndex);

    // Show appropriate payment fields
    updateEditPaymentFields();
}


function renderEditItemsList(items, transactionIndex) {
    var container = document.getElementById('editItemsList');
    var html = '';
    
    items.forEach((item, index) => {
        html += `
            <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e5e7eb;">
                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                    <input type="text" id="editItemName_${index}" value="${item.product}" 
                           style="flex: 2; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                           placeholder="Product name">
                    <select id="editItemOwner_${index}" style="flex: 1; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;">
                        <option value="Kotie" ${item.owner === 'Kotie' ? 'selected' : ''}>Kotie</option>
                        <option value="Francois" ${item.owner === 'Francois' ? 'selected' : ''}>Francois</option>
                        <option value="Both" ${item.owner === 'Both' ? 'selected' : ''}>Both</option>
                    </select>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <div style="flex: 1;">
                        <label style="font-size: 10px; color: #6b7280;">${getTranslation('quantity')}</label>
                        <input type="number" id="editItemQty_${index}" value="${item.quantity}" min="1"
                               style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                               onchange="updateEditItemTotal(${index})">
                    </div>
                    <div style="flex: 1;">
                        <label style="font-size: 10px; color: #6b7280;">${getTranslation('price')}</label>
                        <input type="number" id="editItemPrice_${index}" value="${item.price}" step="0.01" min="0"
                               style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                               onchange="updateEditItemTotal(${index})">
                    </div>
                    <div style="flex: 1; text-align: right;">
                       <label style="font-size: 10px; color: #6b7280;">${getTranslation('total')}</label>
                        <div id="editItemTotal_${index}" style="font-weight: bold; color: #16a34a; font-size: 14px;">R${item.total.toFixed(2)}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}


function updateEditItemTotal(itemIndex) {
    var qty = parseFloat(document.getElementById('editItemQty_' + itemIndex).value) || 0;
    var price = parseFloat(document.getElementById('editItemPrice_' + itemIndex).value) || 0;
    var total = qty * price;
    
    document.getElementById('editItemTotal_' + itemIndex).textContent = 'R' + total.toFixed(2);
    
    // Update overall total
    updateEditOverallTotal();
}

// Update overall transaction total
function updateEditOverallTotal() {
    var items = document.querySelectorAll('[id^="editItemTotal_"]');
    var total = 0;
    
    items.forEach(item => {
        var value = parseFloat(item.textContent.replace('R', '')) || 0;
        total += value;
    });
    
    document.getElementById('editTotalDisplay').textContent = total.toFixed(2);
}


// Show/hide payment fields based on selection
function updateEditItemTotal(itemIndex) {
    var qty = parseFloat(document.getElementById('editItemQty_' + itemIndex).value) || 0;
    var price = parseFloat(document.getElementById('editItemPrice_' + itemIndex).value) || 0;
    var total = qty * price;
    
    document.getElementById('editItemTotal_' + itemIndex).textContent = 'R' + total.toFixed(2);
    
    // Update overall total
    updateEditOverallTotal();
}

// Update overall transaction total
function updateEditOverallTotal() {
    var items = document.querySelectorAll('[id^="editItemTotal_"]');
    var total = 0;
    
    items.forEach(item => {
        var value = parseFloat(item.textContent.replace('R', '')) || 0;
        total += value;
    });
    
    document.getElementById('editTotalDisplay').textContent = total.toFixed(2);
}

// Show/hide payment fields based on selection
function updateEditPaymentFields() {
    const method = document.getElementById('editPaymentMethod').value;
    const cashSection = document.getElementById('editCashSection');
    const cardSection = document.getElementById('editCardSection');

    if (method === 'Cash') {
        cashSection.style.display = 'none';   // ‚ùå REMOVE cash amount field
        cardSection.style.display = 'none';
    } 
    else if (method === 'Card') {
        cashSection.style.display = 'none';
        cardSection.style.display = 'block';
    } 
    else if (method === 'Mixed') {
        cashSection.style.display = 'block';
        cardSection.style.display = 'block';
    }
}

function processEditTransaction() {
    var original = allTransactions[window.editingTransactionIndex];
    var transactionIndex = window.editingTransactionIndex;
    
    // Get new values
    var newItems = [];
    var itemElements = document.querySelectorAll('[id^="editItemName_"]');
    
    itemElements.forEach((elem, index) => {
        newItems.push({
            product: document.getElementById('editItemName_' + index).value,
            owner: document.getElementById('editItemOwner_' + index).value,
            quantity: parseFloat(document.getElementById('editItemQty_' + index).value) || 1,
            price: parseFloat(document.getElementById('editItemPrice_' + index).value) || 0,
            stockKey: original.items[index].stockKey,
            total: 0
        });
    });
    
    // Calculate totals for each item
    newItems.forEach(item => {
        item.total = item.quantity * item.price;
    });
    
    var newTotal = newItems.reduce((sum, item) => sum + item.total, 0);
    var newPaymentMethod = document.getElementById('editPaymentMethod').value;
    
    // Determine old payment method
    var oldPaymentMethod = 'Card';
    if (original.cashAmount > 0 && (original.cardAmount > 0 || original.cardAmount2 > 0)) {
        oldPaymentMethod = 'Mixed';
    } else if (original.cashAmount > 0) {
        oldPaymentMethod = 'Cash';
    }
    
    // Check what changed
    var priceChanged = Math.abs(newTotal - original.totalAmount) > 0.01;
    var paymentMethodChanged = newPaymentMethod !== oldPaymentMethod;
    
    // Get item names for comparison
    var oldNames = original.items.map(i => i.product + '|' + i.owner).join(',');
    var newNames = newItems.map(i => i.product + '|' + i.owner).join(',');
    var onlyNamesChanged = !priceChanged && !paymentMethodChanged && oldNames !== newNames;
    
    console.log('Edit Analysis:', {
        priceChanged,
        paymentMethodChanged,
        onlyNamesChanged,
        oldPaymentMethod,
        newPaymentMethod,
        oldTotal: original.totalAmount,
        newTotal
    });
    
    // CASE 1: Only names/owners changed - Keep everything including denominations
    if (onlyNamesChanged) {
        saveSimpleEdit(transactionIndex, newItems, original);
        return;
    }
    
    // CASE 2: Price or payment changed - Need to handle denominations
    if (paymentMethodChanged || priceChanged) {
        handleComplexEdit(transactionIndex, newItems, newTotal, newPaymentMethod, original, priceChanged, paymentMethodChanged);
        return;
    }
    
    // CASE 3: Nothing changed
    if (!priceChanged && !paymentMethodChanged && oldNames === newNames) {
        closeEditTransactionModal();
        return;
    }
}

function saveSimpleEdit(transactionIndex, newItems, original) {
    // Update items but keep all denominations and amounts intact
    allTransactions[transactionIndex].items = newItems.map((item, i) => ({
        ...item,
        total: item.quantity * item.price
    }));
    allTransactions[transactionIndex].date = document.getElementById('editDate').value;
    allTransactions[transactionIndex].time = document.getElementById('editTime').value;
    allTransactions[transactionIndex].name = document.getElementById('editName').value;
    
    saveData();
    closeEditTransactionModal();
    updateReport();
    updateStats();
    
    alert('Transaction updated!\n\n‚úÖ Item names changed\n‚úÖ Denominations preserved');
}

function handleComplexEdit(transactionIndex, newItems, newTotal, newPaymentMethod, original) {
    const oldHadCash = original.cashAmount > 0;
    const newWillHaveCash = (newPaymentMethod === 'Cash' || newPaymentMethod === 'Mixed');

    // Reverse old cash effect if it existed
    if (!original.edited && oldHadCash &&
        original.cashReceivedDenominations &&
        original.changeGivenDenominations) {
        reverseCashTransaction(
            original.cashReceivedDenominations,
            original.changeGivenDenominations
        );
    }

    // Card ONLY ‚Üí save directly
    if (newPaymentMethod === 'Card') {
        saveCardOnlyEdit(transactionIndex, newItems, newTotal, original);
        return;
    }

    // Card ‚Üí Cash OR Mixed ‚Üí MUST re-enter denominations
    closeEditTransactionModal();
    openEditDenominationModal(
        transactionIndex,
        newItems,
        newTotal,
        newPaymentMethod,
        original
    );
}


function saveCardOnlyEdit(transactionIndex, newItems, newTotal, original) {
    var cardAmount = parseFloat(document.getElementById('editCardAmount').value) || newTotal;
    var cardAmount2 = parseFloat(document.getElementById('editCardAmount2').value) || 0;
    
    allTransactions[transactionIndex] = {
        ...original,
        date: document.getElementById('editDate').value,
        time: document.getElementById('editTime').value,
        name: document.getElementById('editName').value,
        items: newItems.map(item => ({...item, total: item.quantity * item.price})),
        totalAmount: newTotal,
        cashAmount: 0,
        cardAmount: cardAmount,
        cardAmount2: cardAmount2,
        paymentMethod: 'Card',
        edited: true,
        cashReceivedDenominations: null,
        changeGivenDenominations: null
    };
    
    saveData();
    closeEditTransactionModal();
    updateReport();
    updateStats();
    renderFloatBreakdown();
    
    alert('Transaction updated to Card payment!\n\n‚úÖ Old cash denominations removed\n‚úÖ Card payment applied');
}

function openEditDenominationModal(transactionIndex, newItems, newTotal, paymentMethod, original) {

    // Determine cash amount safely
    let cashAmount = newTotal;

    if (paymentMethod === 'Mixed') {
        const cashInput = document.getElementById('editCashAmount');
        cashAmount = cashInput ? parseFloat(cashInput.value) || 0 : 0;
    }

    // Store ALL required data WITHOUT reading removed DOM nodes
    window.editDenominationData = {
        transactionIndex,
        items: newItems,
        total: newTotal,
        paymentMethod,
        cashAmount,
        cardAmount: paymentMethod === 'Mixed'
            ? parseFloat(document.getElementById('editCardAmount')?.value) || 0
            : 0,
        cardAmount2: paymentMethod === 'Mixed'
            ? parseFloat(document.getElementById('editCardAmount2')?.value) || 0
            : 0,

        // ‚úÖ USE ORIGINAL DATA ‚Äî NOT DOM
        date: original.date,
        time: original.time,
        name: original.name,

        original
    };

    const modalHTML = `
        <div id="editDenominationModal" class="modal active">
            <div class="modal-content" style="max-width:450px;max-height:90vh;overflow-y:auto;">
                <div class="modal-title">Enter Cash Denominations</div>

                <div style="background:#fef3c7;border:2px solid #f59e0b;padding:12px;border-radius:8px;margin-bottom:16px;">
                    <strong>Cash Due:</strong> R${cashAmount.toFixed(2)}
                </div>

                <div style="font-weight:bold;margin-bottom:8px;">Step 1: Cash Received</div>
                <div id="editCashReceivedInputs"></div>

                <div style="background:#f0fdf4;padding:12px;border-radius:8px;margin:12px 0;">
                    <strong>Total Received:</strong>
                    R<span id="editCashReceivedTotal">0.00</span>
                </div>

                <div id="editChangeSection" style="display:none;">
                    <div style="font-weight:bold;margin-bottom:8px;">Step 2: Change to Give</div>
                    <div><strong>Change Due:</strong> R<span id="editChangeDue">0.00</span></div>
                    <div id="editChangeGivenInputs"></div>
                    <div style="margin-top:10px;">
                        <strong>Change Given:</strong>
                        R<span id="editChangeGivenTotal">0.00</span>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="button" onclick="closeEditDenominationModal()">Cancel</button>
                    <button class="button btn-green" onclick="saveEditWithDenominations()">Save Transaction</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
    renderEditDenominationInputs();
}



function renderEditDenominationInputs() {
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    // Cash received section
    var receivedHtml = '<div style="background: #f9fafb; padding: 12px; border-radius: 8px;">';
    receivedHtml += '<div style="font-weight: bold; margin-bottom: 8px;">Notes</div>';
    
    ['R200', 'R100', 'R50', 'R20', 'R10'].forEach(denom => {
        receivedHtml += `
            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                <label style="flex: 1; font-weight: 600;">${denom}:</label>
                <input type="number" id="editRecv_${denom}" value="0" min="0" 
                       style="width: 80px; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;"
                       oninput="calculateEditCashReceived()">
                <span id="editRecvSub_${denom}" style="width: 80px; text-align: right; font-weight: bold; color: #16a34a;">R0.00</span>
            </div>
        `;
    });
    
    receivedHtml += '<div style="font-weight: bold; margin: 12px 0 8px 0;">Coins</div>';
    
    ['R5', 'R2', 'R1', '50c', '20c', '10c'].forEach(denom => {
        receivedHtml += `
            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                <label style="flex: 1; font-weight: 600;">${denom}:</label>
                <input type="number" id="editRecv_${denom}" value="0" min="0" 
                       style="width: 80px; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;"
                       oninput="calculateEditCashReceived()">
                <span id="editRecvSub_${denom}" style="width: 80px; text-align: right; font-weight: bold; color: #16a34a;">R0.00</span>
            </div>
        `;
    });
    
    receivedHtml += '</div>';
    document.getElementById('editCashReceivedInputs').innerHTML = receivedHtml;
    
    // Change given section (will be shown when needed)
    var changeHtml = '<div style="background: #f9fafb; padding: 12px; border-radius: 8px;">';
    changeHtml += '<div style="font-weight: bold; margin-bottom: 8px;">Notes</div>';
    
    ['R200', 'R100', 'R50', 'R20', 'R10'].forEach(denom => {
        changeHtml += `
            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                <label style="flex: 1; font-weight: 600;">${denom}:</label>
                <input type="number" id="editChange_${denom}" value="0" min="0" 
                       style="width: 80px; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;"
                       oninput="calculateEditChangeGiven()">
                <span id="editChangeSub_${denom}" style="width: 80px; text-align: right; font-weight: bold; color: #ea580c;">R0.00</span>
            </div>
        `;
    });
    
    changeHtml += '<div style="font-weight: bold; margin: 12px 0 8px 0;">Coins</div>';
    
    ['R5', 'R2', 'R1', '50c', '20c', '10c'].forEach(denom => {
        changeHtml += `
            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                <label style="flex: 1; font-weight: 600;">${denom}:</label>
                <input type="number" id="editChange_${denom}" value="0" min="0" 
                       style="width: 80px; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;"
                       oninput="calculateEditChangeGiven()">
                <span id="editChangeSub_${denom}" style="width: 80px; text-align: right; font-weight: bold; color: #ea580c;">R0.00</span>
            </div>
        `;
    });
    
    changeHtml += '</div>';
    document.getElementById('editChangeGivenInputs').innerHTML = changeHtml;
    
    calculateEditCashReceived();
}

function calculateEditCashReceived() {
    const allDenoms = ['R200','R100','R50','R20','R10','R5','R2','R1','50c','20c','10c'];
    let total = 0;

    allDenoms.forEach(denom => {
        const input = document.getElementById('editRecv_' + denom);
        if (!input) return;

        const count = parseInt(input.value) || 0;
        const value = floatDenominations[denom].value;
        const subtotal = count * value;

        total += subtotal;
        document.getElementById('editRecvSub_' + denom).textContent = 'R' + subtotal.toFixed(2);
    });

    document.getElementById('editCashReceivedTotal').textContent = total.toFixed(2);

    const due = window.editDenominationData.cashAmount;

    if (total > due) {
        const change = total - due;
        document.getElementById('editChangeDue').textContent = change.toFixed(2);
        document.getElementById('editChangeSection').style.display = 'block';
        autoFillEditChange(change);
    } else {
        document.getElementById('editChangeSection').style.display = 'none';
    }
}

function calculateEditChangeGiven() {
    const values = {
        'R200':200,'R100':100,'R50':50,'R20':20,'R10':10,
        'R5':5,'R2':2,'R1':1,'50c':0.5,'20c':0.2,'10c':0.1
    };
    let total = 0;

    Object.keys(values).forEach(denom => {
        const input = document.getElementById('editChange_' + denom);
        if (!input) return;

        const count = parseInt(input.value) || 0;
        const subtotal = count * values[denom];
        total += subtotal;

        document.getElementById('editChangeSub_' + denom).textContent =
            'R' + subtotal.toFixed(2);
    });

    document.getElementById('editChangeGivenTotal').textContent = total.toFixed(2);
}


function autoFillEditChange(amount) {
    const optimal = breakCashIntoDenominations(amount);
    const allDenoms = ['R200','R100','R50','R20','R10','R5','R2','R1','50c','20c','10c'];

    allDenoms.forEach(denom => {
        const input = document.getElementById('editChange_' + denom);
        if (input) input.value = optimal[denom] || 0;
    });

    calculateEditChangeGiven();
}


function saveEditWithDenominations() {
    const data = window.editDenominationData;
    if (!data || !data.original) {
        alert('Internal error: missing edit data.');
        return;
    }

    const allDenoms = ['R200','R100','R50','R20','R10','R5','R2','R1','50c','20c','10c'];
    let receivedTotal = 0;
    let changeTotal = 0;

    const received = {};
    const change = {};

    allDenoms.forEach(d => {
        const rCount = parseInt(document.getElementById('editRecv_' + d)?.value) || 0;
        const cCount = parseInt(document.getElementById('editChange_' + d)?.value) || 0;
        const value = floatDenominations[d].value;

        received[d] = { count: rCount, value };
        change[d] = { count: cCount, value };

        receivedTotal += rCount * value;
        changeTotal += cCount * value;
    });

    const expectedChange = Math.max(0, receivedTotal - data.cashAmount);

    // üîí HARD LOCK
    if (Math.abs(changeTotal - expectedChange) > 0.01) {
        alert(
            `Change mismatch!\n\n` +
            `Expected: R${expectedChange.toFixed(2)}\n` +
            `Entered: R${changeTotal.toFixed(2)}`
        );
        return;
    }

    // Till availability validation
    if (!validateTillAvailability(change)) {
        return;
    }

    processCashTransaction(received, change);

    allTransactions[data.transactionIndex] = {
        ...data.original,
        date: data.date,
        time: data.time,
        name: data.name,
        items: data.items.map(i => ({ ...i, total: i.quantity * i.price })),
        totalAmount: data.total,
        cashAmount: data.cashAmount,
        cardAmount: data.cardAmount,
        cardAmount2: data.cardAmount2,
        paymentMethod: data.paymentMethod,
        edited: false,
        cashReceivedDenominations: received,
        changeGivenDenominations: change
    };

    saveData();
    closeEditDenominationModal();
    updateReport();
    updateStats();
    renderFloatBreakdown();

    alert('Transaction updated successfully.');
}

function validateTillAvailability(changeDenoms) {
    for (const denom in changeDenoms) {
        const needed = changeDenoms[denom].count;
        const available = tillDenominations[denom].count || 0;

        if (needed > available) {
            alert(
                `Not enough ${denom} in till.\n\n` +
                `Needed: ${needed}\n` +
                `Available: ${available}`
            );
            return false;
        }
    }
    return true;
}


    

function cancelEditDenominations(transactionIndex) {
    var original = window.editingOriginalTransaction;
    
    // Reapply original denominations if they existed
    if (!original.edited && original.cashReceivedDenominations && original.changeGivenDenominations) {
        processCashTransaction(original.cashReceivedDenominations, original.changeGivenDenominations);
    }
    
    closeEditDenominationModal();
    renderFloatBreakdown();
    
    alert('Edit cancelled. Original denominations restored.');
}

function closeEditDenominationModal() {
    var modal = document.getElementById('editDenominationModal');
    if (modal) modal.remove();
}
















// Save edited transaction
function saveEditedTransaction(transactionIndex) {
    // Route ALL edit saves through the main edit decision logic.
    // This is CRITICAL so Card ‚Üí Cash and price changes trigger
    // the cash denomination flow instead of silently saving.

    // Store index globally (used by processEditTransaction)
    window.editingTransactionIndex = transactionIndex;

    // Run full edit analysis:
    // - Detects name-only edits
    // - Detects price changes
    // - Detects payment method changes
    // - Opens denomination modal when required
    processEditTransaction();
}


// Reverse a cash transaction (undo the till changes)
function reverseCashTransaction(cashReceivedDenoms, changeGivenDenoms) {
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    console.log('Reversing cash transaction...');
    console.log('Before reverse:', JSON.parse(JSON.stringify(tillDenominations)));
    
    // Reverse: Subtract what was received, Add back what was given as change
    allDenoms.forEach(denom => {
        var received = cashReceivedDenoms[denom].count || 0;
        var given = changeGivenDenoms[denom].count || 0;
        
        tillDenominations[denom].count -= received; // Remove what was added
        tillDenominations[denom].count += given;    // Add back what was taken
        
        // Safety check
        if (tillDenominations[denom].count < 0) {
            console.warn('Warning: Negative count for ' + denom + ' after reversal');
            tillDenominations[denom].count = 0;
        }
    });
    
    console.log('After reverse:', JSON.parse(JSON.stringify(tillDenominations)));
    
    saveTillState();
}

// Close edit modal
function closeEditTransactionModal() {
    var modal = document.getElementById('editTransactionModal');
    if (modal) {
        modal.remove();
    }
}





// Add edit button to transaction list in Report tab
// This modifies the existing updateReport function to add edit buttons
function addEditButtonsToTransactions() {
    var list = document.getElementById('transList');
    if (!list) return;
    
    var dayEl = document.getElementById('daySelect');
    var day = dayEl ? dayEl.value : '';
    var dayTrans = allTransactions.filter(t => t.date === day);
    
    if (dayTrans.length > 0) {
        var html = '';
        dayTrans.forEach((t, index) => {
            var absoluteIndex = allTransactions.findIndex(trans => 
                trans.transactionNumber === t.transactionNumber && 
                trans.date === t.date && 
                trans.time === t.time
            );
            
            var names = (t.items || []).map(i => i.product).join(', ');
            var pay = 'Cash: R' + (t.cashAmount || 0).toFixed(2);
            if ((t.cardAmount || 0) > 0) pay += ' | Card1: R' + (t.cardAmount || 0).toFixed(2);
            if ((t.cardAmount2 || 0) > 0) pay += ' | Card2: R' + (t.cardAmount2 || 0).toFixed(2);
            
            var editedBadge = t.edited ? '<span style="background: #fbbf24; color: #78350f; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">EDITED</span>' : '';
            
            html += '<div class="trans-item">';
            html += '<div class="trans-time" style="display: flex; justify-content: space-between; align-items: center;">';
            html += '<span>' + (t.time || '') + ' - ' + (t.name || '') + ' (#' + (t.transactionNumber || '') + ')' + editedBadge + '</span>';
            html += '<button class="btn-red" onclick="openEditTransactionModal(allTransactions[' + absoluteIndex + '], ' + absoluteIndex + ')" style="padding: 4px 8px; font-size: 11px;">Edit</button>';
            html += '</div>';
            html += '<div>' + names + '</div>';
            html += '<div style="margin-top:4px;">' + pay + '</div>';
            html += '<div style="color:#16A34A;font-weight:bold;">Total: R' + (t.totalAmount || 0).toFixed(2) + '</div>';
            html += '</div>';
        });
        list.innerHTML = html;
    }
}


function checkForNewDay() {
    var today = new Date().toISOString().split('T')[0];
    var lastActiveDate = localStorage.getItem('salesSystemLastActiveDate');
    
    // If no last active date, set it to today
    if (!lastActiveDate) {
        localStorage.setItem('salesSystemLastActiveDate', today);
        return;
    }
    
    // If it's a different day
    if (lastActiveDate !== today) {
        // Check if there are transactions from the previous day
        var previousDayTransactions = allTransactions.filter(t => t.date === lastActiveDate);
        
        if (previousDayTransactions.length > 0) {
            // Calculate totals for the message
            var totalSales = previousDayTransactions.reduce((sum, t) => sum + t.totalAmount, 0);
            
            var message = "New day detected!\n\n";
            message += "Last active: " + lastActiveDate + "\n";
            message += "Transactions: " + previousDayTransactions.length + "\n";
            message += "Total sales: R" + totalSales.toFixed(2) + "\n\n";
            message += "Do you want to:\n";
            message += "‚Ä¢ Generate PDF report for " + lastActiveDate + "\n";
            message += "‚Ä¢ Keep all data for records\n";
            message += "‚Ä¢ Reset till to float amount\n\n";
            message += "Click OK to generate report and reset, or Cancel to keep working.";
            
            if (confirm(message)) {
                // Generate PDF for previous day
                generatePDF(lastActiveDate);
                
                // Ask if they want to clear old transactions
                setTimeout(function() {
                    if (confirm("Report generated!\n\nDo you want to clear transactions from " + lastActiveDate + "?\n\n(Float and till will reset to starting float amount)")) {
                        // Keep only current day's transactions (if any)
                        allTransactions = allTransactions.filter(t => t.date === today);
                        saveData();
                        
                        // Reset till to float amount
                        initializeTillFromFloat();
                        
                        // Update display
                        updateStats();
                        updateReport();
                        renderFloatBreakdown();
                        
                        alert("System reset for new day!\n\nTill reset to float amount: R" + floatAmount.toFixed(2));
                    }
                }, 500);
            }
        }
        
        // Update last active date to today
        localStorage.setItem('salesSystemLastActiveDate', today);
    }
}







function updateFloatAmount() {
    var newAmount = parseFloat(document.getElementById('newFloatAmount').value);
    if (isNaN(newAmount) || newAmount < 0) {
        alert("Please enter a valid float amount");
        return;
    }
    floatAmount = newAmount;
    document.getElementById('floatTotalAmount').textContent = 'R ' + floatAmount.toFixed(2);
    saveFloatData();
    renderFloatBreakdown();
    alert("Float amount updated to R " + floatAmount.toFixed(2));
}

function setupFloatDenominations() {
    document.getElementById('floatDenominationModal').classList.add('active');
    renderFloatSetupForm();
}

function renderFloatSetupForm() {
    var container = document.getElementById('denominationSetupContainer');
    var html = '';
    var totalCalculated = 0;
    
    // Notes Section
    html += '<div style="margin-bottom: 10px; font-weight: bold; color: #374151;" data-translate="notes">Notes</div>';
    var notes = ['R200', 'R100', 'R50', 'R20', 'R10'];
    notes.forEach(denom => {
        var denomData = floatDenominations[denom];
        var subtotal = denomData.count * denomData.value;
        totalCalculated += subtotal;
        html += `
            <div class="denom-input-row">
                <div class="denom-label">${denom}:</div>
                <input type="number" class="denom-input" id="setup_${denom}" value="${denomData.count}" min="0" oninput="updateFloatSetupTotal()">
                <div class="denom-subtotal" id="subtotal_${denom}">R ${subtotal.toFixed(2)}</div>
            </div>
        `;
    });
    
    // Coins Section
    html += '<div style="margin-top: 15px; margin-bottom: 10px; font-weight: bold; color: #374151;" data-translate="coins">Coins</div>';
    var coins = ['R5', 'R2', 'R1', '50c', '20c', '10c'];
    coins.forEach(denom => {
        var denomData = floatDenominations[denom];
        var subtotal = denomData.count * denomData.value;
        totalCalculated += subtotal;
        html += `
            <div class="denom-input-row">
                <div class="denom-label">${denom}:</div>
                <input type="number" class="denom-input" id="setup_${denom}" value="${denomData.count}" min="0" oninput="updateFloatSetupTotal()">
                <div class="denom-subtotal" id="subtotal_${denom}">R ${subtotal.toFixed(2)}</div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    updateFloatSetupTotal();
}

function updateFloatSetupTotal() {
    var totalCalculated = 0;
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    allDenoms.forEach(denom => {
        var input = document.getElementById('setup_' + denom);
        if (input) {
            var count = parseInt(input.value) || 0;
            var value = floatDenominations[denom].value;
            var subtotal = count * value;
            totalCalculated += subtotal;
            document.getElementById('subtotal_' + denom).textContent = 'R ' + subtotal.toFixed(2);
        }
    });
    
    document.getElementById('floatSetupTotal').textContent = 'R ' + totalCalculated.toFixed(2);
    
    var variance = totalCalculated - floatAmount;
    var varianceDisplay = document.getElementById('floatSetupVariance');
    if (Math.abs(variance) > 0.01) {
        varianceDisplay.innerHTML = `<span style="color: ${variance > 0 ? '#16a34a' : '#dc2626'};">${variance > 0 ? '+' : ''}R ${Math.abs(variance).toFixed(2)} ${variance > 0 ? translations[currentLanguage]['over'] : translations[currentLanguage]['short']}</span>`;
    } else {
        varianceDisplay.innerHTML = `<span style="color: #16a34a;">${translations[currentLanguage]['correct']}</span>`;
    }
}

function saveFloatDenominations() {
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    var totalCalculated = 0;
    
    allDenoms.forEach(denom => {
        var input = document.getElementById('setup_' + denom);
        if (input) {
            var count = parseInt(input.value) || 0;
            floatDenominations[denom].count = count;
            totalCalculated += count * floatDenominations[denom].value;
        }
    });
    
    // Verify total matches float amount
    var variance = Math.abs(totalCalculated - floatAmount);
    if (variance > 0.01) {
        if (!confirm('Float breakdown total (R' + totalCalculated.toFixed(2) + ') does not match float amount (R' + floatAmount.toFixed(2) + '). Save anyway?')) {
            return;
        }
    }
    
    saveFloatData();
    
    // CRITICAL: Update till to match new float
    initializeTillFromFloat();
    
    renderFloatBreakdown();
    closeFloatDenominationModal();
    alert("Float denominations saved! Till updated to match.");
}


function processCashTransaction(cashReceivedDenoms, changeGivenDenoms) {
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    console.log('Processing cash transaction...');
    console.log('Before:', JSON.parse(JSON.stringify(tillDenominations)));
    
    // Add cash received
    allDenoms.forEach(denom => {
        var received = cashReceivedDenoms[denom].count || 0;
        tillDenominations[denom].count += received;
    });
    
    // Subtract change given
    allDenoms.forEach(denom => {
        var given = changeGivenDenoms[denom].count || 0;
        tillDenominations[denom].count -= given;
        
        // Safety check
        if (tillDenominations[denom].count < 0) {
            console.warn('Warning: Negative count for ' + denom);
            tillDenominations[denom].count = 0;
        }
    });
    
    console.log('After:', JSON.parse(JSON.stringify(tillDenominations)));
    
    saveTillState();
}



function closeFloatDenominationModal() {
    document.getElementById('floatDenominationModal').classList.remove('active');
}
    
    // ========== CASH RECONCILIATION FUNCTIONS ==========
        
function loadDailyCashReconciliation() {
    var date = document.getElementById('reconciliationDate').value;
    if (!date) return;
    
    // Calculate cash sales for the day
    var dayTransactions = allTransactions.filter(t => t.date === date);
    var cashSales = 0;
    dayTransactions.forEach(t => {
        cashSales += t.cashAmount;
    });
    
    // Check if reconciliation already exists
    var existingRecon = dailyReconciliations.find(r => r.date === date);
    
    document.getElementById('reconDate').textContent = date;
    document.getElementById('reconCashSales').textContent = 'R' + cashSales.toFixed(2);
    
    // Use stored float amount if available, otherwise use current
    var startingFloat = existingRecon ? existingRecon.startingFloat : floatAmount;
    document.getElementById('reconStartingFloat').textContent = 'R' + startingFloat.toFixed(2);
    
    var expectedInTill = cashSales + startingFloat;
    document.getElementById('reconExpectedInTill').textContent = 'R' + expectedInTill.toFixed(2);
    
    // Calculate cash to bank (expected)
    var cashToBank = cashSales;
    document.getElementById('reconCashToBank').textContent = 'R' + cashToBank.toFixed(2);
    
    // Render denomination inputs, using stored denominations if available
    renderReconciliationDenominationInputs(existingRecon);
    
    document.getElementById('reconciliationResults').style.display = 'block';
    
    // If existing reconciliation, calculate variance
    if (existingRecon) {
        calculateReconciliationVariance();
    }
}
        
function renderReconciliationDenominationInputs(existingRecon) {
    var container = document.getElementById('reconDenominationInputs');
    if (!container) return;
    
    // Use stored float denominations if available, otherwise use current
    var denoms = existingRecon && existingRecon.floatDenominations ? existingRecon.floatDenominations : floatDenominations;
    
    var html = '';
    
    // Notes Section
    html += '<div style="margin-bottom: 10px; font-weight: bold; color: #374151;" data-translate="notes">Notes</div>';
    var notes = ['R200', 'R100', 'R50', 'R20', 'R10'];
    notes.forEach(denom => {
        var existingCount = existingRecon ? existingRecon.actualCount[denom] || denoms[denom].count : denoms[denom].count;
        var value = denoms[denom].value;
        var subtotal = existingCount * value;
        html += `
            <div class="denom-input-row">
                <div class="denom-label">${denom}:</div>
                <input type="number" class="denom-input" id="recon_${denom}" value="${existingCount}" min="0" oninput="calculateReconciliationVariance()">
                <div class="denom-subtotal" id="recon_subtotal_${denom}">R${subtotal.toFixed(2)}</div>
            </div>
        `;
    });
    
    // Coins Section
    html += '<div style="margin-top: 15px; margin-bottom: 10px; font-weight: bold; color: #374151;" data-translate="coins">Coins</div>';
    var coins = ['R5', 'R2', 'R1', '50c', '20c', '10c'];
    coins.forEach(denom => {
        var existingCount = existingRecon ? existingRecon.actualCount[denom] || denoms[denom].count : denoms[denom].count;
        var value = denoms[denom].value;
        var subtotal = existingCount * value;
        html += `
            <div class="denom-input-row">
                <div class="denom-label">${denom}:</div>
                <input type="number" class="denom-input" id="recon_${denom}" value="${existingCount}" min="0" oninput="calculateReconciliationVariance()">
                <div class="denom-subtotal" id="recon_subtotal_${denom}">R${subtotal.toFixed(2)}</div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    calculateReconciliationVariance();
}
        
function calculateReconciliationVariance() {
    var date = document.getElementById('reconciliationDate').value;
    var existingRecon = dailyReconciliations.find(r => r.date === date);
    
    // Use stored float denominations if available, otherwise use current
    var denoms = existingRecon && existingRecon.floatDenominations ? existingRecon.floatDenominations : floatDenominations;
    
    var actualTotal = 0;
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    allDenoms.forEach(denom => {
        var input = document.getElementById('recon_' + denom);
        if (input) {
            var count = parseInt(input.value) || 0;
            var value = denoms[denom].value;
            var subtotal = count * value;
            actualTotal += subtotal;
            document.getElementById('recon_subtotal_' + denom).textContent = 'R' + subtotal.toFixed(2);
        }
    });
    
    var expectedInTill = parseFloat(document.getElementById('reconExpectedInTill').textContent.replace('R', ''));
    var variance = actualTotal - expectedInTill;
    
    var varianceDisplay = document.getElementById('varianceDisplay');
    var varianceMessage = document.getElementById('varianceMessage');
    
    if (variance > 0.01) {
        varianceDisplay.style.color = '#16a34a';
        varianceDisplay.textContent = '+R' + Math.abs(variance).toFixed(2);
        varianceMessage.textContent = translations[currentLanguage]['over'];
        varianceMessage.style.color = '#16a34a';
    } else if (variance < -0.01) {
        varianceDisplay.style.color = '#dc2626';
        varianceDisplay.textContent = '-R' + Math.abs(variance).toFixed(2);
        varianceMessage.textContent = translations[currentLanguage]['short'];
        varianceMessage.style.color = '#dc2626';
    } else {
        varianceDisplay.style.color = '#2563eb';
        varianceDisplay.textContent = 'R0.00';
        varianceMessage.textContent = translations[currentLanguage]['correct'];
        varianceMessage.style.color = '#2563eb';
    }
}
        
function saveReconciliation() {
    var date = document.getElementById('reconciliationDate').value;
    if (!date) {
        alert("Please select a date first");
        return;
    }
    
    var actualCount = {};
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    var actualTotal = 0;
    
    allDenoms.forEach(denom => {
        var input = document.getElementById('recon_' + denom);
        var count = parseInt(input.value) || 0;
        actualCount[denom] = count;
        actualTotal += count * floatDenominations[denom].value;
    });
    
    var cashSales = parseFloat(document.getElementById('reconCashSales').textContent.replace('R', ''));
    var expectedInTill = parseFloat(document.getElementById('reconExpectedInTill').textContent.replace('R', ''));
    var variance = actualTotal - expectedInTill;
    
    // Check if reconciliation already exists
    var existingIndex = dailyReconciliations.findIndex(r => r.date === date);
    var reconciliation = {
        date: date,
        cashSales: cashSales,
        startingFloat: floatAmount, // Store the current float amount
        floatDenominations: JSON.parse(JSON.stringify(floatDenominations)), // Store a copy of current float denominations
        expectedInTill: expectedInTill,
        actualCount: actualCount,
        actualTotal: actualTotal,
        variance: variance,
        cashToBank: cashSales,
        timestamp: new Date().toISOString()
    };
    
    if (existingIndex >= 0) {
        dailyReconciliations[existingIndex] = reconciliation;
    } else {
        dailyReconciliations.push(reconciliation);
    }
    
    saveReconciliations();
    renderReconciliationHistory();
    
    alert("Reconciliation saved for " + date);
}
        
        function renderReconciliationHistory() {
            var tbody = document.getElementById('reconciliationHistoryBody');
            tbody.innerHTML = '';
            
            if (dailyReconciliations.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6b7280;">No reconciliation history</td></tr>`;
                return;
            }
            
            // Sort by date descending
            dailyReconciliations.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            dailyReconciliations.forEach(recon => {
                var row = document.createElement('tr');
                row.style.borderBottom = '1px solid #e5e7eb';
                
                var varianceColor = recon.variance > 0.01 ? '#16a34a' : (recon.variance < -0.01 ? '#dc2626' : '#2563eb');
                var varianceSign = recon.variance > 0.01 ? '+' : '';
                
                row.innerHTML = `
                    <td style="padding: 8px;">${recon.date}</td>
                    <td style="padding: 8px; text-align: right;">R${recon.cashSales.toFixed(2)}</td>
                    <td style="padding: 8px; text-align: right;">R${recon.cashToBank.toFixed(2)}</td>
                    <td style="padding: 8px; text-align: right; color: ${varianceColor};">${varianceSign}R${Math.abs(recon.variance).toFixed(2)}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // ========== REPORT TAB CASH RECONCILIATION ==========

function updateReport() {
  // small helpers (self-contained so you can paste the function anywhere)
  
  function safeSetText(id, text) {
    var el = document.getElementById(id);
    if (el) el.textContent = text;
  }
  
  function safeSetHTML(id, html) {
    var el = document.getElementById(id);
    if (el) el.innerHTML = html;
  }
  function safeSetDisplay(id, val) {
    var el = document.getElementById(id);
    if (el) el.style && (el.style.display = val);
  }

  var dayEl = document.getElementById('daySelect');
  var day = dayEl ? dayEl.value : '';
  var dayTrans = allTransactions.filter(t => t.date === day);

  // Reset all counters
  var kTransactions = 0;
  var kCash = 0;
  var kCard = 0;
  var kTotal = 0;

  var fTransactions = 0;
  var fCash = 0;
  var fCard = 0;
  var fTotal = 0;

  var totalTransactionsCount = dayTrans.length;
  var totalCash = 0;
  var totalCard = 0;
  var grandTotal = 0;

  // Process each transaction
  dayTrans.forEach(t => {
    var transactionName = t.name;

    if (transactionName === 'Kotie') {
      kTransactions++;
      kCash += (t.cashAmount || 0);
      kCard += ((t.cardAmount || 0) + (t.cardAmount2 || 0));
      kTotal += (t.totalAmount || 0);
    } else if (transactionName === 'Francois') {
      fTransactions++;
      fCash += (t.cashAmount || 0);
      fCard += ((t.cardAmount || 0) + (t.cardAmount2 || 0));
      fTotal += (t.totalAmount || 0);
    } else if (transactionName === 'Both') {
      // For "Both" transactions, split based on item ownership
      var kotieItemsTotal = 0;
      var francoisItemsTotal = 0;

      (t.items || []).forEach(item => {
        if (item.owner === 'Kotie') kotieItemsTotal += (item.total || 0);
        else if (item.owner === 'Francois') francoisItemsTotal += (item.total || 0);
      });

      var totalTransactionValue = t.totalAmount || 0;
      var kotiePercentage = totalTransactionValue > 0 ? kotieItemsTotal / totalTransactionValue : 0;
      var francoisPercentage = totalTransactionValue > 0 ? francoisItemsTotal / totalTransactionValue : 0;

      // Split cash and card based on percentage
      if (kotieItemsTotal > 0) {
        kTransactions++;
        kCash += (t.cashAmount || 0) * kotiePercentage;
        kCard += ((t.cardAmount || 0) + (t.cardAmount2 || 0)) * kotiePercentage;
        kTotal += kotieItemsTotal;
      }

      if (francoisItemsTotal > 0) {
        fTransactions++;
        fCash += (t.cashAmount || 0) * francoisPercentage;
        fCard += ((t.cardAmount || 0) + (t.cardAmount2 || 0)) * francoisPercentage;
        fTotal += francoisItemsTotal;
      }
    }
  });

  // Calculate totals
  totalCash = kCash + fCash;
  totalCard = kCard + fCard;
  grandTotal = kTotal + fTotal;

  // Update Kotie display
  safeSetText('KotieCount', kTransactions);
  safeSetText('KotieCash', kCash.toFixed(2));
  safeSetText('KotieCard', kCard.toFixed(2));
  safeSetText('KotieTotal', kTotal.toFixed(2));

  // Update Francois display
  safeSetText('francoisCount', fTransactions);
  safeSetText('francoisCash', fCash.toFixed(2));
  safeSetText('francoisCard', fCard.toFixed(2));
  safeSetText('francoisTotal', fTotal.toFixed(2));

  // Update Day Total display
  safeSetText('totalCash', totalCash.toFixed(2));
  safeSetText('totalCard', totalCard.toFixed(2));
  safeSetText('grandTotal', grandTotal.toFixed(2));
  safeSetText('totalTransactionsCount', totalTransactionsCount);

  // Update stats at the top
  safeSetText('totalSales', 'R' + grandTotal.toFixed(2));
  safeSetText('totalTransactions', totalTransactionsCount);

  // Update cash reconciliation section
  safeSetText('reportCashSales', totalCash.toFixed(2));
  safeSetText('reportStartingFloat', floatAmount.toFixed(2));

  var totalInTill = totalCash + floatAmount;
  safeSetText('reportTotalInTill', totalInTill.toFixed(2));
  safeSetText('reportFloatToKeep', floatAmount.toFixed(2));

  var cashToBank = totalCash;
  safeSetText('cashToBankAmount', cashToBank.toFixed(2));

  // Show/hide cash reconciliation section
  var cashReconEl = document.getElementById('cashReconciliationSection');
  if (cashReconEl) cashReconEl.style.display = dayTrans.length > 0 ? 'block' : 'none';

  // Render denomination inputs for this day
  if (typeof renderReportDenominationInputs === 'function') {
    var existingRecon = dailyReconciliations.find(r => r.date === day);
    renderReportDenominationInputs(day, existingRecon);
  }

  // Update transaction list
  var list = document.getElementById('transList');
  var transListContainer = document.getElementById('transListContainer');
  if (transListContainer) transListContainer.style.display = dayTrans.length ? 'block' : 'none';

  if (list) {
    if (dayTrans.length) {
      var html = '';
      dayTrans.forEach(t => {
        var names = (t.items || []).map(i => i.product).join(', ');
        var pay = 'Cash: R' + (t.cashAmount || 0).toFixed(2);
        if ((t.cardAmount || 0) > 0) pay += ' | Card1: R' + (t.cardAmount || 0).toFixed(2);
        if ((t.cardAmount2 || 0) > 0) pay += ' | Card2: R' + (t.cardAmount2 || 0).toFixed(2);

        // Add Edit button inline (so you can edit directly from the list)
        var absoluteIndex = allTransactions.findIndex(trans =>
          trans.transactionNumber === t.transactionNumber &&
          trans.date === t.date &&
          trans.time === t.time
        );
        var editedBadge = t.edited ? '<span style="background: #fbbf24; color: #78350f; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">EDITED</span>' : '';

        html += '<div class="trans-item">';
        html += '<div class="trans-time" style="display: flex; justify-content: space-between; align-items: center;">';
        html += '<span>' + (t.time || '') + ' - ' + (t.name || '') + ' (#' + (t.transactionNumber || '') + ')' + editedBadge + '</span>';
        html += '<button class="btn-red" onclick="openEditTransactionModal(allTransactions[' + absoluteIndex + '], ' + absoluteIndex + ')" style="padding: 4px 8px; font-size: 11px;">Edit</button>';
        html += '</div>';
        html += '<div>' + names + '</div>';
        html += '<div style="margin-top:4px;">' + pay + '</div>';
        html += '<div style="color:#16A34A;font-weight:bold;">Total: R' + (t.totalAmount || 0).toFixed(2) + '</div>';
        html += '</div>';
      });
      list.innerHTML = html;
    } else {
      list.innerHTML = '';
    }
  }
  
  // TIP block: explain cash tracking. FIXED: use dayTrans, not dayTransactions
  if (totalCash > 0) {
    var cashReconEl2 = document.getElementById('cashReconciliationSection');
    if (cashReconEl2 && cashReconEl2.style.display !== 'none') {
      var existingTip = document.querySelector('.cash-auto-fill-info');
      if (existingTip) {
        existingTip.remove();
      }
      
      var infoDiv = document.createElement('div');
      infoDiv.className = 'cash-auto-fill-info';
      infoDiv.style.background = '#f0f9ff';
      infoDiv.style.border = '2px solid #3b82f6';
      infoDiv.style.borderRadius = '8px';
      infoDiv.style.padding = '10px';
      infoDiv.style.margin = '10px 0';
      infoDiv.style.fontSize = '14px';
      infoDiv.style.color = '#374151';
      
      var cashTransactions = dayTrans.filter(t => t.cashAmount > 0).length;
      
      infoDiv.innerHTML = `<strong>üí° Cash Tracking Active:</strong><br>
            You have ${cashTransactions} cash transaction(s) totaling R${totalCash.toFixed(2)}.<br>
            The denomination counts below include:
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li>Starting float from Float tab</li>
                <li>Plus exact cash received from customers</li>
                <li>Minus exact change given to customers</li>
            </ul>
            You can adjust the counts if needed.`;
      
      var denomContainer = document.getElementById('denominationInputsContainer');
      if (denomContainer) {
        denomContainer.insertBefore(infoDiv, denomContainer.firstChild);
      }
    }
  }
}



        // ========== REST OF YOUR EXISTING FUNCTIONS ==========
        
function startNewTransaction() {
  if (purchasedItems.length > 0 && !confirm(translations[currentLanguage]['newTransaction'] + '?')) return;
  
  console.log('Starting new transaction manually...');
  
  currentTransactionNumber++;
  saveTransactionNumber();
  updateTransactionNumberDisplay();
  
  // Reset all fields
  purchasedItems = [];
  
  document.getElementById('name').value = '';
  document.getElementById('date').value = today;
  document.getElementById('time').value = new Date().toTimeString().slice(0, 5);
  document.getElementById('productCode').value = '';
  document.getElementById('productInfo').style.display = 'none';
  document.getElementById('salesSearch').value = '';
  document.getElementById('sellQuantity').value = '1';
  
  // Reset variables
  currentProduct = null;
  currentQuantity = 1;
  salesSearchTerm = '';
  salesCurrentPage = 1;
  
  // Reset toggle
  if (quantityMode !== 'none') {
    toggleQuantityMode('none');
  }
  
  // Update UI
  updateItemsList();
  updateProductList();
  updateSalesPagination(0);
  
  // Hide containers
  document.getElementById('itemsContainer').style.display = 'none';
  document.getElementById('paymentSection').style.display = 'none';
  
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
  
  // Re-focus for scanner
  setTimeout(() => {
    document.getElementById('productCode').focus();
    console.log('New transaction ready. Focus on scanner.');
  }, 100);
}

        function setToday() {
          document.getElementById('date').value = today;
        }

        function setNow() {
          document.getElementById('time').value = new Date().toTimeString().slice(0, 5);
        }

        function handleCodeEnter(event) {
          if (event.key === 'Enter') lookupProduct();
        }

        function toggleQuantityMode(mode) {
          quantityMode = mode;
          document.getElementById('toggleNoQuantity').classList.toggle('active', mode === 'none');
          document.getElementById('toggleNoQuantity').classList.toggle('inactive', mode !== 'none');
          document.getElementById('toggleWithQuantity').classList.toggle('active', mode !== 'none');
          document.getElementById('toggleWithQuantity').classList.toggle('inactive', mode === 'none');
          document.getElementById('quantityFields').style.display = mode === 'with' ? 'block' : 'none';
          document.getElementById('stockDisplay').style.display = mode === 'with' ? 'block' : 'none';
          updateProductList();
        }

        function loadQuantityData() {
          var q = localStorage.getItem('salesSystemQuantities');
          if (q) productQuantities = JSON.parse(q);
        }

        function saveQuantityData() {
          localStorage.setItem('salesSystemQuantities', JSON.stringify(productQuantities));
        }

        // Helper to get standardized stock key
        function getStockKey(product) {
          return product.code || product.id.toString();
        }

        function isProductAvailable(product) {
          if (quantityMode === 'none') return true;
          let key = getStockKey(product);
          return (productQuantities[key] || 0) > 0;
        }

        function getAvailableQuantity(product) {
          let key = getStockKey(product);
          return productQuantities[key] || 0;
        }

        function updateStockDisplay(product) {
          if (quantityMode === 'with' && product) {
            var qty = getAvailableQuantity(product);
            document.getElementById('stockQuantity').textContent = qty;
            document.getElementById('stockDisplay').style.display = 'block';
            document.getElementById('sellQuantity').max = qty;
            if (qty === 0) {
              document.getElementById('outOfStockItem').textContent = product.name;
              document.getElementById('stockWarning').style.display = 'block';
            } else document.getElementById('stockWarning').style.display = 'none';
          } else {
            document.getElementById('stockDisplay').style.display = 'none';
            document.getElementById('stockWarning').style.display = 'none';
          }
        }

        function lookupProduct() {
          var name = document.getElementById('name').value;
          if (!name) return alert(translations[currentLanguage]['pleaseSelectName']);
          var code = document.getElementById('productCode').value.trim();
          if (!code) return alert(translations[currentLanguage]['pleaseEnterCode']);
          currentProduct = findProductByCode(code);
          if (currentProduct) {
            if (currentProduct.owner === name || currentProduct.owner === 'Both' || name === 'Both') {
              if (quantityMode === 'with' && !isProductAvailable(currentProduct)) {
                alert(translations[currentLanguage]['noItemAvailable'] + currentProduct.name + translations[currentLanguage]['noItemAvailableEnd']);
                return;
              }
              document.getElementById('infoName').textContent = currentProduct.name;
              document.getElementById('infoPrice').textContent = 'R' + currentProduct.price.toFixed(2);
              document.getElementById('infoOwner').textContent = currentProduct.owner;
              document.getElementById('infoCategory').textContent = currentProduct.category || 'None';
              updateStockDisplay(currentProduct);
              currentQuantity = 1;
              document.getElementById('quantityDisplay').textContent = 1;
              document.getElementById('productInfo').style.display = 'block';
              updateProductList(currentProduct);
            } else alert(translations[currentLanguage]['productBelongsTo'] + currentProduct.owner + translations[currentLanguage]['changeNameOrProduct']);
          } else alert(translations[currentLanguage]['productNotFound'] + code + translations[currentLanguage]['notFound']);
        }

        function adjustQuantity(change) {
          currentQuantity += change;
          if (currentQuantity < 1) currentQuantity = 1;
          document.getElementById('quantityDisplay').textContent = currentQuantity;
        }

        function addProductFromCode() {
          var name = document.getElementById('name').value;
          if (!name) return alert(translations[currentLanguage]['pleaseSelectName']);
          if (!currentProduct) return alert(translations[currentLanguage]['firstFindProduct']);
          if (name === 'Both') {
            pendingItem = {
              product: currentProduct,
              quantity: currentQuantity,
              type: 'code'
            };
            document.getElementById('ownerSelectionModal').classList.add('active');
            return;
          }
          // Get Key
          let key = getStockKey(currentProduct);
          addProductToCart(currentProduct.name, currentProduct.price, currentQuantity, name, key);
          document.getElementById('productCode').value = '';
          document.getElementById('productInfo').style.display = 'none';
          currentProduct = null;
          updateProductList();
          
          // Re-focus for scanner for next item
          setTimeout(() => document.getElementById('productCode').focus(), 100);
        }

        function addProductToCart(productName, price, quantity, owner, stockKey) {
          purchasedItems.push({
            id: Date.now(),
            product: productName,
            price: price,
            quantity: quantity,
            total: price * quantity,
            owner: owner,
            stockKey: stockKey
          });
          updateItemsList();
        }

        function openManualInputModal() {
          document.getElementById('manualInputModal').classList.add('active');
          document.getElementById('manualProductName').value = '';
          document.getElementById('manualProductPrice').value = '';
          document.getElementById('manualProductQuantity').value = '1';
        }

        function closeManualInputModal() {
          document.getElementById('manualInputModal').classList.remove('active');
        }

        function addManualProduct() {
          var name = document.getElementById('name').value;
          if (!name) return alert(translations[currentLanguage]['pleaseSelectName']);
          var productName = document.getElementById('manualProductName').value;
          var price = parseFloat(document.getElementById('manualProductPrice').value);
          var quantity = parseInt(document.getElementById('manualProductQuantity').value);
          if (!productName || !price || !quantity) return alert(translations[currentLanguage]['fillEverything']);
          if (name === 'Both') {
            pendingItem = {
              productName: productName,
              price: price,
              quantity: quantity,
              type: 'manual'
            };
            document.getElementById('ownerSelectionModal').classList.add('active');
          } else addProductToCart(productName, price, quantity, name, null);
          closeManualInputModal();
        }

        function selectOwner(owner) {
          if (!pendingItem) return;
          let key = null;

          if (pendingItem.type === 'code') {
            key = getStockKey(pendingItem.product);
            addProductToCart(pendingItem.product.name, pendingItem.product.price, pendingItem.quantity, owner, key);
          } else if (pendingItem.type === 'manual') {
            addProductToCart(pendingItem.productName, pendingItem.price, pendingItem.quantity, owner, null);
          } else if (pendingItem.type === 'grid') {
            key = pendingItem.stockKey; // Passed from addProductFromList
            addProductToCart(pendingItem.productName, pendingItem.price, pendingItem.quantity, owner, key);
          }

          if (pendingItem.type === 'code') {
            document.getElementById('productCode').value = '';
            document.getElementById('productInfo').style.display = 'none';
            currentProduct = null;
            updateProductList();
            
            // Re-focus for scanner
            setTimeout(() => document.getElementById('productCode').focus(), 100);
          }
          closeOwnerSelection();
        }

        function closeOwnerSelection() {
          document.getElementById('ownerSelectionModal').classList.remove('active');
          pendingItem = null;
        }

        function updateItemsList() {
          var container = document.getElementById('itemsContainer');
          var list = document.getElementById('itemsList');
          if (purchasedItems.length === 0) {
            container.style.display = 'none';
            document.getElementById('paymentSection').style.display = 'none';
            return;
          }
          container.style.display = 'block';
          document.getElementById('paymentSection').style.display = 'block';
          document.getElementById('itemCount').textContent = purchasedItems.length;
          var html = '';
          for (var i = 0; i < purchasedItems.length; i++) {
            var item = purchasedItems[i];
            html += '<div class="editable-item" data-id="' + item.id + '" style="border-left: 4px solid #3B82F6;">';
            html += '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">';
            html += '<div style="font-weight: bold; font-size: 16px;">' + item.product + '</div>';
            html += '<button class="btn-red" onclick="removeItem(' + i + ')" style="padding: 4px 8px; border-radius: 4px; border:none; cursor:pointer;">' + translations[currentLanguage]['remove'] + '</button>';
            html += '</div>';
            html += '<div class="editable-row">';
            html += '<div style="flex: 1;"><label style="font-size:10px;">Qty</label><input type="number" class="item-quantity" value="' + item.quantity + '" onchange="updateItemField(' + i + ', \'quantity\', parseFloat(this.value), this)"></div>';
            html += '<div style="flex: 1;"><label style="font-size:10px;">Price</label><input type="number" class="item-price" value="' + item.price + '" onchange="updateItemField(' + i + ', \'price\', parseFloat(this.value))"></div>';
            html += '<div class="item-total" style="align-self: flex-end; font-size: 18px;">R' + item.total.toFixed(2) + '</div>';
            html += '</div></div>';
          }
          list.innerHTML = html;
          updateTotalDisplay();
        }

        function updateItemField(index, field, value, element) {
          if (index >= 0 && index < purchasedItems.length) {

            // Immediate Validation for Quantity
            if (field === 'quantity' && quantityMode === 'with') {
              let item = purchasedItems[index];
              if (item.stockKey) {
                let stock = productQuantities[item.stockKey] || 0;
                if (value > stock) {
                  alert("Only " + stock + " available. Resetting.");
                  value = stock;
                  if (element) element.value = stock; // Reset input visual
                }
              }
            }

            purchasedItems[index][field] = value;
            if (field === 'quantity' || field === 'price') purchasedItems[index].total = purchasedItems[index].quantity * purchasedItems[index].price;

            // If we called from onchange, we might re-render to update Total, but keep focus if needed
            // Simple approach: re-render
            updateItemsList();
          }
        }

        function updateTotalDisplay() {
          var total = 0;
          for (var i = 0; i < purchasedItems.length; i++) {
            total += purchasedItems[i].total;
          }
          document.getElementById('totalDisplay').textContent = total.toFixed(2);
        }

        function removeItem(idx) {
          purchasedItems.splice(idx, 1);
          updateItemsList();
        }

        function openPaymentModal() {
          // Final Validation before paying
          if (quantityMode === 'with') {
            for (let item of purchasedItems) {
              if (item.stockKey) {
                let stock = productQuantities[item.stockKey] || 0;
                if (item.quantity > stock) {
                  alert("Not enough stock for " + item.product + ". Available: " + stock);
                  return;
                }
              }
            }
          }

          document.getElementById('paymentModal').classList.add('active');
          var total = 0;
          for (var i = 0; i < purchasedItems.length; i++) total += purchasedItems[i].total;
          document.getElementById('modalTotal').textContent = total.toFixed(2);
          document.getElementById('cashAmountDropdown').value = '';
          document.getElementById('cashAmount').value = '';
          document.getElementById('cardAmount').value = '';
          document.getElementById('cardAmount2').value = '';
          updatePaymentModal();
        }

        function selectCashAmount() {
          var val = document.getElementById('cashAmountDropdown').value;
          if (val) {
            document.getElementById('cashAmount').value = val;
            updatePaymentModal();
          }
        }

function updatePaymentModal() {
  var totalEl = document.getElementById('modalTotal');
  if (!totalEl) return; // Exit if modal is not open
  
  var total = parseFloat(totalEl.textContent);
  var cash = parseFloat(document.getElementById('cashAmount').value) || 0;
  var card = parseFloat(document.getElementById('cardAmount').value) || 0;
  var card2 = parseFloat(document.getElementById('cardAmount2').value) || 0;
  var paid = cash + card + card2;

  var paidTogetherEl = document.getElementById('paidTogether');
  if (paidTogetherEl) {
    paidTogetherEl.textContent = paid.toFixed(2);
  }

  var changeDisplayEl = document.getElementById('changeDisplay');
  var insufficientDisplayEl = document.getElementById('insufficientDisplay');
  var completeBtn = document.getElementById('completeBtn');

  if (paid >= total) {
    var changeEl = document.getElementById('change');
    if (changeEl) {
      changeEl.textContent = (paid - total).toFixed(2);
    }
    if (changeDisplayEl) {
      changeDisplayEl.style.display = 'block';
    }
    if (insufficientDisplayEl) {
      insufficientDisplayEl.style.display = 'none';
    }
    if (completeBtn) {
      completeBtn.disabled = false;
    }
  } else {
    var stillNeededEl = document.getElementById('stillNeeded');
    if (stillNeededEl) {
      stillNeededEl.textContent = (total - paid).toFixed(2);
    }
    if (changeDisplayEl) {
      changeDisplayEl.style.display = 'none';
    }
    if (insufficientDisplayEl) {
      insufficientDisplayEl.style.display = 'block';
    }
    if (completeBtn) {
      completeBtn.disabled = true;
    }
  }
}

function completeTransaction() {
    var name = document.getElementById('name').value;
    var date = document.getElementById('date').value;
    var time = document.getElementById('time').value;
    var cashReceived = parseFloat(document.getElementById('cashAmount').value) || 0;
    var cardReceived = parseFloat(document.getElementById('cardAmount').value) || 0;
    var cardReceived2 = parseFloat(document.getElementById('cardAmount2').value) || 0;
    var total = 0;
    
    for (var i = 0; i < purchasedItems.length; i++) {
        total += purchasedItems[i].total;
    }

    // DEDUCT STOCK
    if (quantityMode === 'with') {
        purchasedItems.forEach(item => {
            if (item.stockKey && productQuantities[item.stockKey] !== undefined) {
                productQuantities[item.stockKey] -= item.quantity;
                if (productQuantities[item.stockKey] < 0) productQuantities[item.stockKey] = 0;
            }
        });
        saveQuantityData();
    }

    var totalCardReceived = cardReceived + cardReceived2;
    var paymentMethod = (cashReceived > 0 && totalCardReceived > 0) ? 'Mixed (Cash + Card)' : 
                        (cashReceived > 0 ? 'Cash' : (totalCardReceived > 0 ? 'Card' : 'Unknown'));

    var cashAmount = 0, cardAmount = 0, cardAmount2 = 0;
    
    if (cashReceived > 0 && totalCardReceived > 0) {
        var totalReceived = cashReceived + totalCardReceived;
        cashAmount = total * (cashReceived / totalReceived);
        cardAmount = total * (totalCardReceived / totalReceived) * (cardReceived / totalCardReceived);
        cardAmount2 = total * (totalCardReceived / totalReceived) * (cardReceived2 / totalCardReceived);
    } else if (cashReceived > 0) {
        cashAmount = total;
    } else if (totalCardReceived > 0) {
        cardAmount = total * (cardReceived / totalCardReceived);
        cardAmount2 = total * (cardReceived2 / totalCardReceived);
    }

    var changeAmount = (cashReceived + totalCardReceived) - total;
    
    // Create copies of denomination objects
    var cashReceivedDenoms = JSON.parse(JSON.stringify(cashReceivedDenominations));
    var changeGivenDenoms = JSON.parse(JSON.stringify(changeGivenDenominations));

    // CRITICAL: Update till with this transaction
    if (cashReceived > 0) {
        processCashTransaction(cashReceivedDenoms, changeGivenDenoms);
    }

    var transaction = {
        date: date,
        time: time,
        name: name,
        items: purchasedItems.slice(),
        totalAmount: total,
        cashAmount: cashAmount,
        cardAmount: cardAmount,
        cardAmount2: cardAmount2,
        cashReceived: cashReceived,
        cardReceived: cardReceived,
        cardReceived2: cardReceived2,
        change: changeAmount,
        transactionNumber: currentTransactionNumber.toString().padStart(6, '0'),
        paymentMethod: paymentMethod,
        cashReceivedDenominations: cashReceivedDenoms,
        changeGivenDenominations: changeGivenDenoms
    };
    
    allTransactions.push(transaction);
    saveData();
    
    // Close modal first
    document.getElementById('paymentModal').classList.remove('active');
    
    setTimeout(function() {
        alert(translations[currentLanguage]['transactionComplete'] + '\n' + 
              translations[currentLanguage]['transactionNo'] + ': ' + transaction.transactionNumber + '\n' + 
              translations[currentLanguage]['change'] + ': R' + transaction.change.toFixed(2));

        // Reset for next transaction
        currentTransactionNumber++;
        saveTransactionNumber();
        updateTransactionNumberDisplay();
        
        purchasedItems = [];
        
        document.getElementById('name').value = '';
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        document.getElementById('time').value = new Date().toTimeString().slice(0, 5);
        document.getElementById('cashAmount').value = '';
        document.getElementById('cardAmount').value = '';
        document.getElementById('cardAmount2').value = '';
        document.getElementById('productCode').value = '';
        document.getElementById('productInfo').style.display = 'none';
        document.getElementById('salesSearch').value = '';
        
        currentProduct = null;
        currentQuantity = 1;
        salesSearchTerm = '';
        salesCurrentPage = 1;
        
        // Reset denomination tracking
        Object.keys(cashReceivedDenominations).forEach(key => {
            cashReceivedDenominations[key].count = 0;
        });
        Object.keys(changeGivenDenominations).forEach(key => {
            changeGivenDenominations[key].count = 0;
        });
        
        updateItemsList();
        updateStats();
        updateProductList();
        
        document.getElementById('itemsContainer').style.display = 'none';
        document.getElementById('paymentSection').style.display = 'none';
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        setTimeout(() => {
            document.getElementById('productCode').focus();
        }, 200);
    }, 100);
}



// Helper function to calculate net cash added to till
function calculateNetCashToTill(cashReceivedDenoms, changeGivenDenoms) {
    var netCash = {};
    var allDenoms = ['R200', 'R100', 'R50', 'R20', 'R10', 'R5', 'R2', 'R1', '50c', '20c', '10c'];
    
    allDenoms.forEach(denom => {
        var received = cashReceivedDenoms[denom].count || 0;
        var given = changeGivenDenoms[denom].count || 0;
        netCash[denom] = received - given;
    });
    
    return netCash;
}

        function closePaymentModal() {
          document.getElementById('paymentModal').classList.remove('active');
        }

        // Product Management
        function loadCategories() {
          var c = localStorage.getItem('salesSystemCategories');
          if (c) allCategories = JSON.parse(c);
          updateCategorySelects();
        }

        function saveCategories() {
          localStorage.setItem('salesSystemCategories', JSON.stringify(allCategories));
        }

function updateCategorySelects() {
    var sel = document.getElementById('filterCategory');
    while (sel.options.length > 1) sel.remove(1);
    
    allCategories.forEach(c => {
        var o = document.createElement('option');
        o.value = c;
        o.textContent = c;
        sel.appendChild(o);
    });
}  

function showCategorySuggestions() {
    var val = document.getElementById("newCategory").value.toUpperCase();
    var list = document.getElementById("categoryAutocompleteList");
    list.innerHTML = '';
    if (!val) return;
    
    allCategories.forEach(c => {
        if (c.toUpperCase().includes(val)) {
            var div = document.createElement("div");
            div.innerHTML = "<strong>" + c.substr(0, val.length) + "</strong>" + c.substr(val.length);
            div.innerHTML += "<input type='hidden' value='" + c + "'>";
            div.addEventListener("click", function () {
                document.getElementById("newCategory").value = this.getElementsByTagName("input")[0].value;
                list.innerHTML = '';
            });
            list.appendChild(div);
        }
    });
    
    if (list.innerHTML === '') {
        var div = document.createElement("div");
        div.innerHTML = "Click to add '" + val + "'";
        div.addEventListener("click", function () {
            document.getElementById("newCategory").value = val;
            list.innerHTML = '';
        });
        list.appendChild(div);
    }
}















// ========== CORE ENHANCED FUNCTIONS ==========

async function exportData(type) {
  try {
    const now = new Date();
    let data, filename;
    
    switch (type) {
      case 'complete':
        data = {
          exportType: 'complete_backup',
          timestamp: now.toISOString(),
          products: allProducts,
          categories: allCategories,
          transactions: allTransactions,
          quantities: productQuantities,
          transactionNumber: currentTransactionNumber,
          floatAmount: floatAmount,
          floatDenominations: floatDenominations,
          reconciliations: dailyReconciliations,
          version: '2.0'
        };
        filename = `sales_backup_${now.toISOString().split('T')[0]}.json`;
        break;
        
      case 'products':
        data = {
          exportType: 'products',
          timestamp: now.toISOString(),
          products: allProducts,
          categories: allCategories,
          quantities: productQuantities,
          floatAmount: floatAmount,
          floatDenominations: floatDenominations
        };
        filename = `products_with_float_${now.toISOString().split('T')[0]}.json`;
        break;
        
      case 'sales':
        data = {
          exportType: 'sales',
          timestamp: now.toISOString(),
          transactions: allTransactions,
          transactionNumber: currentTransactionNumber,
          reconciliations: dailyReconciliations
        };
        filename = `sales_only_${now.toISOString().split('T')[0]}.json`;
        break;
    }
    
    // Create and download the file
    const jsonStr = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    return true;
    
  } catch (error) {
    console.error('Error exporting data:', error);
    alert('Error exporting data: ' + error.message);
    return false;
  }
}

function downloadFile(data, filename) {
  const jsonStr = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function importData(type) {
  try {
    // Trigger the appropriate file input based on type
    switch (type) {
      case 'complete':
        document.getElementById('completeBackupInput').click();
        break;
      case 'products':
        document.getElementById('productsOnlyInput').click();
        break;
      case 'sales':
        document.getElementById('salesOnlyInput').click();
        break;
    }
  } catch (error) {
    console.error('Error importing data:', error);
    alert('Error importing data: ' + error.message);
  }
}

        function showCategoryDropdown() {
          var val = document.getElementById("newProductCategory").value.toUpperCase();
          var list = document.getElementById("categoryAutocompleteList");
          list.innerHTML = '';
          allCategories.forEach(c => {
            if (!val || c.toUpperCase().includes(val)) {
              var div = document.createElement("div");
              div.innerHTML = c;
              div.innerHTML += "<input type='hidden' value='" + c + "'>";
              div.addEventListener("click", function () {
                document.getElementById("newProductCategory").value = this.getElementsByTagName("input")[0].value;
                list.innerHTML = '';
              });
              list.appendChild(div);
            }
          });
    
		
document.addEventListener('click', function (e) {
    // Only close if not clicking on any category input or autocomplete item
    if (e.target.id !== 'newCategory' && 
        e.target.id !== 'newProductCategory' && 
        e.target.id !== 'quickItemCategory' &&
        !e.target.closest('.autocomplete-items')) {
        
        var lists = [
            'categoryAutocompleteList',
            'productCategoryAutocompleteList',
            'quickCategoryAutocompleteList'
        ];
        
        lists.forEach(id => {
            var list = document.getElementById(id);
            if (list) list.innerHTML = '';
        });
    }
});
   }
        function addCategory() {
          var c = document.getElementById('newCategory').value.trim();
          if (!c) return alert(translations[currentLanguage]['pleaseEnterCategory']);
          if (allCategories.includes(c)) return alert(translations[currentLanguage]['categoryExists']);
          allCategories.push(c);
          saveCategories();
          updateCategorySelects();
          document.getElementById('newCategory').value = '';
          alert(translations[currentLanguage]['categoryAdded'] + c);
        }

        function saveProduct() {
          var code = document.getElementById('newProductCode').value.trim();
          var name = document.getElementById('newProductName').value;
          var price = parseFloat(document.getElementById('newProductPrice').value);
          var owner = document.getElementById('newProductOwner').value;
          var category = document.getElementById('newProductCategory').value;
          var qty = parseInt(document.getElementById('newProductQuantity').value) || 0;
          if (!owner) return alert(translations[currentLanguage]['pleaseSelectOwner']);
          if (!name || !price) return alert(translations[currentLanguage]['fillNamePrice']);
          if (!category) return alert(translations[currentLanguage]['pleaseChooseCategory']);
          if (!code) code = null;
          if (code && editingProductIndex === -1 && findProductByCode(code)) return alert(translations[currentLanguage]['codeExists']);

          if (editingProductIndex === -1) {
            var p = {
              id: Date.now(),
              code: code,
              name: name,
              price: price,
              owner: owner,
              category: category,
              quantity: qty
            };
            allProducts.push(p);
            if (qty > 0) {
              productQuantities[getStockKey(p)] = qty;
              saveQuantityData();
            }
          } else {
            var p = allProducts[editingProductIndex];
            p.code = code;
            p.name = name;
            p.price = price;
            p.owner = owner;
            p.category = category;
            p.quantity = qty;
            if (qty > 0) {
              productQuantities[getStockKey(p)] = qty;
              saveQuantityData();
            }
            cancelEdit();
          }
          saveProducts();
          filterProducts();
          renderProductsTable();
          document.getElementById('newProductCode').value = '';
          document.getElementById('newProductName').value = '';
          document.getElementById('newProductPrice').value = '';
          document.getElementById('newProductCategory').value = '';
          document.getElementById('newProductOwner').value = '';
          document.getElementById('newProductQuantity').value = '';
        }

        function editProduct(idx) {
          // Changed idx to be the absolute index within the filtered list
          var p = filteredProducts[idx];
          editingProductIndex = allProducts.findIndex(x => x.id === p.id);
          document.getElementById('newProductCode').value = p.code || '';
          document.getElementById('newProductName').value = p.name;
          document.getElementById('newProductPrice').value = p.price;
          document.getElementById('newProductOwner').value = p.owner;
          document.getElementById('newProductCategory').value = p.category || '';
          document.getElementById('newProductQuantity').value = p.quantity || '';
          document.getElementById('formTitle').textContent = translations[currentLanguage]['editProduct'];
          document.getElementById('saveProductBtn').textContent = translations[currentLanguage]['updateProduct'];
          document.getElementById('cancelEditBtn').style.display = 'block';
          document.getElementById('newProductCode').scrollIntoView({
            behavior: 'smooth'
          });
        }

        function cancelEdit() {
          editingProductIndex = -1;
          document.getElementById('formTitle').textContent = translations[currentLanguage]['newProduct'];
          document.getElementById('saveProductBtn').textContent = translations[currentLanguage]['saveProduct'];
          document.getElementById('cancelEditBtn').style.display = 'none';
          document.getElementById('newProductCode').value = '';
          document.getElementById('newProductName').value = '';
          document.getElementById('newProductPrice').value = '';
          document.getElementById('newProductCategory').value = '';
          document.getElementById('newProductOwner').value = '';
          document.getElementById('newProductQuantity').value = '';
        }

        function deleteProduct(idx) {
          if (confirm(translations[currentLanguage]['confirmDelete'])) {
            var p = allProducts[idx];
            var key = getStockKey(p);
            if (productQuantities[key]) {
              delete productQuantities[key];
              saveQuantityData();
            }
            allProducts.splice(idx, 1);
            saveProducts();
            filterProducts();
            renderProductsTable();
          }
        }

function filterProducts() {
    var term = document.getElementById('searchProducts').value.toLowerCase();
    var cat = document.getElementById('filterCategory').value;
    var own = document.getElementById('filterOwner').value;
    
    filteredProducts = allProducts.filter(p => {
        var m1 = term === '' || p.name.toLowerCase().includes(term) || (p.code && p.code.toLowerCase().includes(term));
        var m2 = cat === '' || p.category === cat;
        var m3 = own === '' || p.owner === own;
        return m1 && m2 && m3;
    });
    
    currentPage = 1;
    renderProductsTable();
}

        function renderProductsTable() {
          var tbody = document.getElementById('productsTableBody');
          var start = (currentPage - 1) * itemsPerPage;
          var end = start + itemsPerPage;
          var pageData = filteredProducts.slice(start, end);
          if (pageData.length === 0) tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">' + translations[currentLanguage]['noProductsFound'] + '</td></tr>';
          else {
            var html = '';
            pageData.forEach((p, i) => {
              // FIXED: Calculating the absolute index (start + i) for the editProduct function
              var absoluteIndex = start + i;
              html += '<tr><td>' + (p.code || '-') + '</td><td>' + p.name + '</td><td>R' + p.price.toFixed(2) + '</td><td>' + p.owner + '</td><td>' + (p.category || 'None') + '</td><td>' + (productQuantities[getStockKey(p)] || 0) + '</td><td><div class="action-buttons"><button class="action-btn edit-btn" onclick="editProduct(' + absoluteIndex + ')">' + translations[currentLanguage]['edit'] + '</button><button class="action-btn delete-btn" onclick="deleteProduct(' + allProducts.findIndex(x => x.id === p.id) + ')">' + translations[currentLanguage]['delete'] + '</button></div></td></tr>';
            });
            tbody.innerHTML = html;
          }
          var totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
          document.getElementById('pageInfo').textContent = translations[currentLanguage]['page'] + ' ' + currentPage + ' ' + translations[currentLanguage]['of'] + ' ' + totalPages;
          document.getElementById('prevPageBtn').disabled = currentPage === 1;
          document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        function changePage(dir) {
          currentPage += dir;
          renderProductsTable();
        }

        function filterSalesProducts() {
          salesSearchTerm = document.getElementById('salesSearch').value.toLowerCase();
          salesCurrentPage = 1;
          updateProductList();
        }

        function changeSalesPage(dir) {
          salesCurrentPage += dir;
          updateProductList();
        }

        function updateProductList(specificProduct) {
          var name = document.getElementById('name').value;
          var list = document.getElementById('productList');
          if (!name) {
            list.innerHTML = '<div class="empty-state"><h3>' + translations[currentLanguage]['selectName'] + '</h3><p>' + translations[currentLanguage]['selectNameFirst'] + '</p></div>';
            updateSalesPagination(0);
            return;
          }
          if (allProducts.length === 0) {
            list.innerHTML = '<div class="empty-state"><h3>' + translations[currentLanguage]['noProducts'] + '</h3><p>' + translations[currentLanguage]['addProductsImport'] + '</p></div>';
            updateSalesPagination(0);
            return;
          }

          var fp = [];
          if (specificProduct) fp = [specificProduct];
          else fp = allProducts.filter(p => (p.owner === name || p.owner === 'Both' || name === 'Both') && (salesSearchTerm === '' || p.name.toLowerCase().includes(salesSearchTerm) || (p.code && p.code.toLowerCase().includes(salesSearchTerm))));

          var start = (salesCurrentPage - 1) * salesItemsPerPage;
          var end = start + salesItemsPerPage;
          var pageData = fp.slice(start, end);
          var totalPages = Math.ceil(fp.length / salesItemsPerPage);

          if (pageData.length === 0) list.innerHTML = '<div class="empty-state"><h3>' + translations[currentLanguage]['noProductsFound'] + '</h3><p>' + translations[currentLanguage]['tryDifferentSearch'] + '</p></div>';
          else {
            var html = '';
            pageData.forEach(p => {
              var avail = quantityMode === 'none' || isProductAvailable(p);
              var escapedName = p.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
              var escapedCode = p.code ? p.code.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
              html += '<div class="product-card" ' + (avail ? 'onclick="addProductFromList(\'' + escapedName + '\', ' + p.price + ', \'' + escapedCode + '\')"' : 'style="opacity: 0.6;"') + '>';
              html += '<div class="product-name">' + p.name + '</div><div class="product-price">R' + p.price.toFixed(2) + '</div>';

              if (quantityMode === 'with') {
                var stockCount = getAvailableQuantity(p);
                html += '<div style="background:#E5E7EB; color:#374151; padding:4px; border-radius:4px; margin:4px 0; font-weight:bold; font-size:12px;">Available: ' + stockCount + '</div>';
              }

              html += '<div class="product-person">' + p.owner + '</div>';
              if (p.code) html += '<div class="product-code">' + translations[currentLanguage]['code'] + ': ' + p.code + '</div>';
              html += '</div>';
            });
            list.innerHTML = html;
          }
          updateSalesPagination(totalPages);
        }

        function updateSalesPagination(tp) {
          document.getElementById('salesPageInfo').textContent = translations[currentLanguage]['page'] + ' ' + salesCurrentPage + ' ' + translations[currentLanguage]['of'] + ' ' + tp;
          document.getElementById('salesPrevBtn').disabled = salesCurrentPage === 1;
          document.getElementById('salesNextBtn').disabled = salesCurrentPage === tp || tp === 0;
        }

        function addProductFromList(name, price, code) {
          var selectedName = document.getElementById('name').value;
          if (!selectedName) return alert(translations[currentLanguage]['pleaseSelectName']);
          var qtyToAdd = 1;

          if (quantityMode === 'with') {
            var p = allProducts.find(x => (code && x.code === code) || x.name === name);
            var inputQty = parseInt(document.getElementById('sellQuantity').value) || 1;
            qtyToAdd = inputQty;

            if (p) {
              var currentStock = getAvailableQuantity(p);
              if (currentStock === 0) return alert(translations[currentLanguage]['noItemAvailable'] + p.name + translations[currentLanguage]['noItemAvailableEnd']);
              if (currentStock < qtyToAdd) {
                alert("Not enough stock. Available: " + currentStock);
                return;
              }
            }
          }

          if (selectedName === 'Both') {
            // Use the getStockKey helper to ensure we pass correct stock key for validation
            var p = allProducts.find(x => (code && x.code === code) || x.name === name);
            var key = p ? getStockKey(p) : null;

            pendingItem = {
              productName: name,
              price: price,
              quantity: qtyToAdd,
              type: 'grid',
              stockKey: key
            };
            document.getElementById('ownerSelectionModal').classList.add('active');
            return;
          }

          var p = allProducts.find(x => (code && x.code === code) || x.name === name);
          var key = p ? getStockKey(p) : null;
          addProductToCart(name, price, qtyToAdd, selectedName, key);
        }

        function findProductByCode(code) {
          return allProducts.find(p => p.code === code);
        }

function updateStats() {
  var total = allTransactions.reduce((acc, t) => acc + t.totalAmount, 0);
  var salesEl = document.getElementById('totalSales');
  var txEl = document.getElementById('totalTransactions');

  if (salesEl) salesEl.textContent = 'R' + total.toFixed(2);
  if (txEl) txEl.textContent = allTransactions.length;
}

function safeSetText(id, text) {
  var el = document.getElementById(id);
  if (el) el.textContent = text;
}

async function importCompleteBackup() {
  await importData('complete');
}

async function handleCompleteBackupUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
        await handleBackupFile(file);
    } catch (error) {
        alert(translations[currentLanguage]['errorReadingBackup'] + error.message);
    } finally {
        e.target.value = '';
    }
}

async function handleBackupFile(file) {
    const text = await file.text();
    const data = JSON.parse(text);
    
    if (!data.exportType) {
        throw new Error(translations[currentLanguage]['invalidBackup']);
    }
    
    if (!confirm(translations[currentLanguage]['currentDataReplaced'])) {
        return;
    }
    
    // Validate and restore data
    if (data.exportType === 'complete_backup') {
        allProducts = data.products || [];
        allCategories = data.categories || allCategories;
        allTransactions = data.transactions || [];
        productQuantities = data.quantities || {};
        currentTransactionNumber = data.transactionNumber || 1;
        floatAmount = data.floatAmount || 700.00;
        floatDenominations = data.floatDenominations || floatDenominations;
        dailyReconciliations = data.reconciliations || [];
        
        // Save to localStorage
        saveData();
        saveProducts();
        saveCategories();
        saveQuantityData();
        saveFloatData();
        saveReconciliations();
        saveTransactionNumber();
        
        // Update UI
        filteredProducts = [...allProducts];
        renderProductsTable();
        updateStats();
        updateReportHistoryDropdown();
        renderReconciliationHistory();
        updateProductList();
        
        alert(translations[currentLanguage]['backupRestored']);
    } else if (data.exportType === 'products') {
        // Restore products and float only
        allProducts = data.products || [];
        allCategories = data.categories || allCategories;
        productQuantities = data.quantities || {};
        floatAmount = data.floatAmount || 700.00;
        floatDenominations = data.floatDenominations || floatDenominations;
        
        saveProducts();
        saveCategories();
        saveQuantityData();
        saveFloatData();
        
        filteredProducts = [...allProducts];
        renderProductsTable();
        updateProductList();
        renderFloatBreakdown();
        
        alert(translations[currentLanguage]['productsUploaded']);
    } else if (data.exportType === 'sales') {
        // Restore sales only
        allTransactions = data.transactions || [];
        currentTransactionNumber = data.transactionNumber || 1;
        dailyReconciliations = data.reconciliations || [];
        
        saveData();
        saveReconciliations();
        saveTransactionNumber();
        
        updateStats();
        updateReportHistoryDropdown();
        renderReconciliationHistory();
        
        alert(translations[currentLanguage]['salesUploaded']);
    }
}



// Scanner Help Modal Functions
function openScannerHelp() {
    document.getElementById('scannerHelpModal').classList.add('active');
}

function closeScannerHelp() {
    document.getElementById('scannerHelpModal').classList.remove('active');
}

// Auto-save function
function startAutoSave() {
    // Auto-save every 30 seconds
    setInterval(() => {
        saveData();
        saveProducts();
        saveCategories();
        saveQuantityData();
        saveFloatData();
        saveReconciliations();
        saveTransactionNumber();
        
        // Create compressed backup
        if (typeof LZString !== 'undefined') {
            const consolidatedData = {
                exportType: 'complete_backup',
                timestamp: new Date().toISOString(),
                products: allProducts,
                categories: allCategories,
                transactions: allTransactions,
                quantities: productQuantities,
                transactionNumber: currentTransactionNumber,
                floatAmount: floatAmount,
                floatDenominations: floatDenominations,
                reconciliations: dailyReconciliations
            };
            const compressedData = LZString.compressToUTF16(JSON.stringify(consolidatedData));
            localStorage.setItem('salesSystemCompressedBackup', compressedData);
        }
    }, 30000);
}

// IndexedDB fallback (placeholder)
async function loadFromIndexedDB() {
    return new Promise((resolve) => {
        if (!window.indexedDB) {
            resolve(false);
            return;
        }
        
        const request = indexedDB.open('SalesSystemDB', 1);
        
        request.onerror = () => resolve(false);
        
        request.onsuccess = (event) => {
            const db = event.target.result;
            const transaction = db.transaction(['sales'], 'readonly');
            const store = transaction.objectStore('sales');
            const getAllRequest = store.getAll();
            
            getAllRequest.onsuccess = () => {
                if (getAllRequest.result.length > 0) {
                    allTransactions = getAllRequest.result;
                    resolve(true);
                } else {
                    resolve(false);
                }
            };
            
            getAllRequest.onerror = () => resolve(false);
        };
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            db.createObjectStore('sales', { keyPath: 'id' });
        };
    });
}

// PDF generation function
function generatePDF(specificDate = null) {
  try {
    if (typeof window.jspdf === 'undefined') return alert(translations[currentLanguage]['pdfLibraryError']);
    const {
      jsPDF
    } = window.jspdf;
    
    // Allow passing a date, or default to input
    var day = specificDate || document.getElementById('daySelect').value;
    
    var dayTransactions = allTransactions.filter(t => t.date === day);
    if (dayTransactions.length === 0) return alert(translations[currentLanguage]['noTransactionsDay']);

    const doc = new jsPDF();
    
    // Use current language for PDF content
    const isAfrikaans = currentLanguage === 'af';
    
    // Translations for PDF content
    const pdfTranslations = {
      en: {
        dailyReport: 'DAILY REPORT',
        date: 'Date',
        detailedTransactions: 'DETAILED TRANSACTIONS',
        transactionNumber: 'Tr #',
        person: 'Person',
        item: 'Item',
        quantity: 'Qty',
        price: 'Price',
        total: 'Total',
        payment: 'Payment',
        summary: 'SUMMARY',
        name: 'Name',
        transactions: 'Trans',
        cash: 'Cash',
        card: 'Card',
        dayTotal: 'TOTAL',
        cashReconciliation: 'CASH RECONCILIATION',
        cashSales: 'Cash Sales',
        startingFloat: 'Starting Float',
        totalInTill: 'Total in Till',
        floatToKeep: 'Float to Keep',
        cashToBank: 'CASH TO BANK',
        page: 'Page',
        of: 'of'
      },
      af: {
        dailyReport: 'DAAGLIKSE VERSLAG',
        date: 'Datum',
        detailedTransactions: 'GEDETAILLEERDE TRANSAKSIES',
        transactionNumber: 'Tr #',
        person: 'Persoon',
        item: 'Item',
        quantity: 'Hoev',
        price: 'Prys',
        total: 'Totaal',
        payment: 'Betaling',
        summary: 'OPSOMMING',
        name: 'Naam',
        transactions: 'Trans',
        cash: 'Kontant',
        card: 'Kaart',
        dayTotal: 'TOTAAL',
        cashReconciliation: 'KONTANT VERSOENING',
        cashSales: 'Kontant Verkope',
        startingFloat: 'Begin Float',
        totalInTill: 'Totaal in Kas',
        floatToKeep: 'Float om te Hou',
        cashToBank: 'KONTANT OM TE BANK',
        page: 'Bladsy',
        of: 'van'
      }
    };
    
    const t = pdfTranslations[currentLanguage];
    
    doc.setFontSize(20);
    doc.setTextColor(40, 40, 40);
    doc.text(t.dailyReport, 105, 20, {
      align: 'center'
    });
    doc.setFontSize(12);
    doc.setTextColor(100, 100, 100);
    doc.text(t.date + ': ' + day, 105, 30, {
      align: 'center'
    });

    let yPosition = 50;
    doc.setFontSize(16);
    doc.setTextColor(59, 130, 246);
    doc.text(t.detailedTransactions, 105, yPosition, {
      align: 'center'
    });
    yPosition += 10;

    const tableData = [
      [t.transactionNumber, t.person, t.item, t.quantity, t.price, t.total, t.payment]
    ];
    dayTransactions.forEach(tran => {
      var trNumber = tran.transactionNumber.toString().slice(-3);
      var paymentMethod = '';
      if (tran.cashAmount > 0 && (tran.cardAmount > 0 || tran.cardAmount2 > 0)) paymentMethod = isAfrikaans ? 'Gemeng' : 'Mixed';
      else if (tran.cashAmount > 0) paymentMethod = isAfrikaans ? 'KONTANT' : 'CASH';
      else if (tran.cardAmount > 0 || tran.cardAmount2 > 0) paymentMethod = (tran.cardAmount2 > 0) ? (isAfrikaans ? '2xKD' : '2xCD') : (isAfrikaans ? 'KAART' : 'CARD');

      tran.items.forEach(item => {
        var itemOwner = item.owner || tran.name;
        var personAbbr = itemOwner === 'Kotie' ? 'KO' : (itemOwner === 'Francois' ? 'FR' : 'BT');
        tableData.push([
          trNumber, 
          personAbbr, 
          item.product, // Full name
          item.quantity.toString(), 
          'R' + item.price.toFixed(2), 
          'R' + item.total.toFixed(2), 
          paymentMethod
        ]);
      });
    });

    // Optimize column widths for portrait
    doc.autoTable({
      startY: yPosition,
      head: [tableData[0]],
      body: tableData.slice(1),
      theme: 'grid',
      headStyles: {
        fillColor: [59, 130, 246],
        textColor: [255, 255, 255],
        fontStyle: 'bold'
      },
      styles: {
        fontSize: 8,
        cellPadding: 2,
        overflow: 'linebreak',
        cellWidth: 'wrap'
      },
      columnStyles: {
        0: { // Tr #
          cellWidth: 12,
          halign: 'center',
          fontSize: 7
        },
        1: { // Person
          cellWidth: 15,
          halign: 'center',
          fontSize: 7
        },
        2: { // Item
          cellWidth: 'auto',
          minCellWidth: 80,
          maxCellWidth: 95,
          overflow: 'linebreak',
          fontSize: 7
        },
        3: { // Qty
          cellWidth: 12,
          halign: 'center',
          fontSize: 7
        },
        4: { // Price
          cellWidth: 18,
          halign: 'right',
          fontSize: 7
        },
        5: { // Total
          cellWidth: 18,
          halign: 'right',
          fontSize: 7
        },
        6: { // Payment
          cellWidth: 18,
          halign: 'center',
          fontSize: 7
        }
      },
      margin: { horizontal: 5 },
      tableWidth: 'wrap',
      didParseCell: function (data) {
        if (data.row.index > 0) {
          var owner = data.row.raw[1];
          if (owner === 'KO') data.cell.styles.fillColor = [225, 245, 254];
          else if (owner === 'FR') data.cell.styles.fillColor = [232, 245, 233];
        }
        if (data.column.index === 2 && data.cell.raw.length > 30) {
          data.cell.styles.fontSize = 6;
        }
      },
      willDrawCell: function (data) {
        if (data.column.index === 2 && data.cell.raw) {
          var text = data.cell.raw;
          if (text.length > 40) {
            var lines = doc.splitTextToSize(text, 85);
            data.cell.text = lines;
            data.row.height = 4 * lines.length;
          }
        }
      }
    });

    yPosition = doc.lastAutoTable.finalY + 15;
    doc.setFontSize(14);
    doc.setTextColor(59, 130, 246);
    doc.text(t.summary, 105, yPosition, {
      align: 'center'
    });
    yPosition += 8;

    // Calculate Summary
    var kc = 0,
      kca = 0,
      kcd = 0,
      kt = 0;
    var fc = 0,
      fca = 0,
      fcd = 0,
      ft = 0;
    dayTransactions.forEach(tran => {
      if (tran.name === 'Both') {
        var ki = 0,
          fi = 0;
        tran.items.forEach(i => {
          if (i.owner === 'Kotie') ki += i.total;
          else fi += i.total;
        });
        var kp = tran.totalAmount > 0 ? ki / tran.totalAmount : 0;
        var fp = tran.totalAmount > 0 ? fi / tran.totalAmount : 0;
        kca += tran.cashAmount * kp;
        kcd += (tran.cardAmount + (tran.cardAmount2 || 0)) * kp;
        kt += ki;
        fca += tran.cashAmount * fp;
        fcd += (tran.cardAmount + (tran.cardAmount2 || 0)) * fp;
        ft += fi;
        if (ki > 0) kc++;
        if (fi > 0) fc++;
      } else {
        var amt = tran.totalAmount;
        var ca = tran.cashAmount;
        var cd = tran.cardAmount + (tran.cardAmount2 || 0);
        if (tran.name === 'Kotie') {
          kca += ca;
          kcd += cd;
          kt += amt;
          kc++;
        } else {
          fca += ca;
          fcd += cd;
          ft += amt;
          fc++;
        }
      }
    });

    const summaryData = [
      [t.name, t.transactions, t.cash, t.card, t.total],
      ['Kotie', kc.toString(), 'R' + kca.toFixed(2), 'R' + kcd.toFixed(2), 'R' + kt.toFixed(2)],
      ['Francois', fc.toString(), 'R' + fca.toFixed(2), 'R' + fcd.toFixed(2), 'R' + ft.toFixed(2)],
      [t.dayTotal, dayTransactions.length.toString(), 'R' + (kca + fca).toFixed(2), 'R' + (kcd + fcd).toFixed(2), 'R' + (kt + ft).toFixed(2)]
    ];

    // FIXED: Create a separate table for the TOTAL row to ensure perfect alignment
    // First, draw the main table (Kotie and Francois rows)
    doc.autoTable({
      startY: yPosition,
      head: [summaryData[0]],
      body: summaryData.slice(1, 3),
      theme: 'grid',
      headStyles: {
        fillColor: [59, 130, 246],
        textColor: [255, 255, 255],
        fontStyle: 'bold',
        fontSize: 8,
        halign: 'center'
      },
      styles: {
        fontSize: 8,
        cellPadding: 2,
        overflow: 'linebreak',
        lineColor: [200, 200, 200],
        lineWidth: 0.1
      },
      columnStyles: {
        0: { // Name
          cellWidth: 40,
          fontStyle: 'bold',
          halign: 'left'
        },
        1: { // Transactions
          cellWidth: 25,
          halign: 'center'
        },
        2: { // Cash
          cellWidth: 30,
          halign: 'right'
        },
        3: { // Card
          cellWidth: 30,
          halign: 'right'
        },
        4: { // Total
          cellWidth: 30,
          halign: 'right'
        }
      },
      didParseCell: function (data) {
        if (data.row.index === 1) { // Kotie row
          data.cell.styles.fillColor = [225, 245, 254]; // Light blue
        } else if (data.row.index === 2) { // Francois row
          data.cell.styles.fillColor = [232, 245, 233]; // Light green
        }
      }
    });

    yPosition = doc.lastAutoTable.finalY;

    // Now draw the TOTAL row separately with exact same column widths
    doc.autoTable({
      startY: yPosition,
      head: [], // No header for this table
      body: [summaryData[3]],
      theme: 'grid',
      styles: {
        fontSize: 8,
        cellPadding: 2,
        fontStyle: 'bold',
        lineColor: [200, 200, 200],
        lineWidth: 0.1
      },
      headStyles: {
        fillColor: [30, 64, 175], // Dark blue
        textColor: [255, 255, 255], // White text
        fontStyle: 'bold'
      },
      bodyStyles: {
        fillColor: [30, 64, 175], // Dark blue for total row
        textColor: [255, 255, 255] // White text
      },
      columnStyles: {
        0: { // Name
          cellWidth: 40,
          fontStyle: 'bold',
          halign: 'left'
        },
        1: { // Transactions
          cellWidth: 25,
          halign: 'center'
        },
        2: { // Cash
          cellWidth: 30,
          halign: 'right'
        },
        3: { // Card
          cellWidth: 30,
          halign: 'right'
        },
        4: { // Total
          cellWidth: 30,
          halign: 'right'
        }
      }
    });

    // Add Cash Reconciliation Section
    yPosition = doc.lastAutoTable.finalY + 15;
    doc.setFontSize(14);
    doc.setTextColor(22, 163, 74);
    doc.text(t.cashReconciliation, 105, yPosition, {
      align: 'center'
    });
    yPosition += 8;

    var totalCash = kca + fca;
    var totalInTill = totalCash + floatAmount;
    var cashToBank = totalCash;

    // Create separate rows for better visual separation
    const cashData = [
      [t.cashSales, 'R ' + totalCash.toFixed(2)],
      [t.startingFloat, 'R ' + floatAmount.toFixed(2)],
      [t.totalInTill, 'R ' + totalInTill.toFixed(2)],
      [t.floatToKeep, 'R ' + floatAmount.toFixed(2)],
      [t.cashToBank, 'R ' + cashToBank.toFixed(2)]
    ];

    doc.autoTable({
      startY: yPosition,
      head: [[t.name, t.total]],
      body: cashData.slice(0, 3), // First 3 rows: Cash Sales, Starting Float, Total in Till
      theme: 'striped', // Use striped theme for better separation
      headStyles: {
        fillColor: [22, 163, 74],
        textColor: [255, 255, 255],
        fontStyle: 'bold',
        fontSize: 8
      },
      styles: {
        fontSize: 8,
        cellPadding: 3
      },
      columnStyles: {
        0: {
          cellWidth: 65,
          fontStyle: 'bold'
        },
        1: {
          cellWidth: 40,
          halign: 'right'
        }
      },
      didParseCell: function (data) {
        // Regular rows - white background
        if (data.row.index >= 0 && data.row.index <= 2) {
          data.cell.styles.fillColor = [255, 255, 255];
        }
      }
    });

    // First special row: Float to Keep (light yellow background)
    yPosition = doc.lastAutoTable.finalY;
    doc.autoTable({
      startY: yPosition,
      body: [[cashData[3][0], cashData[3][1]]],
      theme: 'plain',
      styles: {
        fontSize: 8,
        cellPadding: 3
      },
      columnStyles: {
        0: {
          cellWidth: 65,
          fontStyle: 'bold'
        },
        1: {
          cellWidth: 40,
          halign: 'right'
        }
      },
      didParseCell: function (data) {
        // Float to Keep row - light yellow background
        data.cell.styles.fillColor = [254, 243, 199]; // Light yellow
        data.cell.styles.textColor = [180, 93, 4]; // Dark orange text
        data.cell.styles.fontStyle = 'bold';
      }
    });

    // Second special row: CASH TO BANK (light green background)
    yPosition = doc.lastAutoTable.finalY;
    doc.autoTable({
      startY: yPosition,
      body: [[cashData[4][0], cashData[4][1]]],
      theme: 'plain',
      styles: {
        fontSize: 9, // Slightly larger for emphasis
        cellPadding: 4,
        fontStyle: 'bold'
      },
      columnStyles: {
        0: {
          cellWidth: 65,
          fontStyle: 'bold'
        },
        1: {
          cellWidth: 40,
          halign: 'right'
        }
      },
      didParseCell: function (data) {
        // CASH TO BANK row - light green background
        data.cell.styles.fillColor = [220, 252, 231]; // Light green
        data.cell.styles.textColor = [22, 163, 74]; // Green text
        data.cell.styles.fontStyle = 'bold';
        if (data.column.index === 1) {
          data.cell.styles.fontSize = 10; // Larger font for amount
        }
      }
    });

    // Add page number if needed
    const pageCount = doc.internal.getNumberOfPages();
    if (pageCount > 1) {
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(t.page + ' ' + i + ' ' + t.of + ' ' + pageCount, 200, 287, { align: 'right' });
      }
    }

    // Use language-specific filename
    const filename = isAfrikaans ? 'verslag_' + day + '.pdf' : 'report_' + day + '.pdf';
    doc.save(filename);
    
    if(!specificDate) alert(translations[currentLanguage]['pdfGenerated']);
  } catch (error) {
    console.error('PDF generation error:', error);
    alert(translations[currentLanguage]['pdfError'] + error.message);
  }
}

// Clear all data function
function clearData() {
    if (!confirm(translations[currentLanguage]['confirmClearAll'])) return;

    // Clear sales & reports
    allTransactions = [];
    purchasedItems = [];
    dailyReconciliations = [];
    currentTransactionNumber = 1;

    // IMPORTANT: Reset till back to float
    initializeTillFromFloat();

    // Persist everything
    saveData();
    saveTransactionNumber();
    saveReconciliations();
    saveTillState();

    // Update UI
    updateTransactionNumberDisplay();
    updateStats();
    updateReport();
    renderFloatBreakdown();
    renderReconciliationHistory();

    alert(translations[currentLanguage]['dataCleared']);
}


// Download functions
function downloadCompleteBackup() {
    exportData('complete');
}

function downloadProductsAsText() {
    exportData('products');
}

function downloadSalesData() {
    exportData('sales');
}

function importProductsOnly() {
    importData('products');
}

function importSalesOnly() {
    importData('sales');
}

// File upload handlers
async function handleProductsOnlyUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        if (data.exportType !== 'products') {
            throw new Error(translations[currentLanguage]['invalidProductFile']);
        }
        
        if (!confirm(translations[currentLanguage]['currentProductsReplaced'])) {
            return;
        }
        
        allProducts = data.products || [];
        allCategories = data.categories || allCategories;
        productQuantities = data.quantities || {};
        floatAmount = data.floatAmount || 700.00;
        floatDenominations = data.floatDenominations || floatDenominations;
        
        saveProducts();
        saveCategories();
        saveQuantityData();
        saveFloatData();
        
        filteredProducts = [...allProducts];
        renderProductsTable();
        updateProductList();
        renderFloatBreakdown();
        
        alert(translations[currentLanguage]['productsUploaded']);
    } catch (error) {
        alert(translations[currentLanguage]['errorReadingFile'] + error.message);
    } finally {
        e.target.value = '';
    }
}

async function handleSalesOnlyUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        if (data.exportType !== 'sales') {
            throw new Error(translations[currentLanguage]['invalidReportFile']);
        }
        
        if (!confirm(translations[currentLanguage]['currentSalesReplaced'])) {
            return;
        }
        
        allTransactions = data.transactions || [];
        currentTransactionNumber = data.transactionNumber || 1;
        dailyReconciliations = data.reconciliations || [];
        
        saveData();
        saveTransactionNumber();
        saveReconciliations();
        
        updateStats();
        updateReport();
        updateTransactionNumberDisplay();
        renderReconciliationHistory();
        
        alert(translations[currentLanguage]['salesUploaded']);
    } catch (error) {
        alert(translations[currentLanguage]['errorReadingFile'] + error.message);
    } finally {
        e.target.value = '';
    }
}

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    // Initialization code already exists above
});
</script>

<script>
window.addEventListener('load', () => {
    if (!('serviceWorker' in navigator)) return;

    const isHttp =
        location.protocol === 'http:' ||
        location.protocol === 'https:';

    if (!isHttp) {
        console.warn(
            'Service Worker disabled: must be served over http/https'
        );
        return;
    }

    navigator.serviceWorker.register('sw.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.error('SW failed:', err));
});
</script>
</body>
</html>

